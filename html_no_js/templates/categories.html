{% extends 'base.html' %}
{% block title %}Categories — Fast Todo (no-js){% endblock %}
{% block content %}
  <h2>Categories</h2>
  <form method="post" action="/html_no_js/categories/create">
    {{ csrf_field() }}
    <input name="name" placeholder="New category name" required>
    <button type="submit">Create</button>
  </form>

  <div id="categories-status" style="margin-top:0.5rem; color:#666; font-size:0.9em;"></div>
  <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
    <span>Click a category to select it:</span>
    <button id="btn-up" type="button">↑</button>
    <button id="btn-down" type="button">↓</button>
  </div>
  <div id="categories-root" style="margin-top:0.5rem;"></div>

  <div style="margin-top:0.75rem;">
  <button id="btn-delete" type="button" style="color:#900;">Delete</button>
  <button id="btn-set-default" type="button" style="margin-left:0.5rem;">Set selected as default</button>
  <button id="btn-clear-default" type="button" style="margin-left:0.5rem;">Clear default</button>
  </div>

  <script>
  (function(){
  const root = document.getElementById('categories-root');
  const statusEl = document.getElementById('categories-status');
  const btnUp = document.getElementById('btn-up');
  const btnDown = document.getElementById('btn-down');
  const btnDelete = document.getElementById('btn-delete');
  const btnSetDefault = document.getElementById('btn-set-default');
  const btnClearDefault = document.getElementById('btn-clear-default');
  let selectedId = null;
    const csrf = '{{ csrf_token }}';
  console.log('[categories] script loaded');

  async function fetchCategories(){
      try{
        const resp = await fetch('/api/categories?ts=' + Date.now(), {
          credentials: 'same-origin',
          cache: 'no-store'
        });
        if(!resp.ok) throw new Error('fetch failed');
        const data = await resp.json();
  const items = data.categories || [];
  const currentDefault = ('user_default_category_id' in data) ? data.user_default_category_id : null;
    console.log('[categories] fetched', items.map(c=>`${c.id}:${c.position}`));
  renderList(items, currentDefault);
  updateControls(items);
  if (statusEl) statusEl.textContent = `Loaded ${items.length} categories`;
      }catch(e){
    console.error('[categories] fetch failed', e);
        root.innerHTML = '<p>Failed to load categories.</p>';
      }
    }

  function renderList(items, currentDefault){
      if(!items || items.length === 0){
        root.innerHTML = '<p>No categories.</p>';
        return;
      }
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none'; ul.style.paddingLeft = '0';
  items.forEach(c => {
        const li = document.createElement('li');
        li.style.marginBottom = '0.5rem';
        li.dataset.catId = c.id;
        // show name and position
        const span = document.createElement('span');
        span.textContent = `${c.name} (pos ${c.position})`;
        li.appendChild(span);
        li.appendChild(document.createTextNode(' '));
        // add sort checkbox
        const sortLabel = document.createElement('label');
        sortLabel.style.marginLeft = '0.5rem';
        sortLabel.style.fontSize = '0.9em';
        const sortCb = document.createElement('input');
        sortCb.type = 'checkbox';
        sortCb.checked = !!c.sort_alphanumeric;
        sortCb.style.marginRight = '0.25rem';
  // Prevent parent li click from stealing focus/causing re-render before change
  sortCb.addEventListener('click', function(ev){ ev.stopPropagation(); });
  sortCb.addEventListener('change', async function(ev){
          // POST to API to set sort flag
          statusEl.textContent = 'Updating sort...';
          try{
            const payload = { sort: sortCb.checked, _csrf: csrf };
            const resp = await fetch('/api/categories/' + encodeURIComponent(c.id) + '/sort', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('update failed');
            const data = await resp.json();
            if (statusEl) statusEl.textContent = `Updated sort for ${c.name}`;
            // update local representation
            c.sort_alphanumeric = !!data.sort_alphanumeric;
            try {
              // notify other pages (index) about the change so they can re-sort immediately
              localStorage.setItem('category_sort_changed', JSON.stringify({id: c.id, sort: c.sort_alphanumeric, ts: Date.now()}));
            } catch(e) { /* ignore storage errors */ }
          }catch(e){
            console.error('failed to update sort flag', e);
            if (statusEl) statusEl.textContent = 'Update failed';
            // revert checkbox
            sortCb.checked = !sortCb.checked;
          }
        });
        sortLabel.appendChild(sortCb);
        sortLabel.appendChild(document.createTextNode('A-Z'));
        li.appendChild(sortLabel);
        if (selectedId === c.id) {
          // show only a blue left rectangle for selection
          li.style.background = 'transparent';
          li.style.borderLeft = '4px solid #36f';
          li.style.paddingLeft = '';
        } else {
          li.style.background = '';
          li.style.borderLeft = '';
          li.style.paddingLeft = '';
        }
        // highlight the user's default category with a subtle background
        if (currentDefault !== null && Number(currentDefault) === Number(c.id)){
          li.style.background = '#eef6ff';
          li.title = 'Your default category';
        }
        li.addEventListener('click', () => {
          selectedId = c.id;
          if (statusEl) statusEl.textContent = `Selected #${selectedId}`;
          // re-render list to update highlight and controls
          renderList(items);
          updateControls(items);
        });
        ul.appendChild(li);
      });
      root.innerHTML = '';
      root.appendChild(ul);
    }

    function updateControls(items){
      const val = selectedId;
      const idx = items.findIndex(c => c.id === val);
      const atTop = idx <= 0;
      const atBottom = idx === items.length - 1;
      btnUp.disabled = (val == null) || atTop;
      btnDown.disabled = (val == null) || atBottom;
  if (btnDelete) btnDelete.disabled = (val == null);
  if (btnSetDefault) btnSetDefault.disabled = (val == null);
  if (btnClearDefault) btnClearDefault.disabled = false;
    }

    async function moveCat(catId, direction){
      try{
  console.log('[categories] move start', direction, catId);
        const payload = {direction: direction, _csrf: csrf};
        const resp = await fetch('/api/categories/' + catId + '/move', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error('move failed: ' + resp.status);
        const data = await resp.json();
    const arr = (data.categories||[]).map(c=>`${c.id}:${c.position}`);
    const before = (data.before||[]).map(c=>`${c.id}:${c.position}`);
    const after = (data.after||[]).map(c=>`${c.id}:${c.position}`);
    console.log('[categories] move ok', direction, catId, 'resp:', arr, 'before:', before, 'after:', after);
  if (statusEl) statusEl.textContent = `Moved ${direction} #${catId}`;
  const items = data.categories || [];
  // keep selection id
  renderList(items);
  updateControls(items);
  // Re-fetch to ensure order reflects any concurrent changes and server-normalized positions
        await fetchCategories();
      }catch(e){
  console.error('[categories] move failed', e);
  if (statusEl) statusEl.textContent = `Move failed: ${e}`;
        await fetchCategories();
      }
    }

    btnUp.addEventListener('click', async () => {
  const val = selectedId;
  if (val == null) return;
  if (statusEl) statusEl.textContent = `Moving up #${val}...`;
  await moveCat(val, 'up');
    });
    btnDown.addEventListener('click', async () => {
  const val = selectedId;
  if (val == null) return;
  if (statusEl) statusEl.textContent = `Moving down #${val}...`;
  await moveCat(val, 'down');
    });

    if (btnDelete) {
      btnDelete.addEventListener('click', async () => {
        const val = selectedId;
        if (val == null) return;
        const ok = window.confirm('Delete category and move its lists to Uncategorized? This cannot be undone.');
        if (!ok) return;
        if (statusEl) statusEl.textContent = `Deleting #${val}...`;
        try {
          const resp = await fetch('/html_no_js/categories/' + val + '/delete', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `_csrf=${encodeURIComponent(csrf)}`
          });
          if (!resp.ok) throw new Error('delete failed: ' + resp.status);
          if (statusEl) statusEl.textContent = `Deleted #${val}`;
          selectedId = null;
          await fetchCategories();
        } catch (e) {
          console.error('[categories] delete failed', e);
          if (statusEl) statusEl.textContent = `Delete failed: ${e}`;
          await fetchCategories();
        }
      });
    }

    if (btnSetDefault) {
      btnSetDefault.addEventListener('click', async () => {
        const val = selectedId;
        if (val == null) return;
        if (statusEl) statusEl.textContent = `Setting default category to #${val}...`;
        try {
          const payload = { category_id: val, _csrf: csrf };
          const resp = await fetch('/api/user/default_category', {
            method: 'POST', credentials: 'same-origin', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error('set default failed');
          const data = await resp.json();
          if (statusEl) statusEl.textContent = `Default category set`;
        } catch (e) {
          console.error('set default failed', e);
          if (statusEl) statusEl.textContent = `Set default failed`;
        }
      });
    }

    if (btnClearDefault) {
      btnClearDefault.addEventListener('click', async () => {
        if (!window.confirm('Clear your default category? New lists will go to Uncategorized.')) return;
        if (statusEl) statusEl.textContent = `Clearing default category...`;
        try {
          const payload = { category_id: null, _csrf: csrf };
          const resp = await fetch('/api/user/default_category', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
          if (!resp.ok) throw new Error('clear default failed');
          if (statusEl) statusEl.textContent = `Default cleared`;
        } catch (e) {
          console.error('clear default failed', e);
          if (statusEl) statusEl.textContent = `Clear default failed`;
        }
      });
    }

    fetchCategories();
  })();
  </script>

{% endblock %}
 
