{% extends 'base.html' %}
{% block title %}List: {{ list.name }} — Fast Todo (no-js){% endblock %}
{% block content %}
  <style>
    /* page-specific: remove top page margin so the site title sits flush to the top */
    body { margin-top: 0 !important; }
    header { margin-top: 0 !important; }

    /* Tweak spacing for the list header actions so the checkbox, trashcan
       and title have a bit more breathing room on the list page. */
    .list-header .list-action-left {
      width: 2.4rem; /* keep compact so title doesn't drop */
      flex: 0 0 2.4rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      min-width: 50px;
      font-size: 0.95rem;
    }
    .hashtag-suggest .item {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
    }
    .hashtag-suggest .item.active,
    .hashtag-suggest .item:hover {
      background: rgba(29, 78, 216, 0.12); /* light blue */
    }
   /* Slightly grey note text for the list view when hide-icons is enabled.
     Remove default paragraph margins so it sits flush with surrounding content. */
  .note-text { color: #6b7280; margin: 0; }
  .todo-hide-icon { color: #16a34a; margin-right: 0.4rem; }
  /* When hide-icons is enabled (applied as class on the todos-list):
     place the check glyph in a fixed left column and make titles/notes left-aligned. */
  /* Make the title+magnifier act as a compact inline-flex block so the magnifier remains
    directly after the last word of the title instead of being pushed to the far right. */
  .todos-list.hide-icons .todo-title-inline { display: inline-flex; align-items: center; gap: 0.4rem; flex: 1 1 auto; min-width: 0; max-width: 100%; flex-wrap: nowrap; }
  /* Ensure the left controls column shows the check glyph in hide-icons mode */
  .todos-list.hide-icons .controls-left { align-items: center; justify-content: flex-start; width: 1rem; flex: 0 0 1rem; }
  .todos-list.hide-icons .controls-left .hide-icon { width: 100%; display: flex; align-items: center; justify-content: center; }
  /* Keep the todo text and the open-link inline so the magnifier appears directly after the name.
    Prevent the title text from expanding to fill the line (which pushes the magnifier to the far right).
    Limit the title's max width so long titles wrap but the magnifier remains adjacent. */
  /* make the title text take the available space consistently so each row wraps the same
    amount; keep min-width:0 so flex children can shrink when necessary. The magnifier
    (next sibling) remains adjacent because the parent is inline-flex. */
  .todos-list.hide-icons .todo-title-inline .wrap-text { flex: 1 1 auto; display: inline-block; min-width: 0; text-align: left; max-width: none; overflow-wrap: anywhere; }
  .todos-list.hide-icons .todo-open-link { margin-left: 0.25rem; display: inline-block; vertical-align: baseline; line-height:1; flex: 0 0 auto; }
  .todos-list.hide-icons .note-text { text-align: left; }
  /* Ensure the magnifier sits on the text baseline and doesn't center-vertically within the paragraph */
  .todos-list.hide-icons .note-text .todo-open-link { vertical-align: baseline; line-height: 1; }
  .todos-list.hide-icons .note-text .note-body { vertical-align: baseline; display: inline; }
  /* Mobile override: ensure hide-icons left column width for small screens takes precedence.
     Placed after the general rules so the cascade applies this on mobile. Adjust value as needed. */
  @media (max-width: 480px) {
    .todos-list.hide-icons .controls-left { width: 2rem !important; flex: 0 0 2rem !important; }
    .todos-list.hide-icons .controls-left .hide-icon { width: 100% !important; display: flex !important; align-items: center !important; justify-content: center !important; }
  }

  /* Use the native browser tooltip via the title attribute instead of a custom
    pseudo-element. Keep data-date/data-created-at on elements for compatibility
    with existing JS, but rely on title for the UX. */
  .todos-list .todo-content, .todos-list .todo-main { overflow: visible; }
  /* Ensure completed todos are visually struck-through to match other pages */
  .todos-list .wrap-text.done,
  .todos-list .todo-title-inline .wrap-text.done,
  .todos-list .todo-title-inline a.done,
  table .wrap-text.done,
  table a.wrap-text.done,
  table tr.todo .title a.done {
    text-decoration: line-through;
    color: #6b7280; /* slightly muted to match completed styling elsewhere */
  }
  /* Ensure completed sublists are struck-through (match index/todo pages) */
  .lists-list .list-title.done { text-decoration: line-through; color: #6b7280; }
    /* Sublists layout (mirror todo.html fix): keep action buttons from overlapping titles */
    .lists-list .list-item { display: flex; align-items: flex-start; }
    .lists-list .list-item > .list-action-left { width: 5.5rem; flex: 0 0 5.5rem; gap: 0.25rem; align-items: center; justify-content: flex-start; }
    .lists-list .list-item > .list-main { min-width: 0; flex: 1 1 auto; }
    .lists-list .list-action-btn { padding: 0.14rem 0.22rem; font-size: 0.95rem; }
    @media (max-width: 480px) {
      .lists-list .list-item > .list-action-left { width: 6.5rem; flex-basis: 6.5rem; }
    }
  /* custom pseudo-element tooltip removed in favor of native title attribute */

  /* Create-todo form: make the input expand to fill the row and keep the Add button to the right.
     On very small screens the controls stack vertically. */
  #create-todo-form { display: flex; gap: 0.5rem; align-items: center; width: 100%; }
  #create-todo-form input#new-todo-text { flex: 1 1 auto; min-width: 0; box-sizing: border-box; }
  #create-todo-form button { flex: 0 0 auto; }
  @media (max-width: 420px) {
    #create-todo-form { flex-direction: column; }
    #create-todo-form input#new-todo-text, #create-todo-form button { width: 100%; }
  }

  </style>
  
  <div class="list-header">
    <div class="list-action-left">
      <form method="post" action="/html_no_js/lists/{{ list.id }}/complete" style="display:inline">
        {{ csrf_field() }}
        <input type="hidden" name="completed" value="{{ 'false' if list.completed else 'true' }}">
        <button type="submit" class="list-action-btn" title="{{ 'Unmark list complete' if list.completed else 'Mark list complete' }}" aria-label="Toggle list complete">{{ '☑' if list.completed else '☐' }}</button>
      </form>
      <script>
      (function(){
        try {
          var sel = 'form[action="/html_no_js/lists/{{ list.id }}/complete"]';
          var f = document.querySelector(sel);
          if (!f) return;
          f.addEventListener('submit', async function(e){
            e.preventDefault();
            try {
              var fd = new FormData(f);
              var res = await fetch(f.action, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
              if (!res.ok) { console && console.error && console.error('list complete failed', res.status); return; }
              var j = await res.json().catch(function(){ return null; });
              var completed = (j && typeof j.completed !== 'undefined') ? Boolean(j.completed) : (fd.get('completed') === 'true');
              var btn = f.querySelector('button[type="submit"]');
              if (btn) { btn.textContent = completed ? '☑' : '☐'; btn.title = completed ? 'Unmark list complete' : 'Mark list complete'; }
              var title = document.querySelector('.list-title'); if (title) title.classList.toggle('done', completed);
              var hidden = f.querySelector('input[name="completed"]'); if (hidden) hidden.value = completed ? 'false' : 'true';
            } catch(err){ console && console.error && console.error('list-complete error', err); }
          }, false);
        } catch(e){}
      })();
      </script>
      {# Delete moved to page-toolbar below; keep this area compact and only show the complete toggle here. #}
    </div>
    <div class="list-main">
  <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
  <h3 class="list-title" style="margin:0; display:inline-flex; align-items:center; gap:0.35rem;">
    {{ list.name }}
    {% if list.is_collation|default(false) %}
      {% set hue = (list.id * 47) % 360 %}
      <span class="meta" title="This is a collation list" style="display:inline-flex; align-items:center;">
        <span aria-hidden="true" style="--dot-hue: {{ hue }}; width:12px; height:12px; border-radius:50%; display:inline-block; border:2px solid hsl(var(--dot-hue), 75%, 35%); background: hsl(var(--dot-hue), 75%, 50%);"></span>
      </span>
    {% endif %}
  </h3>
  <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ list.id }}" data-list-name="{{ list.name|e }}" title="Edit list name" style="margin-left:0.25rem;">✏️</button>
            {# {% if not list.parent_todo_id and not list.parent_list_id %} #}
              <form method="post" action="/html_no_js/lists/{{ list.id }}/priority" style="display:inline-flex; align-items:center; gap:0.25rem; margin-left:0.5rem;">
                {{ csrf_field() }}
                <label for="priority-select-{{ list.id }}" class="sr-only">Priority</label>
                <select id="priority-select-{{ list.id }}" name="priority">
                  <option value="" {% if not list.priority %}selected{% endif %}>(none)</option>
                  {% for p in range(1, 11) %}
                    <option value="{{ p }}" {% if list.priority == p %}selected{% endif %}>{{ p }}</option>
                  {% endfor %}
                </select>
              </form>
              {# Collation controls (JS uses JSON endpoints; works only for owner which this page enforces) #}
              <span id="collation-controls" class="meta" data-is-collation="{{ 'true' if list.is_collation|default(false) else 'false' }}" data-collation-active="{{ 'true' if list.collation_active|default(false) else 'false' }}" style="margin-left:0.5rem; display:inline-flex; align-items:center; gap:0.4rem;">
                <button type="button" id="btn-collation-toggle" title="Mark or unmark this list as a collation list">{{ 'Unmark Collation' if list.is_collation|default(false) else 'Mark as Collation' }}</button>
                <label style="display:inline-flex; align-items:center; gap:0.25rem;">
                  <input type="checkbox" id="cb-collation-active" {% if list.is_collation|default(false) %}{% if list.collation_active|default(false) %}checked{% endif %}{% else %}disabled{% endif %}>
                  <span>Active</span>
                </label>
              </span>
            {# {% endif %} #}
            {# Show list tags directly under the title per UX request #}
            {% if list and list.id and list.hashtags and list.hashtags|length > 0 %}
              <div class="tags" role="list" aria-label="List tags" style="width:100%; margin-top:0.35rem">
                {% for tag in (list.hashtags | sort) %}
                  {% if tag and tag != '#' %}
                    <div role="listitem" style="display:inline-block; margin-right:0.4rem">
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                      <form method="post" action="/html_no_js/lists/{{ list.id }}/hashtags/remove" style="display:inline">
                        {{ csrf_field() }}
                        <input type="hidden" name="tag" value="{{ tag }}">
                        <button type="submit" class="tag-remove" aria-label="Remove {{ tag }}"><span aria-hidden="true">✖</span><span class="sr-only">Remove {{ tag }}</span></button>
                      </form>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
      </div>
    </div>
  </div>
            {# Compact links display directly under the title (no create/delete here) #}
            {% if links is defined and links|length > 0 %}
              <div class="meta" style="width:100%; margin-top:0.25rem">
                <strong>Links:</strong>
                {% for lk in links %}
                  <a href="{{ lk.href }}">{{ lk.label or lk.title or (lk.tgt_type ~ ' #' ~ lk.tgt_id) }}</a>{% if lk.tags and lk.tags|length %} <span class="tags-inline meta">{% for tag in lk.tags %}<a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>{% endfor %}</span>{% endif %}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </div>
            {% endif %}

  <script>
  // Collation controls: mark/unmark this list as a collation and toggle active state.
  (function(){
    try{
      var LIST_ID = {{ list.id }};
      var btn = document.getElementById('btn-collation-toggle');
      var cb = document.getElementById('cb-collation-active');
      var wrap = document.getElementById('collation-controls');
      if (!btn || !cb || !wrap) return;
      var state = { isCollation: (wrap.getAttribute('data-is-collation') === 'true'), active: (wrap.getAttribute('data-collation-active') === 'true'), loading: false };
      function setUI(){
        try{
          btn.textContent = state.isCollation ? 'Unmark Collation' : 'Mark as Collation';
          btn.disabled = !!state.loading;
          cb.disabled = !state.isCollation;
          cb.checked = !!(state.isCollation && state.active);
          cb.parentElement.style.opacity = state.isCollation ? '1' : '0.6';
        }catch(_){}
      }
      setUI();
      function postJSON(url, body){ return fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, credentials:'same-origin', body: JSON.stringify(body||{}) }).then(function(r){ return r.json(); }); }
      function delJSON(url){ return fetch(url, { method:'DELETE', headers:{ 'Accept':'application/json' }, credentials:'same-origin' }).then(function(r){ return r.json(); }); }
      // Already initialized from server-rendered attributes
      // Toggle mark/unmark
      btn.addEventListener('click', function(){
        if (state.loading) return;
        state.loading = true; setUI();
        if (!state.isCollation){
          postJSON('/client/json/collations', { list_id: LIST_ID, active: true }).then(function(j){
            if (j && j.ok){ state.isCollation = true; state.active = (typeof j.active !== 'undefined') ? !!j.active : true; }
          }).catch(function(){}).finally(function(){ state.loading = false; setUI(); });
        } else {
          delJSON('/client/json/collations/' + encodeURIComponent(LIST_ID)).then(function(j){
            if (j && j.ok){ state.isCollation = false; state.active = false; }
          }).catch(function(){}).finally(function(){ state.loading = false; setUI(); });
        }
      }, false);
      // Toggle active
      cb.addEventListener('change', function(){
        var want = !!cb.checked;
        postJSON('/client/json/collations/' + encodeURIComponent(LIST_ID) + '/active', { active: want }).then(function(j){
          if (j && j.ok){ state.active = !!j.active; }
          else { cb.checked = state.active; }
        }).catch(function(){ cb.checked = state.active; });
      }, false);
    }catch(e){ /* ignore for no-js fallback */ }
  })();
  </script>

  {# Sublist toolbar: show if this list is owned by a todo and/or another list #}
  {% if list.parent_todo_id or list.parent_list_id %}
  <nav class="page-toolbar" role="toolbar" aria-label="Sublist actions" style="display:flex;gap:0.5rem;align-items:center;margin:0.4rem 0 0.6rem 0;flex-wrap:wrap;">
    {% if list.parent_todo_id %}
      <span class="meta">List: <a href="/html_no_js/todos/{{ list.parent_todo_id }}" title="Back to owning todo">{{ list.parent_todo_text or ('#' ~ list.parent_todo_id) }}</a></span>
    {% endif %}
    {% if list.parent_list_id %}
      <span class="meta">List: <a href="/html_no_js/lists/{{ list.parent_list_id }}" title="Back to owning list">{{ list.parent_list_name or ('#' ~ list.parent_list_id) }}</a></span>
    {% endif %}
    <span class="meta" style="margin-left:0.25rem;">
      <!-- 
      {% if list.parent_todo_id %}
        todo “{{ list.parent_todo_text or ('#' ~ list.parent_todo_id) }}”
      {% endif %}
      {% if list.parent_todo_id and list.parent_list_id %} and {% endif %}
      {% if list.parent_list_id %}
        list “{{ list.parent_list_name or ('#' ~ list.parent_list_id) }}”
      {% endif %}
    -->
    </span>
    <div style="flex:1 1 auto"></div>
  </nav>
  {% endif %}


  {% if completion_types is not none %}
  {% endif %}
  <script>
  // Minimal rename for sublists: prompt and POST to list edit endpoint.
  // Use event delegation so buttons added later (or rendered after this script)
  // are handled correctly.
  (function(){
    function handleEditBtn(btn){
      var id = btn.getAttribute('data-list-id');
      var current = btn.getAttribute('data-list-name') || '';
      var name = window.prompt('New list name', current);
      if (!name || name.trim() === '') return;
      var fd = new FormData();
      fd.append('name', name);
      var csrfInput = document.querySelector('input[name="_csrf"]');
      if (csrfInput && csrfInput.value) fd.append('_csrf', csrfInput.value);
      fetch('/html_no_js/lists/' + encodeURIComponent(id) + '/edit', { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(res){ if (!res.ok) throw new Error('Rename failed'); return res.json().catch(function(){ return null; }); })
        .then(function(data){
          try{
            var newName = (data && data.name) ? data.name : name;
            var tags = (data && data.hashtags) ? data.hashtags : null;
            if (window.__ft_onListRenamed) {
              /* NOTE: Do NOT remove existing tags from the DOM here.
                 List rename operations must only add new tags. Removals of
                 existing tags are handled by dedicated tag-remove endpoints
                 elsewhere in the app. The client-side rename helper will
                 merge server-returned tags with any existing visible tag
                 chips rather than clearing them. */
              try{ if (tags) window.__ft_onListRenamed(id, newName, tags); else window.__ft_onListRenamed(id, newName); } catch(e){}
            }
          } catch(e){}
        })
        .catch(function(){ alert('Rename failed'); });
    }
    try {
      document.body.addEventListener('click', function(ev){
        var btn = ev.target && ev.target.closest ? ev.target.closest('.edit-list-btn') : null;
        if (!btn) return;
        handleEditBtn(btn);
      }, false);
    } catch(e) {}
  })();
  </script>

  {# If this list is configured to show Sublists "Up top", render the Sublists
     block here, just above the create-todo form. Otherwise the original
     Sublists block (further down) will render in its previous location. #}
  {% if sublists is defined and list.lists_up_top %}
  <section aria-label="Sublists" style="margin-top:1rem">
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
      <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-list-id="{{ list.id }}" title="Mark this list for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">🔖</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">↔️</a></h3>
      <form method="post" action="/html_no_js/lists/{{ list.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
        {{ csrf_field() }}
        <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ list.id }}" value="{{ 'true' if list.lists_up_top else 'false' }}">
        <label style="display:inline-flex; align-items:center; gap:0.4rem;">
          <input type="checkbox" id="lists_up_top_checkbox_{{ list.id }}" {% if list.lists_up_top %}checked{% endif %}>
          <span>Up top</span>
        </label>
      </form>
    </div>
    <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
      {{ csrf_field() }}
      <label>New sublist<br>
        <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </label>
      <button type="submit">Create</button>
    </form>
    {% if sublists|length > 0 %}
      <ul class="lists-list">
        {% for sl in sublists %}
          {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
          {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
          {# Render sublist priority data attributes and glyphs similar to index.html. Use parent_list_position as persistent manual-order. #}
          {% set circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'} %}
          {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
          <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
            <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
              <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="list-action-btn" title="Move up">⬆️</button>
              </form>
              <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="list-action-btn" title="Move down">⬇️</button>
              </form>
            </div>
            <div class="list-main">
              <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
              {% if sl.priority is not none %}
                <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
              {% endif %}
              {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
              {% endif %}
              <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">✏️</button>
              {% if sl.created_at %}
                <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
              {% endif %}
              {% if sl.hashtags and sl.hashtags|length > 0 %}
                <div class="tags" role="list" aria-label="List tags">
                  {% for tag in (sl.hashtags | sort) %}
                    <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>
  {% endif %}

  <script>
  // Sort Sublists by effective priority (desc), using parent_list_position as persistent tie-breaker (asc).
  (function(){
    try {
      var ul = document.querySelector('.lists-list');
      if (!ul) return;
      var items = Array.from(ul.querySelectorAll('li.list-item'));
      if (!items.length) return;
      // Parse attributes into sort keys
      function parseIntOrNull(v){ if (v === null || typeof v === 'undefined' || v === '') return null; var n = parseInt(v, 10); return isNaN(n) ? null : n; }
      items.sort(function(a, b){
        // effective priority (higher first)
        var ap = parseIntOrNull(a.getAttribute('data-priority'));
        var bp = parseIntOrNull(b.getAttribute('data-priority'));
        if (ap === null && bp !== null) return 1;
        if (bp === null && ap !== null) return -1;
        if (ap !== null && bp !== null){ if (bp !== ap) return bp - ap; }
        // tie-breaker: parent_list_position (lower means earlier)
        var ao = parseIntOrNull(a.getAttribute('data-parent-list-position'));
        var bo = parseIntOrNull(b.getAttribute('data-parent-list-position'));
        if (ao === null && bo !== null) return 1;
        if (bo === null && ao !== null) return -1;
        if (ao !== null && bo !== null){ if (ao !== bo) return ao - bo; }
        // final fallback: keep DOM order stable
        return 0;
      });
      // Reinsert items in sorted order
      items.forEach(function(li){ ul.appendChild(li); });
    } catch(e) { console && console.error && console.error('sublists sort failed', e); }
  })();
  </script>

  <script>
  (function(){
    var cb = document.getElementById('lists_up_top_checkbox_{{ list.id }}');
    var hidden = document.getElementById('lists_up_top_hidden_{{ list.id }}');
    if (!cb || !hidden) return;
    cb.addEventListener('change', function(){
      hidden.value = cb.checked ? 'true' : 'false';
      // send via fetch to avoid full page reload
      try {
        var fd = new FormData(); fd.append('lists_up_top', hidden.value);
        var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
        fetch('/html_no_js/lists/{{ list.id }}/lists_up_top', { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(res){ if (!res.ok) console && console.error && console.error('lists_up_top update failed'); });
      } catch(e){}
    });
  })();
  </script>

  <form id="create-todo-form" method="post" action="/html_no_js/todos/create" autocomplete="off">
  {{ csrf_field() }}
  <input id="new-todo-text" name="text" placeholder="Todo text" required autofocus autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
  <div id="hashtag-suggest" class="hashtag-suggest" role="listbox" aria-label="Hashtag suggestions" data-tags="{% if all_hashtags and all_hashtags|length > 0 %}{% for tag in all_hashtags %}{{ tag }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"></div>
    <input type="hidden" name="list_id" value="{{ list.id }}">
  <button type="submit" onclick="if (window.createTodoClick){ try { window.createTodoClick(event); } catch(e){}; return false; }">Add</button>
  </form>

  <script>
  // Enhance the create-todo form to POST via fetch and insert the new todo into
  // the DOM without a full page reload.
  (function(){
  var form = document.getElementById('create-todo-form');
  if (!form) return;
  // tooltip debug controller (disabled by default). Toggle with `window.tooltip.enabled = true` in console.
  window.tooltip = window.tooltip || {
    enabled: false,
    debug: function(){ if (this.enabled && console && console.debug) console.debug.apply(console, arguments); },
    log: function(){ if (this.enabled && console && console.log) console.log.apply(console, arguments); }
  };
  window.tooltip.log('[tooltip-debug] create-todo script loaded');
    var input = document.getElementById('new-todo-text');
  var submitBtn = form.querySelector('button[type="submit"]');
  // avoid leaving raw Jinja braces inside JS which can break static checks;
  // detect hide-icons mode from the rendered list element instead
  var _existingUL = document.querySelector('.todos-list');
  var HIDE_ICONS = !!(_existingUL && _existingUL.classList && _existingUL.classList.contains('hide-icons'));

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  window.createTodoClick = async function(e){
      e.preventDefault();
      var text = input.value && input.value.trim();
      if (!text) return;
      if (submitBtn) submitBtn.disabled = true;
      try {
  var listIdInput = form.querySelector('input[name="list_id"]');
  var listIdVal = listIdInput ? Number(listIdInput.value) : undefined;
  var apiUrl = '/todos';
  var body = { text: text };
  if (typeof listIdVal !== 'undefined') body.list_id = listIdVal;
  var res = await fetch(apiUrl, { method: 'POST', credentials: 'same-origin', headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) {
          var body = await res.text().catch(function(){ return null; });
          console.error('create-todo fetch failed', res.status, body);
          if (submitBtn) submitBtn.disabled = false;
          return;
        }
    var todo = await res.json();
  window.tooltip.debug('[tooltip-debug] createTodoClick API response:', todo);

        // format date/time for tooltip: D/MM H:MMAM (day no leading zero, month zero-padded, hour 12-hour no leading zero)
        function formatInlineDateTime(ts){
          try {
            window.tooltip.debug('[tooltip-debug] formatInlineDateTime input:', ts);
            if (!ts) { window.tooltip.debug('[tooltip-debug] formatInlineDateTime: no ts'); return null; }
            var d = new Date(ts);
            if (isNaN(d.getTime())) { window.tooltip.debug('[tooltip-debug] formatInlineDateTime: invalid date for', ts); return null; }
            var day = String(d.getDate());
            var month = String(d.getMonth() + 1).padStart(2,'0');
            var hh = d.getHours();
            var ampm = hh >= 12 ? 'PM' : 'AM';
            var hour12 = hh % 12; if (hour12 === 0) hour12 = 12;
            var min = String(d.getMinutes()).padStart(2,'0');
            var out = day + '/' + month + ' ' + String(hour12) + ':' + min + ampm;
            window.tooltip.debug('[tooltip-debug] formatInlineDateTime ->', out);
            return out;
          } catch(err) { window.tooltip.debug('[tooltip-debug] formatInlineDateTime exception', err); return null; }
        }

  var inlineDate = formatInlineDateTime(todo.created_at || todo.createdAt || todo.created || null);
  var titleAttr = inlineDate ? (' title="' + escapeHtml(inlineDate) + '"') : '';
  var dataAttr = inlineDate ? (' data-date="' + escapeHtml(inlineDate) + '" data-created-at="' + escapeHtml(todo.created_at || todo.createdAt || todo.created || '') + '"') : '';

        // Detect table mode (icons shown) or UL mode (hide-icons)
  // Use the same container detection as the reordering code
  var container = document.querySelector('table[data-extra-type-ids] tbody') || document.querySelector('table tbody') || document.querySelector('.todos-list');
        var table = container ? container.closest('table') : null;
        var ul = document.querySelector('.todos-list');

        // Get CSRF token from existing form for consistency with server-side
        var csrfToken = '';
        var existingCsrfInput = document.querySelector('input[name="_csrf"]');
        if (existingCsrfInput) {
          csrfToken = existingCsrfInput.value;
        }
        if (!table && !ul) {
          // fall back to creating UL if neither exists
          ul = document.createElement('ul');
          ul.className = 'todos-list' + (HIDE_ICONS ? ' hide-icons' : '');
          var p = form.parentNode && form.parentNode.querySelector('p');
          if (p && (p.textContent || '').trim().toLowerCase() === 'no todos yet.') p.replaceWith(ul);
          else {
            var ref = null; var sib = form.nextElementSibling;
            while (sib) { if (sib.tagName === 'H3' && /\bTodos\b/i.test(sib.textContent || '')) { ref = sib.nextElementSibling; break; } sib = sib.nextElementSibling; }
            if (ref && form.parentNode) form.parentNode.insertBefore(ul, ref); else form.parentNode.insertBefore(ul, form.nextSibling);
          }
        }

        // Build DOM for insertion based on mode
        var circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'};
        if (table) {
          var tbody = table.querySelector('tbody') || table;
          var tr = document.createElement('tr');
          tr.id = 'todo-' + todo.id;
          if (todo.priority != null) tr.setAttribute('data-priority', String(todo.priority));
          
          // pin cell (first column)
          var tdPin = document.createElement('td'); tdPin.className = 'action';
          try {
            tdPin.innerHTML = '<form method="post" action="/html_no_js/todos/' + todo.id + '/pin">' +
                              (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                              '<input type="hidden" name="pinned" value="' + (todo.pinned ? 'false' : 'true') + '">' +
                              '<button type="submit" aria-label="Pin" title="Pin" class="pin-button ' + (todo.pinned ? 'pinned' : '') + '">' + (todo.pinned ? '📌' : '📍') + '</button>' +
                              '</form>';
          } catch(e) { /* ignored (tdPin build failed) */ }
          tr.appendChild(tdPin);
          
          // delete cell (second column)
          var tdDel = document.createElement('td'); tdDel.className = 'action';
          tdDel.style.paddingLeft = '20px';
          tdDel.style.paddingRight = '20px';
          try {
            tdDel.innerHTML = '<form method="post" action="/html_no_js/todos/' + todo.id + '/delete">' +
                              (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                              '<input type="hidden" name="anchor" value="todo-' + todo.id + '">' +
                              '<button type="submit" aria-label="Delete" title="Delete">🗑</button>' +
                              '</form>';
          } catch(e) { /* ignored (tdDel build failed) */ }
          tr.appendChild(tdDel);
          
          // default completion cell (third column)
          var tdDef = document.createElement('td'); tdDef.className = 'icon';
          try {
            tdDef.innerHTML = '<form method="post" action="/html_no_js/todos/' + todo.id + '/complete" data-default-completion="true">' +
                              (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                              '<input type="hidden" name="anchor" value="todo-' + todo.id + '">' +
                              '<input type="hidden" name="done" value="' + (todo.completed ? 'false' : 'true') + '">' +
                              '<button type="submit" aria-label="' + (todo.completed ? 'Unmark' : 'Mark') + '" title="' + (todo.completed ? 'Unmark' : 'Mark') + '">' + (todo.completed ? '☑' : '☐') + '</button>' +
                              '</form>';
          } catch(e) { /* ignored (tdDef build failed) */ }
          tr.appendChild(tdDef);
          
          // extra completion cells per header order
          var idsAttr = table.getAttribute('data-extra-type-ids') || '';
          var extraIds = idsAttr ? idsAttr.split(',').map(function(s){ return s.trim(); }).filter(Boolean) : [];
          extraIds.forEach(function(cid){
            var td = document.createElement('td'); td.className = 'icon';
            try {
              td.innerHTML = '<form method="post" action="/html_no_js/todos/' + todo.id + '/complete_type" style="display:inline">' +
                             (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                             '<input type="hidden" name="anchor" value="todo-' + todo.id + '">' +
                             '<input type="hidden" name="completion_type_id" value="' + cid + '">' +
                             '<input type="hidden" name="done" value="true">' +
                             '<button type="submit" aria-label="Mark" title="Mark">☐</button>' +
                             '</form>';
            } catch(e) { /* ignored (extra td build failed) */ }
            tr.appendChild(td);
          });
          
          // title cell (last column)
          var tdTitle = document.createElement('td'); tdTitle.className = 'title';
          try {
            tdTitle.innerHTML = '<div class="todo-title-inline' + (todo.completed ? ' done' : '') + '">' +
                                '<a class="wrap-text' + (todo.completed ? ' done' : '') + '" href="/html_no_js/todos/' + todo.id + '"' + titleAttr + dataAttr + '>' + escapeHtml(todo.text) + '</a>' +
                                (todo.priority ? (' <span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>') : '') +
                                '</div>' +
                                (todo.note ? ('<div class="meta line-clamp-1 wrap-text">' + escapeHtml(todo.note) + '</div><div class="meta"><a href="/html_no_js/todos/' + todo.id + '">view full</a></div>') : '');
          } catch(e) { /* ignored (tdTitle build failed) */ }
          tr.appendChild(tdTitle);
          
          // insert at top
          var body = table.querySelector('tbody') || table;
          if (body.firstChild) body.insertBefore(tr, body.firstChild); else body.appendChild(tr);
          var insertedElement = tr;
        } else {
          var li = document.createElement('li');
          li.id = 'todo-' + todo.id;
          li.className = 'todo';
          if (todo.priority !== undefined && todo.priority !== null) {
            li.setAttribute('data-priority', String(todo.priority));
          }
          // Simple innerHTML assembly (escaped) to match visible structure.
          var titleHtml;
          var currentHide = !!(document.querySelector('.todos-list') && document.querySelector('.todos-list').classList && document.querySelector('.todos-list').classList.contains('hide-icons'));
          if (currentHide) {
            titleHtml = '<span class="wrap-text"' + titleAttr + dataAttr + '>' +
                        '<a class="wrap-text' + (todo.completed ? ' done' : '') + '" href="/html_no_js/todos/' + todo.id + '"' + titleAttr + dataAttr + '>' + escapeHtml(todo.text) + '</a>' +
                        (todo.priority ? (' <span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>') : '') +
                        ' <a href="/html_no_js/todos/' + todo.id + '" class="todo-open-link" aria-label="View todo ' + todo.id + '" style="margin-left:0.25rem; text-decoration:none;">🔎</a>' +
                        '</span>';
          } else {
            titleHtml = '<a class="wrap-text' + (todo.completed ? ' done' : '') + '" href="/html_no_js/todos/' + todo.id + '"' + titleAttr + dataAttr + '>' + escapeHtml(todo.text) + (todo.priority ? (' <span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>') : '') + '</a>';
          }
          var noteHtml = todo.note ? (HIDE_ICONS ? ('<p class="note-text"><span class="note-body">' + escapeHtml(todo.note) + '</span></p>') : ('<div class="meta line-clamp-1 wrap-text">' + escapeHtml(todo.note) + '</div>')) : '';
          var priHtml = '';
          if (todo.priority) { priHtml = '<span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>'; }
            var controlsHtml = '';
          if (currentHide) {
            controlsHtml = '<div class="controls-left controls-left-wide"><div class="hide-icon" aria-hidden="true">' + (todo.completed ? '<span class="todo-hide-icon">✅</span>' : '&nbsp;') + '</div></div>';
          } else {
            var doneVal = todo.completed ? 'false' : 'true';
            var pinVal = todo.pinned ? 'false' : 'true';
            controlsHtml = '<div class="controls-left controls-left-wide">' +
                           '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/complete" data-default-completion="true">' +
                           (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                           '<input type="hidden" name="anchor" value="todo-' + escapeHtml(todo.id) + '">' +
                           '<input type="hidden" name="done" value="' + doneVal + '">' +
                           '<button type="submit" aria-label="' + (todo.completed ? 'Unmark' : 'Mark') + '" title="' + (todo.completed ? 'Unmark' : 'Mark') + '">' + (todo.completed ? '☑' : '☐') + '</button>' +
                           '</form>' +
                           '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/delete">' +
                           (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                           '<input type="hidden" name="anchor" value="todo-' + escapeHtml(todo.id) + '">' +
                           '<button type="submit" aria-label="Delete" title="Delete">🗑</button>' +
                           '</form>' +
                           '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/pin">' +
                           (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                           '<input type="hidden" name="pinned" value="' + pinVal + '">' +
                           '<button type="submit" aria-label="Pin" title="Pin" class="pin-button ' + (todo.pinned ? 'pinned' : '') + '">' + (todo.pinned ? '📌' : '📍') + '</button>' +
                           '</form>' +
                           '</div>';
          }
          try { li.innerHTML = controlsHtml + '<div class="todo-content"><div class="todo-main"><div class="todo-title-inline">' + titleHtml + '</div>' + noteHtml + priHtml + '</div></div>'; }
          catch(e) { /* ignored (ul branch insert failed) */ }
          if (ul) { ul.insertBefore(li, ul.firstChild); }
          var insertedElement = li;
        }
        // Simple innerHTML assembly (escaped) to match visible structure.

        // priority glyph map (declare before use)
        var circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'};
        var titleHtml;
  // Determine hide-icons state from the current DOM at insertion time
  var currentHide = !!(document.querySelector('.todos-list') && document.querySelector('.todos-list').classList && document.querySelector('.todos-list').classList.contains('hide-icons'));
  if (currentHide) {
          // Match server-rendered structure: outer span.wrap-text containing an inner anchor for the text,
          // then an inline priority marker and the magnifier link.
          titleHtml = '<span class="wrap-text"' + titleAttr + dataAttr + '>' +
                      '<a class="wrap-text' + (todo.completed ? ' done' : '') + '" href="/html_no_js/todos/' + todo.id + '"' + titleAttr + dataAttr + '>' + escapeHtml(todo.text) + '</a>' +
                      (todo.priority ? (' <span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>') : '') +
                      ' <a href="/html_no_js/todos/' + todo.id + '" class="todo-open-link" aria-label="View todo ' + todo.id + '" style="margin-left:0.25rem; text-decoration:none;">🔎</a>' +
                      '</span>';
  } else {
          titleHtml = '<a class="wrap-text' + (todo.completed ? ' done' : '') + '" href="/html_no_js/todos/' + todo.id + '"' + titleAttr + dataAttr + '>' + escapeHtml(todo.text) + (todo.priority ? (' <span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>') : '') + '</a>';
        }
        var noteHtml = todo.note ? (HIDE_ICONS ? ('<p class="note-text"><span class="note-body">' + escapeHtml(todo.note) + '</span></p>') : ('<div class="meta line-clamp-1 wrap-text">' + escapeHtml(todo.note) + '</div>')) : '';
        var priHtml = '';
        if (todo.priority) {
          priHtml = '<span class="meta priority-inline"><span class="priority-circle">' + (circ[todo.priority] || todo.priority) + '</span></span>';
        }
          // Build left-controls markup to mirror server-rendered structure.
        var controlsHtml = '';
        if (currentHide) {
          controlsHtml = '<div class="controls-left controls-left-wide"><div class="hide-icon" aria-hidden="true">' + (todo.completed ? '<span class="todo-hide-icon">✅</span>' : '&nbsp;') + '</div></div>';
        } else {
          // Minimal non-Jinja forms — JS will rely on cookies for CSRF as server accepts that.
          var doneVal = todo.completed ? 'false' : 'true';
          var pinVal = todo.pinned ? 'false' : 'true';
          controlsHtml = '<div class="controls-left controls-left-wide">' +
                         '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/complete" data-default-completion="true">' +
                         (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                         '<input type="hidden" name="anchor" value="todo-' + escapeHtml(todo.id) + '">' +
                         '<input type="hidden" name="done" value="' + doneVal + '">' +
                         '<button type="submit" aria-label="' + (todo.completed ? 'Unmark' : 'Mark') + '" title="' + (todo.completed ? 'Unmark' : 'Mark') + '">' + (todo.completed ? '☑' : '☐') + '</button>' +
                         '</form>' +
                         '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/delete">' +
                         (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                         '<input type="hidden" name="anchor" value="todo-' + escapeHtml(todo.id) + '">' +
                         '<button type="submit" aria-label="Delete" title="Delete">🗑</button>' +
                         '</form>' +
                         '<form method="post" action="/html_no_js/todos/' + escapeHtml(todo.id) + '/pin">' +
                         (csrfToken ? '<input type="hidden" name="_csrf" value="' + escapeHtml(csrfToken) + '">' : '') +
                         '<input type="hidden" name="pinned" value="' + pinVal + '">' +
                         '<button type="submit" aria-label="Pin" title="Pin" class="pin-button ' + (todo.pinned ? 'pinned' : '') + '">' + (todo.pinned ? '📌' : '📍') + '</button>' +
                         '</form>' +
                         '</div>';
        }
  try {
    // Only overwrite innerHTML for UL mode, not for table mode
    var _target = (typeof li !== 'undefined' && li) ? li : null;
    if (_target) {
      _target.innerHTML = controlsHtml + '<div class="todo-content"><div class="todo-main"><div class="todo-title-inline">' + titleHtml + '</div>' + noteHtml + priHtml + '</div></div>';
    } else {
      /* no target to set innerHTML (table mode or post-mode) */
    }
  } catch(e) { /* ignored (setting target.innerHTML failed) */ }

  // insertion done above based on mode
  window.tooltip.debug('[tooltip-debug] create insertion inlineDate ->', inlineDate);
  try {
    if (typeof insertedElement !== 'undefined' && insertedElement && insertedElement.outerHTML) window.tooltip.debug('[tooltip-debug] inserted element outerHTML:', insertedElement.outerHTML);
    else window.tooltip.debug('[tooltip-debug] inserted element not available', { insertedElement: typeof insertedElement !== 'undefined' ? !!insertedElement : null, li: typeof li !== 'undefined' ? !!li : null, tr: typeof tr !== 'undefined' ? !!tr : null });
  } catch(e) { window.tooltip.debug('[tooltip-debug] inserted element outerHTML access failed', e); }
        input.value = '';
        if (submitBtn) submitBtn.disabled = false;
        try { input.focus(); } catch(e) {}
      } catch(err) {
        console.error('create-todo handler error', err && err.stack ? err.stack : err);
        if (submitBtn) submitBtn.disabled = false;
      }
  };
  try { form.addEventListener('submit', window.createTodoClick); } catch(e){}
  })();
  </script>
  <script>
    // Populate debug tooltip text 'DEBUG - DD/MM' from data-created-at for any wrap-text
    (function(){
      // use the global tooltip controller (created by the create-todo script); create if missing
      window.tooltip = window.tooltip || { enabled: false, debug: function(){}, log: function(){} };
      window.tooltip.log('[tooltip-debug] tooltip formatter script loaded');
      function formatFromISO(iso){
        try {
          window.tooltip.debug('[tooltip-debug] formatFromISO input:', iso);
          if (!iso) { window.tooltip.debug('[tooltip-debug] formatFromISO: no iso'); return null; }
          var d = new Date(iso);
          if (isNaN(d.getTime())) { window.tooltip.debug('[tooltip-debug] formatFromISO: invalid iso', iso); return null; }
          var day = String(d.getDate());
          var mo = String(d.getMonth()+1).padStart(2,'0');
          var hh = d.getHours();
          var ampm = hh >= 12 ? 'PM' : 'AM';
          var hour12 = hh % 12; if (hour12 === 0) hour12 = 12;
          var min = String(d.getMinutes()).padStart(2,'0');
          var out = day + '/' + mo + ' ' + String(hour12) + ':' + min + ampm;
          window.tooltip.debug('[tooltip-debug] formatFromISO ->', out);
          return out;
        } catch(_) { return null; }
      }
      function extractFromExisting(el){
        // try to find a full pattern DD/MM H:MMAM in data-date or title; do NOT fabricate current time
        var attrs = [el.getAttribute('data-date'), el.getAttribute('title')];
        window.tooltip.debug('[tooltip-debug] extractFromExisting attrs for element', el, attrs);
        for (var i=0;i<attrs.length;i++){
          var v = attrs[i]; if (!v) continue;
          // full pattern e.g. 3/08 9:05AM or 03/08 09:05AM
          var m = v.match(/(\d{1,2}\/\d{2}\s+\d{1,2}:\d{2}(?:AM|PM))/);
          if (m) { window.tooltip.debug('[tooltip-debug] extractFromExisting found full datetime ->', m[1]); return m[1]; }
        }
        return null;
      }
      function applyAll(){
      var nodes = document.querySelectorAll('.wrap-text[data-created-at]:not([data-created-at=""])');
      window.tooltip.debug('[tooltip-debug] applyAll found (non-empty) ', nodes.length, 'nodes');
        nodes.forEach(function(el){
          try {
            var existing = el.getAttribute('data-date') || el.getAttribute('title') || '';
            var fullDtRE = /\d{1,2}\/\d{2}\s+\d{1,2}:\d{2}(?:AM|PM)/;
            window.tooltip.debug('[tooltip-debug] applyAll element attrs', { existing: existing, data_created_at: el.getAttribute('data-created-at'), title: el.getAttribute('title'), data_date: el.getAttribute('data-date') });
            if (existing && fullDtRE.test(existing)) { window.tooltip.debug('[tooltip-debug] applyAll skipping existing full dt'); return; }

            var iso = el.getAttribute('data-created-at');
            window.tooltip.debug('[tooltip-debug] applyAll iso value:', iso);
            // prefer ISO if present; otherwise try to extract a full datetime from existing attributes
            var ddm = iso ? formatFromISO(iso) : extractFromExisting(el);
            if (!ddm) {
              var partialRE = /\d{1,2}\/\d{1,2}/;
              if (existing && partialRE.test(existing)) { window.tooltip.debug('[tooltip-debug] applyAll existing partial, skipping'); return; }
              window.tooltip.debug('[tooltip-debug] applyAll: no reliable datetime for element, skipping');
              return;
            }
            window.tooltip.debug('[tooltip-debug] applyAll setting ddm ->', ddm);
            // only set native title; preserve any existing data-date for compatibility
            el.setAttribute('title', ddm);
          } catch(e) { window.tooltip.debug('[tooltip-debug] applyAll element error', e); }
        });
      }
      // Log hover attributes to help diagnose blank tooltip boxes
      try {
        document.body.addEventListener('mouseover', function(ev){
          var w = ev.target && ev.target.closest ? ev.target.closest('.wrap-text') : null;
          if (!w) return;
          window.tooltip.log('[tooltip-debug] hover on wrap-text attrs', { data_created_at: w.getAttribute('data-created-at'), data_date: w.getAttribute('data-date'), title: w.getAttribute('title'), text: w.textContent && w.textContent.trim() });
        }, true);
  } catch(e) { window.tooltip.debug('[tooltip-debug] hover listener attach failed', e); }
      // run once and also watch for future additions
      try { applyAll(); } catch(e){}
      var ro = new MutationObserver(function(){ try { applyAll(); } catch(e){} });
      ro.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
  <script>
    // Fallback: some browsers or assistive tech may ignore autofocus; ensure focus on the input.
    (function(){
      try {
        var el = document.getElementById('new-todo-text');
        if (el && document.activeElement !== el) el.focus();
      } catch(e) {}
    })();
    // Inline caret-based hashtag completion for the new-todo input
    (function(){
      var input = document.getElementById('new-todo-text');
      var box = document.getElementById('hashtag-suggest');
      if (!input || !box) return;

      // Build the suggestions source from server-provided tags (user-owned)
      var ALL_TAGS = (box.getAttribute('data-tags') || '')
        .split(',')
        .map(function(s){ return s.trim(); })
        .filter(function(s){ return s.length > 0; });

      var state = { open: false, items: [], active: 0, range: [0,0] };

      function closeBox(){ box.style.display = 'none'; state.open = false; }

    function render(items){
        box.innerHTML = '';
        if (!items || items.length === 0) { closeBox(); return; }
        items.slice(0, 20).forEach(function(tag, idx){
          var el = document.createElement('div');
          el.className = 'item' + (idx === state.active ? ' active' : '');
          el.setAttribute('role', 'option');
      // Tags from server already include '#'; avoid doubling it
      el.textContent = (typeof tag === 'string' && tag.charAt(0) === '#') ? tag : ('#' + tag);
          el.dataset.idx = String(idx);
          el.addEventListener('mousedown', function(ev){
            // mousedown, not click, to run before input loses focus
            ev.preventDefault();
            commit(idx);
          });
          box.appendChild(el);
        });
        box.style.display = 'block';
      }

      function positionBox(caretIndex){
        try {
          var rect = input.getBoundingClientRect();
          var style = window.getComputedStyle(input);
          var leftPad = parseFloat(style.paddingLeft) || 0;
          var font = [style.fontWeight, style.fontSize, style.fontFamily].filter(Boolean).join(' ');
          var text = input.value.slice(0, caretIndex);
          var canvas = positionBox._c || (positionBox._c = document.createElement('canvas'));
          var ctx = canvas.getContext('2d');
          ctx.font = font;
          var metrics = ctx.measureText(text);
          var x = rect.left + leftPad + metrics.width - (input.scrollLeft || 0);
          // Keep within viewport
          var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
          var maxLeft = vw - 200; // leave room
          box.style.left = Math.max(8, Math.min(x, maxLeft)) + 'px';
          box.style.top = (rect.bottom + 4) + 'px';
          box.style.minWidth = Math.max(160, rect.width * 0.4) + 'px';
        } catch(_) {
          // Fallback: left-align under input
          var r = input.getBoundingClientRect();
          box.style.left = (r.left) + 'px';
          box.style.top = (r.bottom + 4) + 'px';
        }
      }

      function openFor(fragment, start, end){
        // fragment excludes '#'; filter by the tag body (without leading '#')
        var frag = (fragment || '').toLowerCase();
        function body(t){ return (t && t.charAt(0) === '#') ? t.slice(1) : (t || ''); }
        var items = ALL_TAGS.filter(function(t){ return body(t).toLowerCase().indexOf(frag) === 0; });
        state.items = items;
        state.active = 0;
        state.range = [start, end];
        if (items.length === 0) { closeBox(); return; }
        positionBox(end);
        render(items);
        state.open = true;
      }

      function findFragment(){
        var pos = input.selectionStart || 0;
        var left = (input.value || '').slice(0, pos);
  // require first char after '#' to be a letter and subsequent chars to be alphanumeric
  var m = left.match(/(^|\s)#([A-Za-z][A-Za-z0-9]*)$/);
        if (!m) return null;
        var fragment = m[2] || '';
        var start = pos - fragment.length - 1; // include '#'
        return { fragment: fragment, start: start, end: pos };
      }

      function commit(idx){
        if (!state.open || idx == null || idx < 0 || idx >= state.items.length) return;
        var tag = state.items[idx];
        var v = input.value;
        var start = state.range[0];
        var end = state.range[1];
        var before = v.slice(0, start);
        var after = v.slice(end);
        // Use the tag as-is if it already includes '#'
        var replacement = (typeof tag === 'string' && tag.charAt(0) === '#') ? tag : ('#' + tag);
        // Insert a trailing space if the next char is not whitespace
        var needsSpace = after.length === 0 || !/^\s/.test(after);
        var newVal = before + replacement + (needsSpace ? ' ' : '') + after;
        var newCaret = (before + replacement).length + (needsSpace ? 1 : 0);
        input.value = newVal;
        input.setSelectionRange(newCaret, newCaret);
        closeBox();
      }

      input.addEventListener('input', function(){
        var f = findFragment();
        if (!f) { closeBox(); return; }
        openFor(f.fragment, f.start, f.end);
      });

      input.addEventListener('keydown', function(ev){
        if (!state.open) return;
        if (ev.key === 'ArrowDown') { ev.preventDefault(); state.active = Math.min(state.active + 1, state.items.length - 1); render(state.items); }
        else if (ev.key === 'ArrowUp') { ev.preventDefault(); state.active = Math.max(state.active - 1, 0); render(state.items); }
        else if (ev.key === 'Enter' || ev.key === 'Tab') { ev.preventDefault(); commit(state.active); }
        else if (ev.key === 'Escape') { ev.preventDefault(); closeBox(); }
      });

      // Reposition on focus/scroll to keep alignment sensible
      input.addEventListener('focus', function(){ var f = findFragment(); if (f) { positionBox(f.end); } });
  window.addEventListener('scroll', function(){ if (state.open) { var f = findFragment(); if (f) positionBox(f.end); } }, true);
  window.addEventListener('resize', function(){ if (state.open) { var f = findFragment(); if (f) positionBox(f.end); } });
  // Close suggestion box on outside click, touchstart or page scroll to avoid dual scroll indicators on mobile
  document.addEventListener('click', function(ev){ if (!box.contains(ev.target) && ev.target !== box && ev.target !== input) closeBox(); });
  try { document.addEventListener('touchstart', function(ev){ if (!box.contains(ev.target) && ev.target !== box && ev.target !== input) closeBox(); }, { passive: true }); } catch(e) {}
  try { window.addEventListener('scroll', function(){ if (state.open) closeBox(); }, true); } catch(e) {}
    })();
  </script>


  {% if todos %}
    {% set extra_types = completion_types | selectattr('name','ne','default') | list %}
    {% if not list.hide_icons %}
      <div>
        <style>
          /* Remove rounded boxes and default borders for icon buttons inside the table */
          table td button, table td form button {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            line-height: 1 !important;
            font-size: 1rem !important;
          }
          /* Ensure forms inside table cells render inline */
          table td form { display: inline; }
          /* table cells top + left align when this class is applied to <table> */
          .table-top-left td, .table-top-left th {
            vertical-align: top;
            text-align: left;
          }
          /* Mobile: allow the wide action table to scroll horizontally without affecting desktop */
          @media (max-width: 560px) {
            table.table-top-left {
              display: block;              /* allow overflow on the table element */
              overflow-x: auto;            /* enable horizontal scroll on iPhone */
              -webkit-overflow-scrolling: touch; /* momentum scroll for iOS */
              width: 100%;
            }
            /* Keep action/header cells compact; let the Todo column wrap */
            table.table-top-left th { white-space: nowrap; }
            table.table-top-left td { white-space: nowrap; }
            /* last column is the Todo text cell in this table */
            table.table-top-left td:last-child { white-space: normal; }
            /* keep the Todo text column reasonably wide on mobile for readability */
            table.table-top-left td:last-child,
            table.table-top-left th:last-child { min-width: 14rem; }
            table.table-top-left td:last-child .todo-title-inline .wrap-text { white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
            /* tighten padding on the first couple of action columns */
            table.table-top-left td:nth-child(1),
            table.table-top-left td:nth-child(2),
            table.table-top-left th:nth-child(1),
            table.table-top-left th:nth-child(2) { padding-left: 10px !important; padding-right: 10px !important; }
          }
        </style>
        <table class="table-top-left" data-extra-type-ids="{% if extra_types and extra_types|length>0 %}{% for ct in extra_types %}{{ ct.id }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}">
          {% if extra_types and extra_types|length > 0 %}
          <thead>
            <tr>
              <th style="padding-left: 20px; padding-right: 20px;"scope="col" aria-hidden="true"></th>
              <th style="padding-left: 20px; padding-right: 20px;"scope="col" aria-hidden="true"></th>
              <th scope="col" title="Default completion">Done</th>
              {% for ct in extra_types %}
                <th scope="col" title="{{ ct.name }}">{{ ct.name }}</th>
              {% endfor %}
              <th scope="col">Todo</th>
              <!-- spacer headers so columns align with row cells (Pin, Delete) -->
            </tr>
          </thead>
          {% endif %}
          <tbody>
          {% for t in todos %}
            <tr id="todo-{{ t.id }}" data-priority="{{ t.priority if t.priority is not none else '' }}">
              <td>
                <form method="post" action="/html_no_js/todos/{{ t.id }}/pin">
                  {{ csrf_field() }}
                  <input type="hidden" name="pinned" value="{{ 'false' if t.pinned|default(false) else 'true' }}">
                  <button type="submit" aria-label="Pin" title="Pin" class="pin-button {% if t.pinned|default(false) %}pinned{% endif %}">{{ '📌' if t.pinned|default(false) else '📍' }}</button>
                </form>
              </td>
              <td style="padding-left: 20px; padding-right: 20px;">
                <form method="post" action="/html_no_js/todos/{{ t.id }}/delete">
                  {{ csrf_field() }}
                  <input type="hidden" name="anchor" value="todo-{{ t.id }}">
                  <button type="submit" aria-label="Delete" title="Delete">🗑</button>
                </form>
              </td>
              <td>
                <form method="post" action="/html_no_js/todos/{{ t.id }}/complete" data-default-completion="true">
                  {{ csrf_field() }}
                  <input type="hidden" name="anchor" value="todo-{{ t.id }}">
                  <input type="hidden" name="done" value="{{ 'false' if t.completed else 'true' }}">
                  <button type="submit" aria-label="{{ 'Unmark' if t.completed else 'Mark' }}" title="{{ 'Unmark' if t.completed else 'Mark' }}">{{ '☑' if t.completed else '☐' }}</button>
                </form>
              </td>
              {% for ct in extra_types %}
                {% set ec = (t.extra_completions | selectattr('id','equalto',ct.id) | list | first) %}
                <td>
                  <form method="post" action="/html_no_js/todos/{{ t.id }}/complete_type" style="display:inline">
                    {{ csrf_field() }}
                    <input type="hidden" name="anchor" value="todo-{{ t.id }}">
                    <input type="hidden" name="completion_type_id" value="{{ ct.id }}">
                    <input type="hidden" name="done" value="{{ 'false' if ec and ec.done else 'true' }}">
                    <button type="submit" aria-label="{{ 'Unmark ' + ct.name if ec and ec.done else 'Mark ' + ct.name }}" title="{{ ct.name }}">{{ '☑' if ec and ec.done else '☐' }}</button>
                  </form>
                </td>
              {% endfor %}
              <td>
                {% set dt_iso = t.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
                {% set dt_fmt = t.created_at|in_tz(client_tz, '%-d/%m %-I:%M%p') %}
                {% set circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'} %}
                <div class="todo-title-inline {% if t.completed %}done{% endif %}">
                  <a class="wrap-text{% if t.completed %} done{% endif %}" href="/html_no_js/todos/{{ t.id }}"{% if dt_iso %} data-created-at="{{ dt_iso }}"{% endif %}{% if dt_fmt %} data-date="{{ dt_fmt }}" title="{{ dt_fmt }}"{% endif %}>{{ t.text }}</a>{% if t.priority %} <span class="meta priority-inline"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>{% endif %}
                </div>
                {% if t.note %}
                  <div class="meta line-clamp-1 wrap-text">{{ t.note }}</div>
                  <div class="meta"><a href="/html_no_js/todos/{{ t.id }}">view full</a></div>
                {% endif %}
                {% if t.tags and t.tags|length > 0 %}
                  <div class="tags meta">
                    {% for tag in (t.tags | sort) %}
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}">{{ tag }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              </td>
              
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <ul class="todos-list hide-icons">
        {% for t in todos %}
          <li id="todo-{{ t.id }}" class="todo" data-priority="{{ t.priority if t.priority is not none else '' }}">
            <div class="controls-left controls-left-wide">
              <div class="hide-icon" aria-hidden="true">{% if t.completed %}<span class="todo-hide-icon">✅</span>{% else %}&nbsp;{% endif %}</div>
            </div>
            <div class="todo-content">
              <div class="todo-main">
                <div class="todo-title-inline">
                  {% set dt_iso = t.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
                  {% set dt_fmt = t.created_at|in_tz(client_tz, '%-d/%m %-I:%M%p') %}
                  {% set circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'} %}
                  <span class="wrap-text"{% if dt_iso %} data-created-at="{{ dt_iso }}"{% endif %}{% if dt_fmt %} data-date="{{ dt_fmt }}" title="{{ dt_fmt }}"{% endif %}>
                    <a class="wrap-text{% if t.completed %} done{% endif %}" href="/html_no_js/todos/{{ t.id }}"{% if dt_iso %} data-created-at="{{ dt_iso }}"{% endif %}{% if dt_fmt %} data-date="{{ dt_fmt }}" title="{{ dt_fmt }}"{% endif %}>{{ t.text }}</a>{% if t.priority %} <span class="meta priority-inline"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>{% endif %}
                    <a href="/html_no_js/todos/{{ t.id }}" class="todo-open-link" aria-label="View todo {{ t.id }}" style="margin-left:0.25rem; text-decoration:none;">🔎</a>
                  </span>
                </div>
                {% if t.note %}
                  <p class="note-text"><span class="note-body">{{ t.note | linkify }}</span></p>
                {% endif %}
                {% if t.tags and t.tags|length > 0 %}
                  <div class="tags meta">
                    {% for tag in (t.tags | sort) %}
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}">{{ tag }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% else %}
    <p>No todos yet.</p>
  {% endif %}

  
  {% if completion_types is not none %}
  <h3>Completion types</h3>
  <div class="meta" style="margin-bottom:0.5rem">
    {% if completion_types and completion_types|length > 0 %}
      <div class="tags-inline" role="list" aria-label="Completion types">
        {% for ct in completion_types %}
          <div role="listitem" style="display:inline-block; margin-right:0.35rem">
            <span class="tag-chip ctype-chip" title="Completion type">{{ ct.name }}</span>
            {% if ct.name != 'default' %}
              <form method="post" action="/html_no_js/lists/{{ list.id }}/completion_types/remove" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="name" value="{{ ct.name }}">
                <button type="submit" class="tag-remove" aria-label="Remove completion type {{ ct.name }}">✖</button>
              </form>
            {% else %}
              <span class="meta" title="Built-in default completion">(default)</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="meta">No completion types defined yet.</div>
    {% endif %}
    <form method="post" action="/html_no_js/lists/{{ list.id }}/completion_types" style="display:inline-block; margin-left:0.5rem" aria-label="Add completion type">
      {{ csrf_field() }}
      <label class="sr-only">Add completion type</label>
      <input name="name" placeholder="Type name" aria-label="Completion type name">
      <button type="submit">Add</button>
    </form>
    <!-- Hide icons toggle: moves the header toggle into a more discoverable place under completion types -->
    <form method="post" action="/html_no_js/lists/{{ list.id }}/icons" style="margin-top:0.6rem;" id="hide-icons-form-{{ list.id }}">
      {{ csrf_field() }}
      <!-- Hidden field carries explicit true/false value; checkbox toggles it and submits immediately -->
      <input type="hidden" name="hide_icons" id="hide-icons-hidden-{{ list.id }}" value="{{ 'true' if list.hide_icons else 'false' }}">
      <label style="display:inline-flex; align-items:center; gap:0.4rem;">
        <input type="checkbox" id="hide-icons-checkbox-{{ list.id }}" {% if list.hide_icons %}checked{% endif %}>
        <span>hide icons</span>
      </label>
      <script>
        (function(){
          var cb = document.getElementById('hide-icons-checkbox-{{ list.id }}');
          var hidden = document.getElementById('hide-icons-hidden-{{ list.id }}');
          var form = document.getElementById('hide-icons-form-{{ list.id }}');
          if (!cb || !hidden || !form) {
            console && console.debug && console.debug('[hide-icons] missing element:', { cb: !!cb, hidden: !!hidden, form: !!form });
            return;
          }

          // Simple escaper for user text when building innerHTML for dynamic updates
          function esc(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

          // Update a single todo <li> to match hide-icons state. Tries to preserve created-at/data-date attributes.
          function updateTodoRow(li, hide){
            try {
              if (!li) return;
              var id = li.id && li.id.replace(/^todo-/, '') || '';
              // determine completed and pinned states from existing DOM
              var completed = !!li.querySelector('.todo-title-inline .wrap-text.done, .todo-title-inline .wrap-text a.done');
              var pinBtn = li.querySelector('.pin-button');
              var pinned = pinBtn && pinBtn.classList && pinBtn.classList.contains('pinned');

              // controls-left area
              var controls = li.querySelector('.controls-left');
              if (controls) {
                if (hide) {
                  // replace with hide-icon block
                  controls.innerHTML = '<div class="hide-icon" aria-hidden="true">' + (completed ? '<span class="todo-hide-icon">✅</span>' : '&nbsp;') + '</div>';
                } else {
                  // build regular forms (no csrf inputs — JS fetch handlers append cookie if needed)
                  var doneVal = completed ? 'false' : 'true';
                  var completeForm = '<form method="post" action="/html_no_js/todos/' + esc(id) + '/complete">' +
                                      '<input type="hidden" name="anchor" value="todo-' + esc(id) + '">' +
                                      '<input type="hidden" name="done" value="' + doneVal + '">' +
                                      '<button type="submit" aria-label="' + (completed ? 'Unmark' : 'Mark') + '" title="' + (completed ? 'Unmark' : 'Mark') + '">' + (completed ? '☑' : '☐') + '</button>' +
                                      '</form>';
                  var deleteForm = '<form method="post" action="/html_no_js/todos/' + esc(id) + '/delete">' +
                                      '<button type="submit" aria-label="Delete" title="Delete">🗑</button>' +
                                   '</form>';
                  var pinForm = '<form method="post" action="/html_no_js/todos/' + esc(id) + '/pin">' +
                                  '<input type="hidden" name="pinned" value="' + (pinned ? 'false' : 'true') + '">' +
                                  '<button type="submit" aria-label="Pin" title="Pin" class="pin-button ' + (pinned ? 'pinned' : '') + '">' + (pinned ? '📌' : '📍') + '</button>' +
                                '</form>';
                  controls.innerHTML = completeForm + deleteForm + pinForm;
                }
              }

              // title area
              var titleInline = li.querySelector('.todo-title-inline');
              if (titleInline) {
                // find existing text and attributes
                var existingWrap = titleInline.querySelector('.wrap-text') || titleInline.querySelector('a.wrap-text');
                var createdAt = existingWrap && (existingWrap.getAttribute('data-created-at') || existingWrap.getAttribute('data-created_at') || existingWrap.getAttribute('data-created-at'));
                var dataDate = existingWrap && (existingWrap.getAttribute('data-date') || existingWrap.getAttribute('data-date'));
                var noteNode = li.querySelector('.note-text .note-body') || li.querySelector('.meta.line-clamp-1.wrap-text');
                var noteText = noteNode ? noteNode.textContent : '';
                var text = '';
                // prefer anchor text if present
                var textEl = titleInline.querySelector('a.wrap-text') || titleInline.querySelector('.wrap-text');
                if (textEl) text = textEl.textContent || '';

                // Build new inner HTML for titleInline depending on hide
                var titleHtml = '';
                var titleAttr = createdAt ? (' title="' + esc(dataDate || '') + '"') : '';
                var dataAttr = createdAt ? (' data-date="' + esc(dataDate || '') + '" data-created-at="' + esc(createdAt || '') + '"') : '';
                if (hide) {
                  titleHtml = '<span class="wrap-text"' + titleAttr + dataAttr + '>' +
                              '<a class="wrap-text' + (completed ? ' done' : '') + '" href="/html_no_js/todos/' + esc(id) + '"' + titleAttr + dataAttr + '>' + esc(text) + '</a>' +
                              (noteText ? ' <span class="meta priority-inline"></span>' : '') +
                              ' <a href="/html_no_js/todos/' + esc(id) + '" class="todo-open-link" aria-label="View todo ' + esc(id) + '" style="margin-left:0.25rem; text-decoration:none;">🔎</a>' +
                              '</span>';
                } else {
                  titleHtml = '<a class="wrap-text' + (completed ? ' done' : '') + '" href="/html_no_js/todos/' + esc(id) + '"' + titleAttr + dataAttr + '>' + esc(text) + '</a>';
                }
                titleInline.innerHTML = titleHtml;

                // note area: swap between <p class="note-text"><span class="note-body">..</span></p> and <div class="meta line-clamp-1 wrap-text">..
                var noteContainer = li.querySelector('.note-text') || li.querySelector('.meta.line-clamp-1.wrap-text');
                if (noteContainer) {
                  if (hide) {
                    // replace with p.note-text
                    var p = document.createElement('p'); p.className = 'note-text'; var span = document.createElement('span'); span.className = 'note-body'; span.textContent = noteText; p.appendChild(span);
                    noteContainer.parentNode.replaceChild(p, noteContainer);
                  } else {
                    var div = document.createElement('div'); div.className = 'meta line-clamp-1 wrap-text'; div.textContent = noteText;
                    noteContainer.parentNode.replaceChild(div, noteContainer);
                  }
                }
              }
            } catch(e) { console && console.error && console.error('[hide-icons] updateTodoRow error', e); }
          }

          function updateTodosForHideIcons(hide){
            var lis = document.querySelectorAll('li.todo');
            lis.forEach(function(li){ updateTodoRow(li, hide); });
          }

          console && console.debug && console.debug('[hide-icons] attaching listener to checkbox id=', cb.id, 'form action=', form.getAttribute('action'));
          cb.addEventListener('change', function(){
            console && console.debug && console.debug('[hide-icons] change event fired, checked=', cb.checked);
            hidden.value = cb.checked ? 'true' : 'false';
            try {
              var fd = new FormData(); fd.append('hide_icons', hidden.value);
              // append _csrf if present in DOM, otherwise rely on cookie (server handlers accept cookie)
              var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
              var actionUrl = form.getAttribute('action') || window.location.href;
              console && console.debug && console.debug('[hide-icons] fetch', actionUrl, 'body hide_icons=', hidden.value, 'csrf_present=', !!(csrf && csrf.value));
              fetch(actionUrl, { method: 'POST', body: fd, credentials: 'same-origin' })
                .then(function(res){
                  console && console.debug && console.debug('[hide-icons] fetch response ok=', !!res && res.ok, 'status=', res && res.status);
                  if (!res.ok) console && console.error && console.error('hide-icons update failed', res && res.status);
                  else {
                    // Reload to switch between table and UL layouts reliably
                    try { window.location.reload(); } catch(e) {}
                  }
                })
                .catch(function(err){ console && console.error && console.error('[hide-icons] fetch exception', err); });
            } catch(e){ console && console.error && console.error('[hide-icons] handler exception', e); }
          });

          // If page initially rendered with hide-icons, ensure rows are in the expected state
          try { if (cb.checked) updateTodosForHideIcons(true); } catch(e){}
        })();
      </script>
    </form>
  {% if list.hide_icons %}{% endif %}
  </div>
  {% endif %}
  <!-- the 'completed after' option is not available for hide icons -->
  {% if not list.hide_icons %}
  <div style="margin:0.5rem 0; display:flex; align-items:center; gap:0.5rem;">
    <label style="display:inline-flex; align-items:center; gap:0.4rem;">
      <input type="checkbox" id="completed-after-checkbox">
      <span>completed after</span>
    </label>
  </div>

  <script>
  (function(){
    function setCookie(name, value, days){ var expires=''; if(days){ var d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires='; expires='+d.toUTCString(); } document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/'; }
    function getCookie(name){ var m = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return m ? decodeURIComponent(m[1]) : null; }

    var cb = document.getElementById('completed-after-checkbox');
    if (!cb) return;

    var initialized = false;

    function attachOnce(container){
      if (initialized) return; initialized = true;
      var isTable = !!container.closest('table');
      var initialItems = Array.from(container.querySelectorAll(isTable ? 'tr.todo' : 'li.todo'));
      var originalOrder = initialItems.map(function(it){ return it.id; });

      // init checkbox from cookie (namespaced per-list)
      var cookieName = 'completed_after_list_{{ list.id }}';
      var v = getCookie(cookieName);
      cb.checked = v === '1';

      function isCompletedElem(it){
        var chk = it.querySelector('form[action*="/complete"] button');
        if (chk && chk.textContent && chk.textContent.indexOf('☑') !== -1) return true;
        if (it.querySelector('.todo-title-inline.done')) return true;
        return false;
      }

      function reorder(){
        try {
          var currentItems = Array.from(container.querySelectorAll(isTable ? 'tr.todo' : 'li.todo'));
          var map = {};
          currentItems.forEach(function(it){ if (it.id) map[it.id] = it; });

          if (!cb.checked) {
            // restore original server order (for items present) then append any new items in their current order
            originalOrder.forEach(function(id){ var el = map[id]; if (el) container.appendChild(el); });
            currentItems.forEach(function(it){ if (!it.id || originalOrder.indexOf(it.id) === -1) container.appendChild(it); });
            return;
          }

          var incomplete = [], completed = [];
          // iterate originalOrder first so we preserve server ordering within groups
          var orderedIds = originalOrder.concat(currentItems.map(function(it){ return it.id; }).filter(function(id){ return originalOrder.indexOf(id) === -1; }));
          orderedIds.forEach(function(id){ var el = map[id]; if (!el) return; if (isCompletedElem(el)) completed.push(el); else incomplete.push(el); });
          incomplete.concat(completed).forEach(function(el){ container.appendChild(el); });
        } catch(e){ /* ignore */ }
      }

      cb.addEventListener('change', function(){ setCookie(cookieName, cb.checked ? '1' : '0', 365); reorder(); });
      // initial ordering based on cookie
      reorder();
    }

    function findOrWaitForUl(){
  var container = document.querySelector('table[data-extra-type-ids] tbody') || document.querySelector('table tbody') || document.querySelector('.todos-list');
      if (container) return attachOnce(container);
      // wait for UL to appear (e.g., template renders after this script or a partial renders)
      var ro = new MutationObserver(function(mutations, obs){
  var u = document.querySelector('table[data-extra-type-ids] tbody') || document.querySelector('table tbody') || document.querySelector('.todos-list');
  if (u) { obs.disconnect(); attachOnce(u); }
      });
      try { ro.observe(document.body || document.documentElement, { childList: true, subtree: true }); } catch(e){ /* ignore */ }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', findOrWaitForUl); else findOrWaitForUl();
  })();
  </script>
  {% endif %}

    {# Page toolbar (placed just below the main navigation toolbar) #}
  <nav class="page-toolbar" role="toolbar" aria-label="List actions" style="display:flex;gap:0.0rem;align-items:center;margin-bottom:0.0rem;">
      {% if categories is defined %}
        <form method="post" action="/html_no_js/lists/{{ list.id }}/category" style="display:inline-flex; align-items:center; gap:0.35rem; margin-right:0.75rem;">
          {{ csrf_field() }}
          <label for="category-select-{{ list.id }}" class="sr-only">Category</label>
          <select id="category-select-{{ list.id }}" name="category_id" onchange="this.form.submit()">
            <option value="-1" {% if not list.category_id %}selected{% endif %}>(no category)</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if list.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </form>
      {% endif %}
    <form id="list-delete-form" method="post" action="/html_no_js/lists/{{ list.id }}/delete" class="confirm-delete" data-confirm="Delete list '{{ list.name }}' and all its todos? This cannot be undone." style="display:inline">
      {{ csrf_field() }}
      <button type="submit" class="tb-item" aria-label="Delete list">🗑 <span class="sr-only">Delete</span></button>
    </form>
    <div style="flex:1 1 auto"></div>
  </nav>
  
  {# Sublists section moved here, below the delete icon toolbar #}
  {% if sublists is defined and not list.lists_up_top %}
  <section aria-label="Sublists" style="margin-top:1rem">
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
      <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-list-id="{{ list.id }}" title="Mark this list for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">🔖</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">↔️</a></h3>
      <form method="post" action="/html_no_js/lists/{{ list.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
        {{ csrf_field() }}
        <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ list.id }}" value="{{ 'true' if list.lists_up_top else 'false' }}">
        <label style="display:inline-flex; align-items:center; gap:0.4rem;">
          <input type="checkbox" id="lists_up_top_checkbox_{{ list.id }}" {% if list.lists_up_top %}checked{% endif %}>
          <span>Up top</span>
        </label>
      </form>
    </div>
    <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
      {{ csrf_field() }}
      <label>New sublist<br>
        <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </label>
      <button type="submit">Create</button>
    </form>
    {% if sublists|length > 0 %}
      <ul class="lists-list">
        {% for sl in sublists %}
          {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
          {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
          {% set circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'} %}
          {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
          <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
            <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
              <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="list-action-btn" title="Move up">⬆️</button>
              </form>
              <form method="post" action="/html_no_js/lists/{{ list.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="list-action-btn" title="Move down">⬇️</button>
              </form>
            </div>
            <div class="list-main">
              <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
              {% if sl.priority is not none %}
                <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
              {% endif %}
              {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
              {% endif %}
              <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">✏️</button>
              {% if sl.created_at %}
                <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
              {% endif %}
              {% if sl.hashtags and sl.hashtags|length > 0 %}
                <div class="tags" role="list" aria-label="List tags">
                  {% for tag in (sl.hashtags | sort) %}
                    <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
      <script>
      // Sort Sublists by effective priority (desc), using parent_list_position as persistent tie-breaker (asc).
      (function(){
        try {
          var ul = document.querySelectorAll('.lists-list');
          if (!ul || !ul.length) return;
          // find the last lists-list in this section (the one we just rendered)
          var localUl = ul[ul.length-1];
          var items = Array.from(localUl.querySelectorAll('li.list-item'));
          if (!items.length) return;
          function parseIntOrNull(v){ if (v === null || typeof v === 'undefined' || v === '') return null; var n = parseInt(v, 10); return isNaN(n) ? null : n; }
          items.sort(function(a, b){
            var ap = parseIntOrNull(a.getAttribute('data-priority'));
            var bp = parseIntOrNull(b.getAttribute('data-priority'));
            if (ap === null && bp !== null) return 1;
            if (bp === null && ap !== null) return -1;
            if (ap !== null && bp !== null){ if (bp !== ap) return bp - ap; }
            var ao = parseIntOrNull(a.getAttribute('data-parent-list-position'));
            var bo = parseIntOrNull(b.getAttribute('data-parent-list-position'));
            if (ao === null && bo !== null) return 1;
            if (bo === null && ao !== null) return -1;
            if (ao !== null && bo !== null){ if (ao !== bo) return ao - bo; }
            return 0;
          });
          items.forEach(function(li){ localUl.appendChild(li); });
        } catch(e) { console && console.error && console.error('sublists sort failed', e); }
      })();
      </script>
    {% endif %}
  </section>
  {% endif %}
  

  {# Links section: outgoing links from this list to todos or lists #}
  <section aria-label="Links" style="margin-top:0.75rem">
    <h3 style="margin:0 0 .4rem 0">Links</h3>
    <form id="add-link-form-{{ list.id }}" method="post" action="/html_no_js/lists/{{ list.id }}/links" style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap">
      {{ csrf_field() }}
      <input type="hidden" name="tgt_type" value="">
      <input type="hidden" name="tgt_id" value="">
      <label>Marked
        <select id="link-target-{{ list.id }}">
          <option value="">(Select a recently marked item)</option>
        </select>
      </label>
      <label>Label <input name="label" placeholder="Optional label"></label>
      <button type="submit">Add link</button>
    </form>
    <p id="link-empty-{{ list.id }}" class="meta" style="display:none;margin:0.2rem 0">No marked items. Use the 🔖 button on a todo or list to mark it, then return here.</p>
    <script>
    (function(){
      try{
        var KEY='ft_marks_v1'; var TTL=5*60*1000;
        function load(){ try { return JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(_){ return {}; } }
        function prune(o){ var t=Date.now(); var out={todos:{},lists:{}}; if(o.todos) for(var k in o.todos){ if((t-(o.todos[k]||0))<TTL) out.todos[k]=o.todos[k]; } if(o.lists) for(var k2 in o.lists){ if((t-(o.lists[k2]||0))<TTL) out.lists[k2]=o.lists[k2]; } return out; }
        var sel=document.getElementById('link-target-{{ list.id }}'); if(!sel) return;
        var emptyMsg=document.getElementById('link-empty-{{ list.id }}');
        var marks=prune(load()); var count=0;
        function addOpt(v,t,parent){ var o=document.createElement('option'); o.value=v; o.textContent=t; (parent||sel).appendChild(o); count++; }
        if (marks.todos && Object.keys(marks.todos).length){
          var og=document.createElement('optgroup'); og.label='Todos'; sel.appendChild(og);
          Object.keys(marks.todos).sort(function(a,b){return (+a)-(+b);}).forEach(function(id){ addOpt('todo:'+id, 'Todo #'+id, og); });
        }
        if (marks.lists && Object.keys(marks.lists).length){
          var og2=document.createElement('optgroup'); og2.label='Lists'; sel.appendChild(og2);
          Object.keys(marks.lists).sort(function(a,b){return (+a)-(+b);}).forEach(function(id){ addOpt('list:'+id, 'List #'+id, og2); });
        }
        if (!count && emptyMsg){ emptyMsg.style.display='block'; }
        var form = document.getElementById('add-link-form-{{ list.id }}');
        if (form){ form.addEventListener('submit', function(e){ try{ var v=sel.value||''; if(!v){ e.preventDefault(); alert('Select a marked item first.'); return; } var parts=v.split(':'); if(parts.length!==2){ e.preventDefault(); alert('Invalid selection'); return; } var t=parts[0], id=parts[1]; form.querySelector('input[name="tgt_type"]').value=t; form.querySelector('input[name="tgt_id"]').value=id; }catch(err){ e.preventDefault(); } }, false); }
      }catch(e){ /* silent */ }
    })();
    </script>
    {% if links is defined and links|length > 0 %}
      <ul style="list-style: none; padding-left: 0; margin-left: 0;">
        {% for lk in links %}
          <li>
            <a href="{{ lk.href }}">{{ lk.label or lk.title or (lk.tgt_type ~ ' #' ~ lk.tgt_id) }}</a>{% if lk.tags and lk.tags|length %} <span class="tags-inline meta">{% for tag in lk.tags %}<a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>{% endfor %}</span>{% endif %}
            <form method="post" action="/html_no_js/lists/{{ list.id }}/links/{{ lk.id }}/delete" style="display:inline">
              {{ csrf_field() }}
              <button type="submit" class="tag-remove" title="Remove link"><span aria-hidden="true">✖</span><span class="sr-only">Remove link</span></button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="meta" style="margin:0.2rem 0">No links yet.</p>
    {% endif %}
  </section>




  <!-- Bottom delete control: provide a clear delete action at end of page -->
  <div style="margin-top:1rem;">
    <form method="post" action="/html_no_js/lists/{{ list.id }}/delete" class="confirm-delete" data-confirm="Delete list '{{ list.name }}' and all its todos? This cannot be undone." style="display:inline">
      {{ csrf_field() }}
      <button type="submit" class="tb-item" aria-label="Delete list" title="Delete list">🗑 <span class="sr-only">Delete list</span></button>
    </form>
  </div>
    
{% endblock %}

{% block scripts %}
<script>
// Simple mark-storage helper used by mark icon on list page
(function(){
  const KEY='ft_marks_v1'; const TTL=5*60*1000; // 5 minutes
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(_){ return {}; } }
  function save(o){ try { localStorage.setItem(KEY, JSON.stringify(o||{})); } catch(_){ } }
  function prune(o){ const t=Date.now(); const out={todos:{},lists:{}}; if(o.todos) for(const[k,v] of Object.entries(o.todos)) if((t-v)<TTL) out.todos[k]=v; if(o.lists) for(const[k,v] of Object.entries(o.lists)) if((t-v)<TTL) out.lists[k]=v; return out; }
  function mark(kind, id){ let o=prune(load()); if(!o[kind]) o[kind]={}; o[kind][String(id)]=Date.now(); save(o); }
  var btn = document.getElementById('mark-list-hdr');
  if (btn){ btn.addEventListener('click', function(){ var lid = Number(btn.getAttribute('data-list-id')); if (lid) { mark('lists', lid); btn.textContent='✔️'; setTimeout(function(){ btn.textContent='🔖'; }, 1200); } }); }
})();
</script>
<script>
  (function(){
    var cb = document.getElementById('lists_up_top_checkbox_{{ list.id }}');
    var hidden = document.getElementById('lists_up_top_hidden_{{ list.id }}');
    var form = hidden && hidden.closest('form');
    if (!cb || !hidden || !form) return;
    cb.addEventListener('change', function(){ hidden.value = cb.checked ? 'true' : 'false'; try{ form.submit(); } catch(e){} });
  })();
</script>
<script>
  // Priority select: submit via fetch and update priority UI inline
  (function(){
    try{
      var sel = document.getElementById('priority-select-{{ list.id }}');
      if (!sel) return;
      sel.addEventListener('change', function(){
        var v = sel.value;
        var fd = new FormData(); fd.append('priority', v);
        var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
        fetch('/html_no_js/lists/{{ list.id }}/priority', { method: 'POST', body: fd, credentials: 'same-origin' })
          .then(function(res){ if (!res.ok) throw new Error('Priority update failed'); return res.json().catch(function(){ return null; }); })
          .then(function(data){
            try{
              // update any inline priority-circle for this list (if present)
              var circ = {1:'①',2:'②',3:'③',4:'④',5:'⑤',6:'⑥',7:'⑦',8:'⑧',9:'⑨',10:'⑩'};
              var elems = document.querySelectorAll('.priority-circle');
              elems.forEach(function(el){
                var parent = el.closest('[data-list-id], .list-main, .list-title');
                // best-effort: if this page's list (top title) has a nearby priority-circle, update it
              });
              // For now, update the header area: find any .meta.priority-inline directly under .list-main and replace its content
              var header = document.querySelector('.list-header');
              if (header) {
                var p = header.querySelector('.priority-inline .priority-circle');
                if (p) {
                  p.textContent = v ? (circ[v] || v) : '';
                } else if (v) {
                  // insert a new priority-inline element after the title
                  var title = header.querySelector('.list-main');
                  if (title) {
                    var span = document.createElement('span'); span.className = 'meta priority-inline'; var inner = document.createElement('span'); inner.className = 'priority-circle'; inner.textContent = (circ[v] || v); span.appendChild(inner); title.querySelector('.list-main') && title.appendChild(span);
                  }
                }
              }
            }catch(e){}
          })
          .catch(function(){ console && console.error && console.error('Priority update failed'); });
      });
    } catch(e) {}
  })();
</script>
<script>
  // Delegate todo-level form submissions (complete, complete_type, delete, pin)
  (function(){
    function getFormActionMatch(action){
      try{ var m = action && action.match(/\/html_no_js\/todos\/(\d+)\/(complete|delete|pin|complete_type)/); return m; }catch(e){ return null; }
    }
    document.body.addEventListener('submit', function(ev){
      var form = ev.target;
      if (!form || form.tagName !== 'FORM') return;
      var action = form.getAttribute('action') || '';
      var m = getFormActionMatch(action);
      if (!m) return; // not a todo-level form we handle
      ev.preventDefault();
      var todoId = m[1];
      var actionType = m[2];
      var fd = new FormData(form);
      var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
      fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(res){ if (!res.ok) throw new Error('Request failed'); return res.text().catch(function(){ return null; }); })
        .then(function(){
          try{
            var anchorInput = form.querySelector('input[name="anchor"]');
            var anchorId = anchorInput ? anchorInput.value : ('todo-' + todoId);
            var li = document.getElementById(anchorId) || document.getElementById('todo-' + todoId);
            if (actionType === 'delete') {
              if (li) li.remove();
              return;
            }
            if (actionType === 'pin') {
              var btn = form.querySelector('button') || form.querySelector('input[type=submit]');
              if (btn) {
                var pinned = btn.classList && btn.classList.contains('pinned');
                if (pinned) { btn.classList.remove('pinned'); btn.textContent = '📍'; }
                else { btn.classList.add('pinned'); btn.textContent = '📌'; }
              }
              return;
            }
            if (actionType === 'complete' || actionType === 'complete_type') {
              var btn = form.querySelector('button') || form.querySelector('input[type=submit]');
              if (btn) {
                var isChecked = btn.textContent && btn.textContent.indexOf('☑') !== -1;
                btn.textContent = isChecked ? '☐' : '☑';
              }
              // Only swap the text/font (done class) for default completion toggles.
              // Extra completion types should not change the todo's text decoration.
              var isDefault = form.getAttribute && form.getAttribute('data-default-completion') === 'true';
              if (isDefault && li) {
                // toggle done class on any title elements inside the todo
                var titleElems = li.querySelectorAll('.todo-title-inline .wrap-text, .wrap-text a, .todo-title-inline');
                titleElems.forEach(function(el){ try{ if (el.classList && el.classList.contains('done')) el.classList.remove('done'); else if (el.classList) el.classList.add('done'); }catch(e){} });
              }
              return;
            }
          }catch(e){ console && console.error && console.error('todo action DOM update failed', e); }
        })
        .catch(function(){ alert('Action failed'); });
    }, false);
  })();
</script>
<script>
  // Delegate sublist move forms: POST via fetch and reorder the <li> up/down
  (function(){
    function matchSublistMove(action){
      try{ var m = action && action.match(/\/html_no_js\/lists\/(?:\d+)\/sublists\/(\d+)\/move/); return m; }catch(e){ return null; }
    }
    document.body.addEventListener('submit', function(ev){
      var form = ev.target;
      if (!form || form.tagName !== 'FORM') return;
      var action = form.getAttribute('action') || '';
      var m = matchSublistMove(action);
      if (!m) return;
      ev.preventDefault();
      var sublistId = m[1];
      var fd = new FormData(form);
      var dir = fd.get('direction');
      var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
      fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(res){ if (!res.ok) throw new Error('Move failed'); return res.text().catch(function(){ return null; }); })
        .then(function(){
          try{
            // find the li corresponding to this sublist id
            var li = document.querySelector('li.list-item[data-parent-list-position][data-list-priority], li.list-item');
            // better: find li with a child .list-title href pointing to the sublist id
            var selector = 'a.list-title[href*="/html_no_js/lists/' + sublistId + '"]';
            var a = document.querySelector(selector);
            if (!a) return;
            var liNode = a.closest('li.list-item'); if (!liNode) return;
            var parentUl = liNode.parentElement;
            if (!parentUl) return;
            if (dir === 'up') {
              var prev = liNode.previousElementSibling;
              if (prev) parentUl.insertBefore(liNode, prev);
            } else if (dir === 'down') {
              var next = liNode.nextElementSibling;
              if (next) parentUl.insertBefore(next, liNode);
            }
          }catch(e){ console && console.error && console.error('sublist move DOM update failed', e); }
        })
        .catch(function(){ alert('Move failed'); });
    }, false);
  })();
</script>
{% endblock %}

