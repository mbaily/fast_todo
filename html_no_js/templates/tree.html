{% extends 'base.html' %}
{% block title %}Tree ‚Äî Fast Todo (no-js){% endblock %}
{% block content %}
  <style>
    body { margin-top: 0 !important; }
    header { margin-top: 0 !important; }
    ul.tree { list-style: none; margin: 0; padding-left: 0.5rem; }
    ul.tree li { margin: 0.15rem 0; }
    .meta { color: #6b7280; font-size: 0.9em; }
    .icon { display:inline-block; width:1rem; }
    .prio {
      display: inline-flex; align-items: center; gap: 0.25rem; margin-left: 0.35rem;
    }
    .prio .primary, .prio .secondary {
      display:inline-block; width: 1rem; height: 1rem; border-radius: 50%;
      border: 2px solid #4b5563; text-align:center; font-size: 0.75rem; line-height: 0.9rem;
    }
    .prio .secondary { opacity: 0.6; }
    .toolbar { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem; }
    .toolbar form { display:inline-flex; align-items:center; gap:0.35rem; }
    /* destination highlight */
    li.dest { background: #ecfdf5; /* green-50 */ }
    li.dest > .icon, li.dest > a { color: #065f46; /* green-800 */ }
    /* recenter control: use muted grey instead of default link blue */
    a.recenter { color: var(--muted); }
    a.recenter:hover, a.recenter:focus { color: var(--muted); }
  </style>
  {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
  {# anchor form element by id so scattered checkboxes can submit with it #}
  <form id="tree-bulk-move-form" method="post" action="/html_no_js/tree/bulk_move" style="display:none;">
    <input type="hidden" name="_csrf" value="{{ csrf_token }}">
    {% if root_list_id is not none %}
    <input type="hidden" name="root_list_id" value="{{ root_list_id }}">
    {% endif %}
    {% if show_todos %}
    <input type="hidden" name="show_todos" value="1">
    {% endif %}
    {% if roots %}
    <input type="hidden" name="roots" value="1">
    {% endif %}
    <input type="hidden" name="target_type" value="">
    <input type="hidden" name="target_id" value="">
  </form>

  <div class="toolbar">
    <form method="get" action="/html_no_js/tree">
      {# Only include root_list_id if it's actually set; avoids sending empty string #}
      {% if root_list_id is not none %}
      <input type="hidden" name="root_list_id" value="{{ root_list_id }}">
      {% endif %}
      {% if view_id is not none %}
      <input type="hidden" name="view_id" value="{{ view_id }}">
      {% endif %}
      {% if roots %}
      <input type="hidden" name="roots" value="1">
      {% endif %}
      <label style="display:inline-flex; align-items:center; gap:0.25rem;">
        <input type="checkbox" name="show_todos" value="1" {% if show_todos %}checked{% endif %}>
        <span>Show todos</span>
      </label>
      <label style="display:inline-flex; align-items:center; gap:0.25rem; margin-left:0.75rem;">
        <input type="checkbox" id="hide-completed-tree">
        <span>Hide completed</span>
      </label>
    </form>
    {% if roots %}
      <a class="btn" href="/html_no_js/tree{% if root_list_id is not none %}?root_list_id={{ root_list_id }}{% if show_todos %}&show_todos=1{% endif %}{% elif show_todos %}?show_todos=1{% endif %}" title="Show every node">Show all</a>
    {% else %}
      <a class="btn" href="/html_no_js/tree?roots=1{% if root_list_id is not none %}&root_list_id={{ root_list_id }}{% endif %}{% if show_todos %}&show_todos=1{% endif %}" title="Show only root nodes">Roots only</a>
    {% endif %}
    <button type="submit" class="btn" form="tree-bulk-move-form" title="Move selected to destination">Move</button>
    <span class="meta" aria-hidden="true">|</span>
    <label style="display:inline-flex; align-items:center; gap:0.25rem;">
      <span class="sr-only">Link direction</span>
      <select name="link_direction" form="tree-bulk-move-form" title="Link direction">
        <option value="">auto</option>
        <option value="selected_to_dest">selected ‚Üí dest</option>
        <option value="dest_to_selected">dest ‚Üí selected</option>
        <option value="both">both</option>
      </select>
    </label>
    <button type="submit" class="btn" form="tree-bulk-move-form" formaction="/html_no_js/tree/bulk_link" title="Create links using selected and destination">Link</button>
    <a class="btn" href="/html_no_js/linkmap" title="Open interactive link map">Link map</a>
    <span class="meta" aria-hidden="true">|</span>
    <label style="display:inline-flex; align-items:center; gap:0.25rem;">
      <input type="text" id="tree-view-name" placeholder="Save as view‚Ä¶" style="min-width:12rem;" />
    </label>
    <button type="button" class="btn" id="save-tree-view" title="Save selected checkboxes as a named view">Save view</button>
    <div class="dropdown" style="position:relative;">
      <button type="button" class="btn" id="manage-views-btn" aria-haspopup="true" aria-expanded="false">Views ‚ñæ</button>
      <div id="views-menu" class="menu" style="display:none; position:absolute; z-index:30; background:#fff; border:1px solid #e5e7eb; border-radius:0.25rem; padding:0.25rem; min-width:12rem;">
        <div class="meta" style="padding:0.25rem 0.5rem;">Loading‚Ä¶</div>
      </div>
    </div>
    {% if root_list_id %}
        <span class="meta" aria-hidden="true">|</span>
        <a class="btn" href="/html_no_js/tree{% if roots %}?roots=1{% endif %}" title="Back to top">Top</a>
        <span class="meta" aria-hidden="true">|</span>
        {% if root_parent_id is not none or root_parent_todo_id is not none %}
          {% if root_parent_id is not none %}
            {# If parent is a list: if it is top-level, go to root view and jump to its fragment; else recenter on that parent list and jump to fragment #}
            <a class="btn" href="/html_no_js/tree?root_list_id={{ root_parent_id }}{% if roots %}&roots=1{% endif %}{% if show_todos %}&show_todos=1{% endif %}#list-{{ root_parent_id }}" title="Up one level" aria-label="Up one level">Up one ‚¨Ü</a>
          {% elif root_parent_todo_id is not none %}
            {# Parent is a todo: navigate to the list that owns that todo and jump to the todo fragment #}
            {% if root_parent_todo_list_id %}
              <a class="btn" href="/html_no_js/tree?root_list_id={{ root_parent_todo_list_id }}{% if roots %}&roots=1{% endif %}{% if show_todos %}&show_todos=1{% endif %}#todo-{{ root_parent_todo_id }}" title="Up one level" aria-label="Up one level">Up one ‚¨Ü</a>
            {% else %}
              <a class="btn" href="/html_no_js/tree{% if roots or show_todos %}?{% endif %}{% if roots %}roots=1{% endif %}{% if roots and show_todos %}&{% endif %}{% if show_todos %}show_todos=1{% endif %}#todo-{{ root_parent_todo_id }}" title="Up one level" aria-label="Up one level">Up one ‚¨Ü</a>
            {% endif %}
          {% endif %}
        {% else %}
          {# We are on a page for a root list (no parent). Up should jump to that list's fragment on the root tree view. #}
          <a class="btn" href="/html_no_js/tree{% if roots or show_todos %}?{% endif %}{% if roots %}roots=1{% endif %}{% if roots and show_todos %}&{% endif %}{% if show_todos %}show_todos=1{% endif %}#list-{{ root_list_id }}" title="Up one level" aria-label="Up one level">Up one ‚¨Ü</a>
        {% endif %}
    {% endif %}
  </div>

  <h2>Tree{% if root_name %}: {{ root_name }}{% endif %}</h2>
  {% if view_mode %}
    <div class="meta" style="margin-top:-0.35rem; margin-bottom:0.5rem;">Saved view: <strong>{{ view_name }}</strong> ‚Äî selected nodes are roots of this view; their children are shown as usual.</div>
  {% endif %}
  {% if moved is not none or skipped is not none %}
    <div class="meta" style="margin-bottom:0.35rem;">
      {% if moved is not none %}Moved: {{ moved }}{% endif %}
      {% if skipped is not none %} &nbsp; Skipped: {{ skipped }}{% endif %}
    </div>
  {% endif %}

  {% macro render_node(node) %}
     <li id="list-{{ node.id }}">
      <input type="checkbox" class="tree-select" data-item-type="list" name="list_ids" value="{{ node.id }}" form="tree-bulk-move-form" title="Select list (double-click to set destination)">
      <span class="icon" aria-hidden="true" title="List">üìÇ</span>
    <a class="{% if node.completed %}done{% endif %}" href="/html_no_js/lists/{{ node.id }}">{% if node.completed %}<s>{{ node.name }}</s>{% else %}{{ node.name }}{% endif %}</a>
  <a class="btn recenter" style="margin-left:0.35rem;" href="/html_no_js/tree?root_list_id={{ node.id }}{% if roots %}&roots=1{% endif %}{% if show_todos %}&show_todos=1{% endif %}" title="Re-center tree to this list" aria-label="Re-center tree to this list">‚óé</a>
      {% if node.priority %}<span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(node.priority, node.priority) }}</span></span>{% endif %}
      {% if node.override_priority %}<span class="muted priority-inline priority-override" title="Secondary priority (max child todos/sublists)"><span class="priority-circle">{{ circ.get(node.override_priority, node.override_priority) }}</span></span>{% endif %}
      {% if node.hashtags and node.hashtags|length > 0 %}
        <span class="meta">{% for tag in (node.hashtags | sort) %}<a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}">{{ tag }}</a>{% endfor %}</span>
      {% endif %}
      {% if show_todos and node.todos and node.todos|length > 0 %}
        <ul class="tree">
          {% for t in node.todos %}
            <li>
              <input type="checkbox" class="tree-select" data-item-type="todo" name="todo_ids" value="{{ t.id }}" form="tree-bulk-move-form" title="Select todo (double-click to set destination)">
              <span class="icon" aria-hidden="true" title="Todo">üìù</span>
              <a id="todo-{{ t.id }}" class="{% if t.completed %}done{% endif %}" href="/html_no_js/todos/{{ t.id }}">{% if t.completed %}<s>{{ t.text }}</s>{% else %}{{ t.text }}{% endif %}</a>
              {% if t.priority %}<span class="meta priority-inline" title="Priority {{ t.priority }}" style="margin-left:0.35rem;"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>{% endif %}
              {% if t.child_lists and t.child_lists|length > 0 %}
                <ul class="tree">
                  {% for sub in t.child_lists %}
                    {{ render_node(sub) }}
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if node.children and node.children|length > 0 %}
        <ul class="tree">
          {% for child in node.children %}
            {{ render_node(child) }}
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% endmacro %}

  {% if view_mode %}
    {# Render a saved view: lists as root nodes; todos are shown with their child lists #}
    {% if (view_list_roots and view_list_roots|length > 0) or (view_todo_roots and view_todo_roots|length > 0) %}
      {% if view_list_roots and view_list_roots|length > 0 %}
        <ul class="tree">
          {% for node in view_list_roots %}
            {{ render_node(node) }}
          {% endfor %}
        </ul>
      {% endif %}
      {% if view_todo_roots and view_todo_roots|length > 0 %}
        <h3 class="muted" style="margin-top:0.75rem;">Todos</h3>
        <ul class="tree">
          {% for t in view_todo_roots %}
            <li>
              <input type="checkbox" class="tree-select" data-item-type="todo" name="todo_ids" value="{{ t.id }}" form="tree-bulk-move-form" title="Select todo (double-click to set destination)">
              <span class="icon" aria-hidden="true" title="Todo">üìù</span>
              <a id="todo-{{ t.id }}" class="{% if t.completed %}done{% endif %}" href="/html_no_js/todos/{{ t.id }}">{% if t.completed %}<s>{{ t.text }}</s>{% else %}{{ t.text }}{% endif %}</a>
              {% if t.priority %}<span class="meta priority-inline" title="Priority {{ t.priority }}" style="margin-left:0.35rem;"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>{% endif %}
              {% if t.child_lists and t.child_lists|length > 0 %}
                <ul class="tree">
                  {% for sub in t.child_lists %}
                    {{ render_node(sub) }}
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <div class="meta">This view is empty.</div>
    {% endif %}
  {% elif root_list_id %}
    {# Focused on a specific root list; render the regular tree #}
    {% if tree and tree|length > 0 %}
      <ul class="tree">
        {% for node in tree %}
          {{ render_node(node) }}
        {% endfor %}
      </ul>
    {% else %}
      <div class="meta">No lists to display.</div>
    {% endif %}
  {% else %}
    {# Top-level: render categories (collapsible) with lists inside; no checkbox or recenter on category headers #}
    {% set uncats = (tree_by_category.get(0, []) if tree_by_category is defined else []) %}
    {% if uncats and uncats|length > 0 %}
      <section class="category-section" data-category-id="uncategorized" style="margin-bottom:0.5rem;">
        <h3 class="category-header" data-target="cat-uncat" style="cursor:pointer; user-select:none;">
          <span class="twisty" aria-hidden="true">‚ñæ</span>
          <span class="category-name">Uncategorized</span>
          <span class="count muted"> ({{ uncats|length }})</span>
        </h3>
        <ul id="cat-uncat" class="tree">
          {% for node in uncats %}
            {{ render_node(node) }}
          {% endfor %}
        </ul>
      </section>
    {% endif %}
    {% if categories is defined and categories and categories|length > 0 %}
      {% for cat in categories %}
        {% set cat_lists = tree_by_category.get(cat.id, []) if tree_by_category is defined else [] %}
        {% if cat_lists and cat_lists|length > 0 %}
          <section class="category-section" data-category-id="{{ cat.id }}" style="margin-bottom:0.5rem;">
            <h3 class="category-header" data-target="cat-{{ cat.id }}" style="cursor:pointer; user-select:none;">
              <span class="twisty" aria-hidden="true">‚ñæ</span>
              <span class="category-name">{{ cat.name }}</span>
              <span class="count muted"> ({{ cat_lists|length }})</span>
            </h3>
            <ul id="cat-{{ cat.id }}" class="tree">
              {% for node in cat_lists %}
                {{ render_node(node) }}
              {% endfor %}
            </ul>
          </section>
        {% endif %}
      {% endfor %}
    {% else %}
      {% if not (uncats and uncats|length > 0) %}
        <div class="meta">No lists to display.</div>
      {% endif %}
    {% endif %}
    <script>
      (function(){
        function toggleDetails(h){
          try {
            var target = h.getAttribute('data-target');
            var ul = document.getElementById(target);
            if (!ul) return;
            var tw = h.querySelector('.twisty');
            var isOpen = ul.style.display !== 'none';
            ul.style.display = isOpen ? 'none' : '';
            if (tw) tw.textContent = isOpen ? '‚ñ∏' : '‚ñæ';
          } catch(e) {}
        }
        var headers = document.querySelectorAll('.category-header');
        headers.forEach(function(h){
          h.addEventListener('click', function(){ toggleDetails(h); });
        });
      })();
    </script>
  {% endif %}
  <script src="/static/js/tree.js"></script>
  <script>
    (function(){
      // auto-submit Show todos toggle
      try {
        var form = document.querySelector('.toolbar form[action="/html_no_js/tree"]');
        var toggler = form ? form.querySelector('input[name="show_todos"]') : null;
        if (toggler && form){
          toggler.addEventListener('change', function(){ form && form.submit(); });
        }
      } catch(e) { /* ignore */ }
      var key = 'tree_hide_completed';
      var cb = document.getElementById('hide-completed-tree');
      if (!cb) return;
      try {
        var saved = (typeof localStorage !== 'undefined') ? localStorage.getItem(key) : null;
        cb.checked = (saved === '1');
      } catch(e) {}

      function isCompletedAnchor(a){
        try { return !!(a && a.classList && a.classList.contains('done')); } catch(e){ return false; }
      }
      function applyHide(){
        var hide = !!cb.checked;
        try { if (typeof localStorage !== 'undefined') localStorage.setItem(key, hide ? '1' : '0'); } catch(e) {}
        // Handle list items
        var listLis = Array.prototype.slice.call(document.querySelectorAll('ul.tree > li'));
        listLis.forEach(function(li){
          try {
            // a list node li has a link to /html_no_js/lists/<id>
            var a = li.querySelector('a[href^="/html_no_js/lists/"]');
            var completed = isCompletedAnchor(a);
            // hide/show the li if completed and hide flag
            li.style.display = (hide && completed) ? 'none' : '';
            // additionally, if parent is completed and hide is on, hide its nested children ul even if parent itself is visible
            var childUls = Array.prototype.slice.call(li.querySelectorAll(':scope > ul.tree'));
            childUls.forEach(function(ul){ ul.style.display = (hide && completed) ? 'none' : ''; });
          } catch(e){}
        });
        // Handle todo items
        var todoLis = Array.prototype.slice.call(document.querySelectorAll('li > a[id^="todo-"]'))
          .map(function(a){ return a && a.closest('li'); })
          .filter(function(li){ return !!li; });
        // Views dropdown
        var btn = document.getElementById('manage-views-btn');
        var menu = document.getElementById('views-menu');
        function fetchViews(){
          if (!menu) return;
          fetch('/html_no_js/tree/views', { credentials:'same-origin' })
            .then(function(r){ return r.json(); })
            .then(function(data){
              var html = '';
              if (data && data.ok && data.views && data.views.length){
                html += '<ul style="list-style:none; padding:0; margin:0;">';
                data.views.forEach(function(v){
                  var q = '?view_id=' + encodeURIComponent(v.id)
                        + ({% if root_list_id is not none %}'&root_list_id={{ root_list_id }}'{% else %}''{% endif %})
                        + ({% if show_todos %}'&show_todos=1'{% else %}''{% endif %})
                        + ({% if roots %}'&roots=1'{% else %}''{% endif %});
                  html += '<li style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem; padding:0.25rem 0.5rem;">'
                       +  '<a href="/html_no_js/tree' + q + '" class="btn" style="flex:1; text-align:left;">' + v.name.replace(/</g,'&lt;') + '</a>'
                       +  '<button type="button" data-id="' + v.id + '" class="btn danger delete-view" title="Delete view">‚úï</button>'
                       +  '</li>';
                });
                html += '</ul>';
              } else {
                html = '<div class="meta" style="padding:0.25rem 0.5rem;">No saved views.</div>';
              }
              menu.innerHTML = html;
              Array.prototype.slice.call(menu.querySelectorAll('.delete-view')).forEach(function(b){
                b.addEventListener('click', function(){
                  var id = b.getAttribute('data-id');
                  if (!id) return;
                  fetch('/html_no_js/tree/views/' + id, { method:'DELETE', credentials:'same-origin' })
                    .then(function(r){ return r.json(); })
                    .then(function(){ fetchViews(); });
                });
              });
            })
            .catch(function(){ menu.innerHTML = '<div class="meta" style="padding:0.25rem 0.5rem;">Failed to load.</div>'; });
        }
        if (btn && menu){
          btn.addEventListener('click', function(){
            var isOpen = menu.style.display !== 'none';
            menu.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) fetchViews();
          });
          document.addEventListener('click', function(ev){ if (!menu.contains(ev.target) && ev.target !== btn){ menu.style.display = 'none'; } });
        }
        // Save view action
        var saveBtn = document.getElementById('save-tree-view');
        var nameInput = document.getElementById('tree-view-name');
        function collectSelected(){
          var listIds = []; var todoIds = [];
          Array.prototype.slice.call(document.querySelectorAll('input.tree-select:checked')).forEach(function(cb){
            var typ = cb.getAttribute('data-item-type');
            var val = cb.value;
            if (!typ || !val) return;
            if (typ === 'list') listIds.push(parseInt(val,10));
            else if (typ === 'todo') todoIds.push(parseInt(val,10));
          });
          return { list_ids: listIds, todo_ids: todoIds };
        }
        function getCSRF(){ try { return document.querySelector('input[name="_csrf"]').value; } catch(e){ return null; } }
        if (saveBtn){
          saveBtn.addEventListener('click', function(){
            var nm = nameInput ? (nameInput.value || '').trim() : '';
            if (!nm) { alert('Enter a view name'); return; }
            var sel = collectSelected();
            if ((!sel.list_ids || !sel.list_ids.length) && (!sel.todo_ids || !sel.todo_ids.length)){
              alert('Select at least one list or todo');
              return;
            }
            fetch('/html_no_js/tree/save_view', {
              method:'POST', credentials:'same-origin',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ name: nm, list_ids: sel.list_ids, todo_ids: sel.todo_ids })
            }).then(function(r){ return r.json(); }).then(function(data){
              if (data && data.ok){
                nameInput.value = '';
                // Refresh views menu if open
                if (menu && menu.style.display !== 'none') fetchViews();
              } else {
                alert('Failed to save view' + (data && data.error ? ': ' + data.error : ''));
              }
            }).catch(function(){ alert('Failed to save view'); });
          });
        }
        todoLis.forEach(function(li){
          try {
            var a = li.querySelector('a[id^="todo-"]');
            var completed = isCompletedAnchor(a);
            li.style.display = (hide && completed) ? 'none' : '';
            // hide child sublists under a completed todo when hide enabled
            var childUls = Array.prototype.slice.call(li.querySelectorAll(':scope > ul.tree'));
            childUls.forEach(function(ul){ ul.style.display = (hide && completed) ? 'none' : ''; });
          } catch(e){}
        });
      }
      cb.addEventListener('change', applyHide);
      // initial
      applyHide();
    })();
  </script>
{% endblock %}
