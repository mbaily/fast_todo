{% extends 'base.html' %}
{% block title %}Search results ‚Äî Fast Todo (no-js){% endblock %}
{% block content %}
  <style>
    /* ensure completed list titles in search results show strike-through */
      .combined-list .list-title.done { text-decoration: line-through; color: #6b7280; }
  </style>
  <h2>Search results for "{{ q }}"</h2>
  {% if mode in ['lists','todos'] %}
    <p class="muted" style="margin:0.25rem 0 0.5rem;">Mode: {% if mode=='lists' %}Lists only{% elif mode=='todos' %}Todos only{% endif %}</p>
  {% endif %}
  <form method="get" action="/html_no_js/search" style="margin-bottom:0.75rem">
    <input type="text" name="q" value="{{ q }}" placeholder="Search" style="min-width:16rem">
    <label style="margin-left:0.5rem"><input type="checkbox" name="include_list_todos" value="1" {% if include_list_todos %}checked{% endif %}> include todos from matching lists</label>
  <label style="margin-left:0.5rem">
    <input type="hidden" name="exclude_completed" value="0">
    <input type="checkbox" name="exclude_completed" value="1" {% if exclude_completed is not defined %}checked{% elif exclude_completed %}checked{% endif %}> exclude completed
  </label>
  <label style="margin-left:0.5rem">
    <input type="hidden" name="priority_sort" value="0">
    <input id="priority-sort-checkbox" type="checkbox" name="priority_sort" value="1" {% if priority_sort %}checked{% endif %}> sort by priority
  </label>
    <button type="submit" style="margin-left:0.5rem">Search</button>
  </form>
  {% if results.combined and results.combined|length > 0 %}
    <h3>Matching items</h3>
  <ul class="combined-list" style="list-style:none; padding-left:0;">
      {% for it in results.combined %}
        {% if it.type == 'list' %}
          <li class="list-item" style="margin:0.25rem 0;">
            <div class="list-main">
              <span class="list-inline">
                  <span class="match-icon">üìÅ</span>
                  {% if it.trashed %}<span class="ml-1" title="In Trash">üóëÔ∏è</span>{% endif %}
                  <a class="list-title {% if it.completed %}done{% endif %}" href="/html_no_js/lists/{{ it.id }}">{{ it.name }}</a>
                <a class="list-action-btn recenter" href="/html_no_js/tree?root_list_id={{ it.id }}" title="Open tree centered on this list" aria-label="Open tree centered on this list" style="margin-left:0.25rem;">‚óé</a>
                {% if it.priority %}
                  <span class="meta priority-inline" title="List priority {{ it.priority }}" style="margin-left:0.5rem;"><span class="priority-circle">{{ circ.get(it.priority, it.priority) }}</span></span>
                {% endif %}
                {% if it.tags and it.tags|length > 0 %}
                  {% for tag in (it.tags | sort) %}
                    <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}">{{ tag }}</a>
                  {% endfor %}
                {% endif %}
              </span>
            </div>
          </li>
        {% else %}
          <li class="todo" style="margin:0.25rem 0;">
            <span class="match-icon">üìù</span>
            <div class="todo-content">
              <div class="todo-main">
                <span class="todo-inline">
                  {% if it.trashed %}<span class="mr-1" title="In Trash">üóëÔ∏è</span>{% endif %}
                  <a href="/html_no_js/todos/{{ it.id }}" class="{% if it.completed %}done{% endif %}">{{ it.text }}</a>
                  {% if it.priority %}
                    <span class="meta priority-inline" title="Priority {{ it.priority }}" style="margin-left:0.5rem;"><span class="priority-circle">{{ circ.get(it.priority, it.priority) }}</span></span>
                  {% endif %}
                  {% if it.tags and it.tags|length > 0 %}
                    {% for tag in (it.tags | sort) %}
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}">{{ tag }}</a>
                    {% endfor %}
                  {% endif %}
                  {% if it.note %}
                    <span class="meta note-text">{{ it.note }}</span>
                    <span class="meta">in <a href="/html_no_js/lists/{{ it.list_id }}">{{ it.list_name or it.list_id }}</a></span>
                  {% endif %}
                </span>
              </div>
            </div>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}

  <p><a href="/html_no_js/">Back to lists</a></p>
  <script>
    (function(){
      try {
        var KEY = 'html_no_js_search_priority_sort';
        var cb = document.getElementById('priority-sort-checkbox');
        if (!cb) return;
        // Initialize from localStorage if query param missing
        var params = new URLSearchParams(window.location.search);
        if (!params.has('priority_sort')) {
          var saved = localStorage.getItem(KEY);
          if (saved === '0' || saved === '1') {
            cb.checked = (saved === '1');
          }
        }
        cb.addEventListener('change', function(){
          try { localStorage.setItem(KEY, cb.checked ? '1' : '0'); } catch(e) {}
        });
      } catch (e) { /* no-op */ }
    })();
  </script>
{% endblock %}
