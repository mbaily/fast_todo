<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lists ‚Äî Fast Todo (iOS)</title>
    <style>
      /* Minimal dark mode for the standalone template */
      :root { color-scheme: dark; }
      html, body { background: #0b0b0b; color: #e5e7eb; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      a { color: #60a5fa; }
      h1, h2, h3 { color: #f8fafc; margin: 0 0 0.5rem 0; }
  ul { padding-left: 0; list-style: none; margin: 0; }
      li { padding: 0.25rem 0; }
      input, button { background: #111827; color: #e5e7eb; border: 1px solid #374151; padding: 0.35rem 0.5rem; border-radius: 4px; }
      input::placeholder { color: #9ca3af; }
      button { cursor: pointer; }
      nav a { color: #9ae6ff; margin-right: 0.5rem; }
      .muted { color: #9ca3af; }
  /* strike-through for completed items */
  .done { text-decoration: line-through; color: #9ca3af; }
  /* priority glyphs (circled numbers) shown inline with list titles */
  .priority-inline { display: inline-block; margin-left: 0.35rem; vertical-align: middle; }
  .priority-circle { font-size: 2em; line-height: 1; }
  .priority-override .priority-circle { color: #ffb86b; font-size: 2em; }
  /* category lists: align flush under headers (no indent/bullets) */
  .category-lists { list-style: none; padding-left: 0; margin-left: 0; }
  /* high-priority: present as compact unbulleted list like pinned section */
  .high-priority ul { list-style: none; padding-left: 0; margin-left: 0; }
  /* count for uncompleted todos */
    .count-circle { font-size: 1rem; line-height: 1; }
  /* override/secondary priority marker: use a distinct accent; same absolute size as primary */
    .count-circle.colour { color: #ff002b; font-size: 1.25rem; }
    </style>
    <script src="/static/no_js/log.js"></script>
  </head>
  <body>
  
 

    {% if high_priority_items and high_priority_items|length > 0 %}
      <h3 style="margin-top:0">High priority</h3>
      <ul style="padding-left: 0; list-style: none; margin: 0 0 0.5rem 0;">
        {% for item in high_priority_items %}
          <li>
            {% set circ = {0:'‚ì™',1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
            {% if item.kind == 'todo' %}
              <a class="wrap-text{% if item.completed %} done{% endif %}" href="/html_no_js/todos/{{ item.id }}">{{ item.text }}</a>
              {% if item.effective_priority is not none %}<span class="muted priority-inline"><span class="priority-circle">{{ circ.get(item.effective_priority, item.effective_priority) }}</span></span>{% endif %}
              <span> in <a href="/html_no_js/lists/{{ item.list_id }}">{{ item.list_name or item.list_id }}</a></span>
            {% else %}
              <a href="/html_no_js/lists/{{ item.id }}">{{ item.name }}</a>
              {% if item.effective_priority is not none %}<span class="muted priority-inline priority-override"><span class="priority-circle">{{ circ.get(item.effective_priority, item.effective_priority) }}</span></span>{% endif %}
              {% if item.uncompleted_count is not none %}<span class="count-circle colour">{{ item.uncompleted_count }}</span>{% endif %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% elif (high_priority_todos and high_priority_todos|length > 0) or (high_priority_lists and high_priority_lists|length > 0) %}
      <h3 style="margin-top:0">High priority</h3>
      <ul style="padding-left: 0; list-style: none; margin: 0 0 0.5rem 0;">
        {% for t in high_priority_todos %}
          {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
          <li>
            <a class="wrap-text" href="/html_no_js/todos/{{ t.id }}">{{ t.text }}</a>
            {% if t.priority %}<span class="muted priority-inline"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>{% endif %}
            <span> in <a href="/html_no_js/lists/{{ t.list_id }}">{{ t.list_name or t.list_id }}</a></span>
          </li>
        {% endfor %}
        {% for lst in high_priority_lists %}
          {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
          <li>
            <a href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
            {% set eff = lst.override_priority if (lst.override_priority is not none and (lst.priority is none or lst.override_priority > lst.priority)) else lst.priority %}
            {% if eff %}<span class="muted priority-inline priority-override"><span class="priority-circle">{{ circ.get(eff, eff) }}</span></span>{% endif %}
            {% if lst.uncompleted_count is not none %}<span class="count-circle colour">{{ lst.uncompleted_count }}</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if pinned_todos and pinned_todos|length > 0 %}
  <!-- <h3 style="margin-top:0">Pinned</h3> -->
  <ul style="padding-left: 0; list-style: none; margin: 0;">
      {% for t in (pinned_todos | sort(attribute='modified_at') | reverse) %}
        <li>
          {{ 'üìå' if t.pinned|default(false) else 'üìç' }}
          <a class="wrap-text{% if t.completed %} done{% endif %}" href="/html_no_js/todos/{{ t.id }}">{{ t.text }}</a>
          {% if t.priority %}
            {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
            <span class="muted priority-inline"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>
          {% endif %}
          <span> in <a href="/html_no_js/lists/{{ t.list_id }}">{{ t.list_name or t.list_id }}</a></span>
          {% if t.tags and t.tags|length > 0 %}
            {% for tag in (t.tags | sort) %}
              &nbsp;<a href="/html_no_js/search?q={{ tag|urlencode }}" style="background:#012383;color:#ffffff;border-radius:999px;text-decoration:none;font-size:0.95em;">{{ tag }}</a>
            {% endfor %}
          {% endif %}
        </li>
      {% endfor %}
  </ul>
    {% endif %}

    {% if pinned_lists and pinned_lists|length > 0 %}
    <!-- <h3 style="margin-top:0.5rem">Pinned Lists</h3> -->
    <ul style="padding-left: 0; list-style: none; margin: 0;">
      {% for lst in (pinned_lists | sort(attribute='name', case_sensitive=false)) %}
        <li>
          üìå <a href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
        </li>
      {% endfor %}
    </ul>
    {% endif %}

    {% if (bookmarked_todos and bookmarked_todos|length > 0) or (bookmarked_lists and bookmarked_lists|length > 0) %}
    <!-- <h3 style="margin-top:0.5rem">Bookmarks</h3> -->
    {% if bookmarked_todos and bookmarked_todos|length > 0 %}
    <ul style="padding-left: 0; list-style: none; margin: 0;">
      {% for t in (bookmarked_todos | sort(attribute='text', case_sensitive=false)) %}
        <li>
          üîñ <a class="wrap-text{% if t.completed %} done{% endif %}" href="/html_no_js/todos/{{ t.id }}">{{ t.text }}</a>
          {% if t.priority %}
            {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
            <span class="muted priority-inline"><span class="priority-circle">{{ circ.get(t.priority, t.priority) }}</span></span>
          {% endif %}
          <span> in <a href="/html_no_js/lists/{{ t.list_id }}">{{ t.list_name or t.list_id }}</a></span>
          {% if t.tags and t.tags|length > 0 %}
            {% for tag in (t.tags | sort) %}
              &nbsp;<a href="/html_no_js/search?q={{ tag|urlencode }}" style="background:#012383;color:#ffffff;border-radius:999px;text-decoration:none;font-size:0.95em;">{{ tag }}</a>
            {% endfor %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% if bookmarked_lists and bookmarked_lists|length > 0 %}
    <ul style="padding-left: 0; list-style: none; margin: 0;">
      {% for lst in (bookmarked_lists | sort(attribute='name', case_sensitive=false)) %}
        <li>
          üîñ <a href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
        </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endif %}

    {# Moved Calendar summary to appear directly under pinned todos #}
    {% if calendar_occurrences and calendar_occurrences|length > 0 %}
      <!--<h3 style="margin-top:1rem">Calendar</h3>-->
      <ul style="padding-left:0; list-style:none; margin:0 0 1rem 0;">
        {% for ev in calendar_occurrences %}
          <li>
            <strong>{{ ev.occurrence_date or ev.occurrence_dt[:10] }}</strong>
            &nbsp; <a href="{% if ev.item_type == 'todo' %}/html_no_js/todos/{{ ev.id }}{% else %}/html_no_js/lists/{{ ev.id }}{% endif %}">{{ ev.title or (ev.rrule or '')[:60] }}</a>
            {% if ev.item_type == 'todo' and ev.priority %}
              {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
              <span class="muted priority-inline"><span class="priority-circle">{{ circ.get(ev.priority, ev.priority) }}</span></span>
            {% endif %}
            {% if ev.is_recurring %}<span class="muted"> (recurring)</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

        <form id="index-search-form" method="get" action="/html_no_js/search" style="margin:0.6rem 0; display:flex; gap:0.5rem; align-items:center;">
      {% if csrf_token %}
        <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      {% endif %}
      <input id="index-search-q" name="q" placeholder="Search" aria-label="Search" style="flex:1 1 auto; min-width:0;">
      <input id="index-search-mode" type="hidden" name="mode" value="normal">
      <button id="index-search-mode-btn" type="button" aria-label="Toggle search mode" title="Toggle search mode" style="min-width:2.5rem;">‚óè</button>
      <button type="submit">Search</button>
    </form>
    <script>
    (function(){
      var form = document.getElementById('index-search-form'); if (!form) return;
      var btn = document.getElementById('index-search-mode-btn');
      var hid = document.getElementById('index-search-mode');
      var q = document.getElementById('index-search-q');
      var MODES = [
        { key: 'normal', label: '‚óè', color: '#444', title: 'Normal search' },
        { key: 'lists',  label: 'L', color: '#10b981', title: 'Lists only' },
        { key: 'todos',  label: 'T', color: '#7c3aed', title: 'Todos only' }
      ];
      function setMode(idx){
        try{
          var m = MODES[idx];
          hid.value = m.key;
          btn.textContent = m.label;
          btn.style.background = m.color;
          btn.style.color = '#fff';
          btn.title = m.title;
          btn.setAttribute('aria-label', m.title);
          localStorage.setItem('ft_search_mode', m.key);
        }catch(e){}
      }
      function getIndexByKey(k){ for (var i=0;i<MODES.length;i++){ if (MODES[i].key===k) return i; } return 0; }
      var saved = null; try{ saved = localStorage.getItem('ft_search_mode'); }catch(e){}
      var idx = getIndexByKey(saved||'normal');
      setMode(idx);
      btn.addEventListener('click', function(){ idx = (idx+1) % MODES.length; setMode(idx); });
      form.addEventListener('submit', function(){ try{ if (!q.value) q.focus(); }catch(e){} });
    })();
    </script>

        <form method="post" action="/html_no_js/lists/create">
      {% if csrf_token %}
        <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      {% endif %}
      <input name="name" placeholder="List name" required>
      {% if user_default_category_id is defined and user_default_category_id is not none %}
      <input type="hidden" name="category_id" value="{{ user_default_category_id }}">
      {% else %}
      <input type="hidden" name="category_id" value="">
      {% endif %}
      <button type="submit">Create</button>
    </form>

    {% if recent_lists_24h and recent_lists_24h|length > 0 %}
    <div class="meta" style="margin:0.35rem 0 0.6rem;">
      <strong>üïí Created in last 24h:</strong>
      <ul style="list-style:none; padding-left:0; margin:0.25rem 0 0; display:flex; gap:0.75rem; flex-wrap:wrap;">
        {% for r in recent_lists_24h %}
          <li style="display:inline-flex; align-items:center; gap:0.25rem;">
            <span aria-hidden="true" title="Created in last 24h">üïí</span>
            <a href="/html_no_js/lists/{{ r.id }}" title="Created {{ r.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}">{{ r.name }}</a>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Quick add todo for iOS standalone -->
    <form id="quick-add-form" autocomplete="off" style="margin:0.6rem 0; display:flex; gap:0.5rem; align-items:center;">
      {% if csrf_token %}
        <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      {% endif %}
      <input id="quick-add-text" placeholder="Quick todo" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" style="flex:1 1 auto; min-width:0;">
      <button id="quick-add-btn" type="button">Add</button>
    </form>
    <script>
    (function(){
      var form = document.getElementById('quick-add-form'); if (!form) return;
      var input = document.getElementById('quick-add-text'); var btn = document.getElementById('quick-add-btn');
      try{
        var pending = sessionStorage.getItem('ft_quick_pending');
        if (pending){
          (async function(pt){
            try{
              var tryId = await findQuickListId();
              if (tryId){
                await fetch('/todos', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ text: pt, list_id: tryId, priority: 7 }) });
              }
            }catch(e){}
            try { sessionStorage.removeItem('ft_quick_pending'); } catch(e){}
          })(pending);
        }
      }catch(e){}
      async function findQuickListId(){
        try{
          var anchors = Array.from(document.querySelectorAll('a[href^="/html_no_js/lists/"]'));
          for (var i=0;i<anchors.length;i++){ var a = anchors[i]; if ((a.textContent||'').trim() === 'Quick'){
              var m = (a.getAttribute('href')||'').match(/\/(?:html_no_js\/)?lists\/(\d+)/);
              if (m) return Number(m[1]);
          }}
        }catch(e){}
        return null;
      }
      btn.addEventListener('click', async function(){
        var text = input.value && input.value.trim(); if (!text) return;
        btn.disabled = true;
        try{
          var listId = await findQuickListId();
          if (!listId){
            try{
              var res = await fetch('/lists', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ name: 'Quick' }) });
              if (res && res.ok){ try{ var j = await res.json(); listId = j && j.id; } catch(e){} }
            }catch(e){}
          }
          if (!listId){
            try{
              try { sessionStorage.setItem('ft_quick_pending', text); } catch(e){}
              var formBody = new URLSearchParams(); formBody.append('name','Quick');
              var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) formBody.append('_csrf', csrf.value);
              await fetch('/html_no_js/lists/create', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody.toString() });
              try { window.location.reload(); return; } catch(e){}
            }catch(e){}
          }
          if (!listId) throw new Error('could not determine Quick list id');
          var tres = await fetch('/todos', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ text: text, list_id: listId, priority: 7 }) });
          // Parse response as text, then JSON if possible, mirroring index.html
          var todo = null;
          try {
            var ttxt = await tres.text();
            try { todo = JSON.parse(ttxt); } catch(_) { todo = null; }
            if (!tres.ok) throw new Error('create todo failed status=' + tres.status);
          } catch(e) { throw e; }
          input.value = '';
          input.focus();
          // Log quick add with item_id so logs page can link to the todo
          try{ if (window.ftLog){ window.ftLog('Added quick todo', { item_type: 'todo', item_id: (todo && todo.id) ? Number(todo.id) : null, label: String(text||'') }); } }catch(_){ }
          try { window.location.reload(); } catch(e){}
        }catch(err){ console && console.error && console.error('Quick add failed', err); try{ alert('Add failed'); }catch(_){}}
        finally{ btn.disabled = false; }
      }, false);
    })();
    </script>
    <script>
    // Log list creation on iOS index
    (function(){
      try{
        var form = document.querySelector('form[action="/html_no_js/lists/create"]'); if (!form) return;
        form.addEventListener('submit', function(){
          try{
            var nameInput = form.querySelector('input[name="name"]');
            var v = nameInput && nameInput.value ? String(nameInput.value) : '';
            if (v){
              var payload = { message: 'Added list', item_type: 'list', item_id: null, url: (window.location ? window.location.href : null), label: v.trim() };
              try{ if (navigator && navigator.sendBeacon){ var blob = new Blob([JSON.stringify(payload)], { type: 'application/json' }); navigator.sendBeacon('/html_no_js/logs', blob); }
                else if (window.ftLog){ window.ftLog('Added list', { item_type: 'list', item_id: null, label: v.trim() }); } }
              catch(_){ try{ if (window.ftLog) window.ftLog('Added list', { item_type: 'list', item_id: null, label: v.trim() }); }catch(__){} }
            }
          }catch(_){ }
        }, false);
      }catch(e){}
    })();
    </script>

    {% if cursors %}
      <nav>
        {% if cursors.has_prev %}
          <a href="?dir=prev&cursor_created_at={{ cursors.prev_cursor_created_at|urlencode }}&cursor_id={{ cursors.prev_cursor_id }}">&laquo; Newer</a>
        {% endif %}
        {% if cursors.has_next %}
          <a href="?dir=next&cursor_created_at={{ cursors.next_cursor_created_at|urlencode }}&cursor_id={{ cursors.next_cursor_id }}">Older &raquo;</a>
        {% endif %}
      </nav>
    {% endif %}

    <ul>
    {# Uncategorized (no category) - render first so it appears at the top #}
  {% set uncats = lists_by_category.get(0, []) %}
    {% if uncats and uncats|length > 0 %}
      <li class="category-section" data-category-id="uncategorized">
        <h3 class="category-header" data-target="ios-cat-uncat" style="cursor:pointer; user-select:none;">
          <span class="twisty" aria-hidden="true">‚ñæ</span>
          <span class="category-name">Uncategorized</span>
          <span class="count muted"> ({{ uncats|length }})</span>
        </h3>
        <ul id="ios-cat-uncat" class="category-lists">
          {% for lst in uncats %}
            {% set created_iso = lst.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
            {% set modified_iso = lst.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if lst.modified_at else None %}
            {# effective priority: consider override_priority when present and higher than list.priority #}
            {% set eff = lst.override_priority if (lst.override_priority is not none and (lst.priority is none or lst.override_priority > lst.priority)) else lst.priority %}
            <li{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %} data-priority="{{ eff if eff is not none else '' }}">
              <a class="{% if lst.completed %}done{% endif %}" href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
              {% if lst.uncompleted_count is not none and not (lst.hide_icons|default(false)) %}
                <span class="count-circle colour" title="{{ lst.uncompleted_count }} uncompleted todos">{{ lst.uncompleted_count }}</span>
              {% endif %}
              <!--<button type="button" class="edit-list-btn" data-list-id="{{ lst.id }}" data-list-name="{{ lst.name|e }}" title="Edit list name" style="background:none;border:none;color:inherit;padding:0;margin-left:0.25rem;cursor:pointer;">‚úèÔ∏è</button>-->
              {% if lst.priority %}
                {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
                <span class="muted priority-inline"><span class="priority-circle">{{ circ.get(lst.priority, lst.priority) }}</span></span>
              {% endif %}
              {% if lst.override_priority and (lst.priority is none or lst.override_priority > lst.priority) %}
                <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(lst.override_priority, lst.override_priority) }}</span></span>
              {% endif %}
              {% if lst.created_at %}<span class="muted"> cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</span>{% endif %}
              {% if lst.combined is defined and lst.combined is not none %}
                {% set combined = lst.combined %}
              {% else %}
                {% set combined = lst.hashtags or [] %}
              {% endif %}
              <div class="all-tags-inline" data-list-id="{{ lst.id }}" data-list-tags='{{ combined | tojson }}' aria-hidden="{{ 'false' if combined and combined|length > 0 else 'true' }}" style="display:inline-block;margin-left:0.5rem;">
                {% if combined and combined|length > 0 %}
                  {% for tag in (combined | sort) %}
                    &nbsp;<a href="/html_no_js/search?q={{ tag|urlencode }}" style="background:#012383;color:#ffffff;border-radius:999px;text-decoration:none;font-size:0.95em;">{{ tag }}</a>
                  {% endfor %}
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </li>
    {% endif %}

    {# Group by categories with collapsible sections #}
    {% for cat in categories %}
  {% set cat_lists = lists_by_category.get(cat.id, []) %}
      {% if cat_lists and cat_lists|length > 0 %}
        <li class="category-section" data-category-id="{{ cat.id }}">
          <h3 class="category-header" data-target="ios-cat-{{ cat.id }}" style="cursor:pointer; user-select:none;">
            <span class="twisty" aria-hidden="true">‚ñæ</span>
            <span class="category-name">{{ cat.name }}</span>
            <span class="count muted"> ({{ cat_lists|length }})</span>
          </h3>
          <ul id="ios-cat-{{ cat.id }}" class="category-lists">
            {% for lst in cat_lists %}
                {% set created_iso = lst.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
                {% set modified_iso = lst.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if lst.modified_at else None %}
                {# effective priority: consider override_priority when present and higher than list.priority #}
                {% set eff = lst.override_priority if (lst.override_priority is not none and (lst.priority is none or lst.override_priority > lst.priority)) else lst.priority %}
                <li{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %} data-priority="{{ eff if eff is not none else '' }}">
                  <a class="{% if lst.completed %}done{% endif %}" href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
                  {% if lst.uncompleted_count is not none and not (lst.hide_icons|default(false)) %}
                    <span class="count-circle colour" title="{{ lst.uncompleted_count }} uncompleted todos">{{ lst.uncompleted_count }}</span>
                  {% endif %}
                  <!--<button type="button" class="edit-list-btn" data-list-id="{{ lst.id }}" data-list-name="{{ lst.name|e }}" title="Edit list name" style="background:none;border:none;color:inherit;padding:0;margin-left:0.25rem;cursor:pointer;">‚úèÔ∏è</button>-->
                  {% if lst.priority %}
                    {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
                    <span class="muted priority-inline"><span class="priority-circle">{{ circ.get(lst.priority, lst.priority) }}</span></span>
                  {% endif %}
                  {% if lst.override_priority and (lst.priority is none or lst.override_priority > lst.priority) %}
                    <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(lst.override_priority, lst.override_priority) }}</span></span>
                  {% endif %}
                  {% if lst.created_at %}<span class="muted"> cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</span>{% endif %}
                  {% if lst.combined is defined and lst.combined is not none %}
                    {% set combined = lst.combined %}
                  {% else %}
                    {% set combined = lst.hashtags or [] %}
                  {% endif %}
                  <div class="all-tags-inline" data-list-id="{{ lst.id }}" data-list-tags='{{ combined | tojson }}' aria-hidden="{{ 'false' if combined and combined|length > 0 else 'true' }}" style="display:inline-block;margin-left:0.5rem;">
                    {% if combined and combined|length > 0 %}
                      {% for tag in (combined | sort) %}
                        &nbsp;<a href="/html_no_js/search?q={{ tag|urlencode }}" style="background:#012383;color:#ffffff;border-radius:999px;text-decoration:none;font-size:0.95em;">{{ tag }}</a>
                      {% endfor %}
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
          </ul>
        </li>
      {% endif %}
    {% endfor %}
    </ul>

    <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
  <label style="margin-right:0.5rem;"><input type="checkbox" id="show-all-tags-checkbox"> Show all tags</label>
  <!-- Hide Completed control (browser-cookie persisted) for iOS standalone -->
  <label style="margin-right:0.5rem;"><input type="checkbox" id="hide-completed-checkbox"> Hide completed</label>
      <span style="flex:1 1 auto"></span>
      <label>Sort lists:
        <select id="list-sort-order">
          <option value="created">by creation date</option>
          <option value="modified">by modification date</option>
        </select>
      </label>
    </div>
    <!-- embed categories JSON to avoid JS linter / static parsing issues -->
    <script type="application/json" id="server-categories">{{ categories | default([]) | tojson | safe }}</script>
    <script>
      (function(){
        try{
          var el = document.getElementById('server-categories');
          var txt = el ? (el.textContent || el.innerText || '').trim() : '[]';
          window.categories = txt ? JSON.parse(txt) : [];
        }catch(e){ window.categories = []; }
      })();
    </script>
    <script>
      // Sort within categories (created vs modified), persisted in cookie
      (function(){
        function setCookie(name, value, days){ var expires=''; if(days){ var d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires='; expires='+d.toUTCString(); } document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/'; }
        function getCookie(name){ var m = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return m ? decodeURIComponent(m[1]) : null; }
        var sel = document.getElementById('list-sort-order'); if (!sel) return;
        var cookieName = 'index_list_sort_order';
        var cur = getCookie(cookieName) || 'created';
        sel.value = (cur === 'modified') ? 'modified' : 'created';
        function parseISO(v){ try { return v ? new Date(v).getTime() : 0; } catch(_) { return 0; } }
        function parsePri(el){
          try { if (el.classList && el.classList.contains('done')) return null; if (el.querySelector && el.querySelector('.done')) return null; } catch(e) {}
          var v = el.getAttribute('data-priority'); if (v==null || v==='') return null; var n = parseInt(v,10); return isNaN(n) ? null : n; }
        function sortUl(ul){
            var lis = Array.from(ul.querySelectorAll(':scope > li'));
            // determine category id for this ul
            var catSection = ul.closest('.category-section');
            var catId = null;
            try { catId = catSection ? catSection.getAttribute('data-category-id') : null; } catch(e) { catId = null; }
          lis.sort(function(a,b){
            var pa = parsePri(a), pb = parsePri(b);
            var aHas = (pa !== null), bHas = (pb !== null);
            if (aHas && !bHas) return -1; // priority first
            if (!aHas && bHas) return 1;
            if (aHas && bHas && pa !== pb) return pb - pa; // higher number first
              // If this category requests alphanumeric sorting, sort by visible text
              try {
                if (catId && categorySortMap && categorySortMap[catId]) {
                  var an = (a.querySelector && a.querySelector('a')) ? (a.querySelector('a').textContent || '') : (a.textContent || '');
                  var bn = (b.querySelector && b.querySelector('a')) ? (b.querySelector('a').textContent || '') : (b.textContent || '');
                  return an.localeCompare(bn, undefined, {numeric: true, sensitivity: 'base'});
                }
              } catch(e) {}
              var ad = 0, bd = 0;
              if (sel.value === 'modified') {
                ad = parseISO(a.getAttribute('data-modified-at')) || parseISO(a.getAttribute('data-created-at'));
                bd = parseISO(b.getAttribute('data-modified-at')) || parseISO(b.getAttribute('data-created-at'));
              } else {
                ad = parseISO(a.getAttribute('data-created-at'));
                bd = parseISO(b.getAttribute('data-created-at'));
              }
              return bd - ad;
          });
          lis.forEach(function(li){ ul.appendChild(li); });
        }
        function applySort(){ document.querySelectorAll('ul.category-lists').forEach(sortUl); }
        sel.addEventListener('change', function(){ setCookie(cookieName, sel.value, 365); applySort(); });
        // Build categorySortMap from server-rendered `categories`
        var categorySortMap = {};
        try {
          if (typeof categories !== 'undefined' && Array.isArray(categories)) {
            categories.forEach(function(c){ categorySortMap[String(c.id)] = !!c.sort_alphanumeric; });
          }
        } catch(e) {}
        applySort();
      })();
      // Minimal JS for edit and delete on the plain iOS template
      (function(){
        // Edit list name: prompt and POST as form data
        document.querySelectorAll('.edit-list-btn').forEach(function(btn){
          btn.addEventListener('click', function(){
            var id = btn.getAttribute('data-list-id');
            var current = btn.getAttribute('data-list-name') || '';
            var name = window.prompt('New list name', current);
            if (!name || name.trim() === '') return;
            var fd = new FormData();
            fd.append('name', name);
            var csrf = document.querySelector('input[name="_csrf"]');
            if (csrf && csrf.value) fd.append('_csrf', csrf.value);
            fetch('/html_no_js/lists/' + encodeURIComponent(id) + '/edit', { method: 'POST', body: fd, credentials: 'same-origin' })
              .then(function(res){ if (res.ok) location.reload(); else alert('Rename failed'); })
              .catch(function(){ alert('Rename failed'); });
          });
        });
        // Delete confirmation
        document.querySelectorAll('.confirm-delete').forEach(function(form){
          form.addEventListener('submit', function(e){
            var q = form.getAttribute('data-confirm') || 'Delete?';
            if (!window.confirm(q)) { e.preventDefault(); }
          });
        });
      })();
    </script>
    <script>
      // Collapsible category sections with localStorage persistence (iOS template)
      (function(){
        function storageKey(id){ return 'ios-cat-collapsed-' + id; }
        function isCollapsed(id){ try { return localStorage.getItem(storageKey(id)) === '1'; } catch(e){ return false; } }
        function setCollapsed(id, v){ try { localStorage.setItem(storageKey(id), v ? '1' : '0'); } catch(e){} }
        function applyState(header){
          var targetId = header.getAttribute('data-target');
          var ul = document.getElementById(targetId);
          if (!ul) return;
          var id = header.parentElement && header.parentElement.getAttribute('data-category-id') || targetId;
          var collapsed = isCollapsed(id);
          ul.style.display = collapsed ? 'none' : '';
          var twisty = header.querySelector('.twisty');
          if (twisty) twisty.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
        }
        document.querySelectorAll('.category-header').forEach(function(h){
          applyState(h);
          h.addEventListener('click', function(){
            var id = h.parentElement && h.parentElement.getAttribute('data-category-id') || h.getAttribute('data-target');
            var now = !isCollapsed(id);
            setCollapsed(id, now);
            applyState(h);
          });
        });
      })();
    </script>
      <script>
        // Show All Tags for iOS standalone: read server tags from data-list-tags by default,
        // fetch combined tags only when the checkbox is checked.
        (function(){
          function setCookie(name, value, days){
            var expires = '';
            if (days){ var d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires = '; expires=' + d.toUTCString(); }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
          }
          function getCookie(name){ var v = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return v ? decodeURIComponent(v[1]) : null; }
          var checkbox = document.getElementById('show-all-tags-checkbox'); if (!checkbox) return;
          checkbox.checked = getCookie('show_all_tags') === '1';

          function renderTagsInto(container, tags){
            container.innerHTML = '';
            if (!tags || tags.length === 0){ container.setAttribute('aria-hidden','true'); return; }
            tags.forEach(function(tag){
              var a = document.createElement('a');
              a.style.background = '#012383';
              a.style.color = '#fff';
              a.style.borderRadius = '999px';
              a.style.padding = '0.12rem 0.4rem';
              a.style.textDecoration='none';
              a.style.fontSize='0.95em';
              a.href = '/html_no_js/search?q=' + encodeURIComponent(tag);
              a.textContent = tag;
              container.appendChild(a);
              container.appendChild(document.createTextNode(' '));
            });
            container.setAttribute('aria-hidden','false');
          }

      async function fetchAndRenderAll(listId, container){
            try{
              // Try multiple combinations; prefer the richest set first
              var url1 = '/lists/' + encodeURIComponent(listId) + '/hashtags?include_todo_tags=1&include_sublists=1&combine=1';
              var resp = await fetch(url1, { credentials: 'same-origin' });
              var data = null; var fetched = [];
              if (resp && resp.ok) {
                data = await resp.json();
                fetched = (data && Array.isArray(data.hashtags)) ? data.hashtags : [];
              }
              if (!fetched || fetched.length === 0){
                var url2 = '/lists/' + encodeURIComponent(listId) + '/hashtags?include_sublists=1&combine=1';
                resp = await fetch(url2, { credentials: 'same-origin' });
                if (resp && resp.ok) {
                  data = await resp.json();
                  fetched = (data && Array.isArray(data.hashtags)) ? data.hashtags : [];
                }
              }
              if (!fetched || fetched.length === 0){
                var url3 = '/lists/' + encodeURIComponent(listId) + '/hashtags?include_todo_tags=1&combine=1';
                resp = await fetch(url3, { credentials: 'same-origin' });
                if (resp && resp.ok) {
                  data = await resp.json();
                  fetched = (data && Array.isArray(data.hashtags)) ? data.hashtags : [];
                }
              }
              // Merge order: SSR anchors (if present) -> data-list-tags -> fetched
              var raw = container.getAttribute('data-list-tags');
              var serverTags = [];
              try { serverTags = raw ? JSON.parse(raw) : []; } catch(e) { serverTags = []; }
              var seen = {};
              var merged = [];
              try {
                var ssr = Array.prototype.map.call(container.querySelectorAll('a'), function(a){ return (a && a.textContent) ? String(a.textContent).trim() : ''; }).filter(Boolean);
                ssr.forEach(function(t){ if (t && !seen[t]) { seen[t] = true; merged.push(t); } });
              } catch(e) {}
              (serverTags || []).forEach(function(t){ if (t && !seen[t]) { seen[t] = true; merged.push(t); } });
              (fetched || []).forEach(function(t){ if (t && !seen[t]) { seen[t] = true; merged.push(t); } });
        renderTagsInto(container, merged);
            }catch(e){ /* ignore network errors silently for this tiny template */ }
          }

          function renderServerProvided(container){
            var raw = container.getAttribute('data-list-tags');
            if (!raw) { container.innerHTML=''; container.setAttribute('aria-hidden','true'); return; }
            try{
              var tags = JSON.parse(raw || '[]') || [];
              renderTagsInto(container, tags);
            }catch(e){ container.innerHTML=''; container.setAttribute('aria-hidden','true'); }
          }

          function refreshAllTags(){
            document.querySelectorAll('.all-tags-inline').forEach(function(c){
              var lid = c.getAttribute('data-list-id');
              if (checkbox.checked){
                // when checked, fetch the combined list (includes todo tags)
                if (lid) fetchAndRenderAll(lid, c);
              } else {
                // when unchecked, render server-provided list tags embedded in data-list-tags
                renderServerProvided(c);
              }
            });
          }

          checkbox.addEventListener('change', function(){ setCookie('show_all_tags', checkbox.checked ? '1' : '0', 365); refreshAllTags(); });
          // Do not auto-refresh on load; keep initial DOM SSR-only.
        })();
        // Hide Completed lists for iOS template (persist via cookie)
        (function(){
          function setCookie(name, value, days){ var expires=''; if(days){ var d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires='; expires='+d.toUTCString(); } document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/'; }
          function getCookie(name){ var m = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return m ? decodeURIComponent(m[1]) : null; }
          var cb = document.getElementById('hide-completed-checkbox'); if (!cb) return;
          var cookieName = 'index_hide_completed_lists';
          cb.checked = getCookie(cookieName) === '1';
          function apply(){
            var hide = cb.checked;
            document.querySelectorAll('ul.category-lists > li').forEach(function(li){
              var isDone = !!li.querySelector && !!li.querySelector('a.done');
              li.style.display = (hide && isDone) ? 'none' : '';
            });
            // update category counts to reflect visible items
            try{
              document.querySelectorAll('.category-section').forEach(function(section){
                var ul = section.querySelector('ul.category-lists'); if (!ul) return;
                var visible = ul.querySelectorAll(':scope > li:not([style*="display: none"])').length;
                var countSpan = section.querySelector('.count');
                if (countSpan) countSpan.textContent = ' (' + visible + ')';
              });
            }catch(e){}
          }
          cb.addEventListener('change', function(){ setCookie(cookieName, cb.checked ? '1' : '0', 365); apply(); });
          // initial
          apply();
        })();
          // Listen for category sort changes from other pages/tabs
          window.addEventListener && window.addEventListener('storage', function(ev){
            if (!ev || !ev.key) return;
            try {
              if (ev.key === 'category_sort_changed'){
                var obj = JSON.parse(ev.newValue || '{}');
                if (obj && obj.id != null){
                  categorySortMap[String(obj.id)] = !!obj.sort;
                  try { if (typeof applySort === 'function') applySort(); } catch(e){}
                }
              }
            } catch(e) {}
          });
      </script>
          <div style="margin-top:0.5rem;">
      <a href="/html_no_js/categories">Manage categories</a>
    </div>

  </body>
</html>
