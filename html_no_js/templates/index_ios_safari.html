<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lists ‚Äî Fast Todo (iOS)</title>
    <style>
      /* Minimal dark mode for the standalone template */
      :root { color-scheme: dark; }
      html, body { background: #0b0b0b; color: #e5e7eb; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      a { color: #60a5fa; }
      h1, h2, h3 { color: #f8fafc; margin: 0 0 0.5rem 0; }
  ul { padding-left: 0; list-style: none; margin: 0; }
      li { padding: 0.25rem 0; }
      input, button { background: #111827; color: #e5e7eb; border: 1px solid #374151; padding: 0.35rem 0.5rem; border-radius: 4px; }
      input::placeholder { color: #9ca3af; }
      button { cursor: pointer; }
      nav a { color: #9ae6ff; margin-right: 0.5rem; }
      .muted { color: #9ca3af; }
  /* category lists: align flush under headers (no indent/bullets) */
  .category-lists { list-style: none; padding-left: 0; margin-left: 0; }
    </style>
  </head>
  <body>
  
 

    {% if pinned_todos and pinned_todos|length > 0 %}
  <h3 style="margin-top:0">Pinned</h3>
  <ul style="padding-left: 0; list-style: none; margin: 0;">
      {% for t in (pinned_todos | sort(attribute='modified_at') | reverse) %}
        <li>
          {{ 'üìå' if t.pinned|default(false) else 'üìç' }}
          <a href="/html_no_js/todos/{{ t.id }}">{{ t.text }}</a>
          <span> in <a href="/html_no_js/lists/{{ t.list_id }}">{{ t.list_name or t.list_id }}</a></span>
          {% if t.tags and t.tags|length > 0 %}
            {% for tag in (t.tags | sort) %}
              &nbsp;<a href="/html_no_js/search?q={{ tag|urlencode }}" style="background:#012383;color:#ffffff;border-radius:999px;text-decoration:none;font-size:0.95em;">{{ tag }}</a>
            {% endfor %}
          {% endif %}
        </li>
      {% endfor %}
  </ul>
    {% endif %}

    <form method="post" action="/html_no_js/lists/create">
      {% if csrf_token %}
        <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      {% endif %}
      <input name="name" placeholder="List name" required>
      <button type="submit">Create</button>
    </form>

    <form method="get" action="/html_no_js/search" style="margin:0.6rem 0;">
      {% if csrf_token %}
        <input type="hidden" name="_csrf" value="{{ csrf_token }}">
      {% endif %}
      <input name="q" placeholder="Search" aria-label="Search" style="width:60%;">
      <button type="submit">Search</button>
    </form>

    {% if cursors %}
      <nav>
        {% if cursors.has_prev %}
          <a href="?dir=prev&cursor_created_at={{ cursors.prev_cursor_created_at|urlencode }}&cursor_id={{ cursors.prev_cursor_id }}">&laquo; Newer</a>
        {% endif %}
        {% if cursors.has_next %}
          <a href="?dir=next&cursor_created_at={{ cursors.next_cursor_created_at|urlencode }}&cursor_id={{ cursors.next_cursor_id }}">Older &raquo;</a>
        {% endif %}
      </nav>
    {% endif %}

    <ul>
    {# Group by categories with collapsible sections #}
    {% for cat in categories %}
  {% set cat_lists = lists_by_category.get(cat.id, []) %}
      {% if cat_lists and cat_lists|length > 0 %}
        <li class="category-section" data-category-id="{{ cat.id }}">
          <h3 class="category-header" data-target="ios-cat-{{ cat.id }}" style="cursor:pointer; user-select:none;">
            <span class="twisty" aria-hidden="true">‚ñæ</span>
            <span class="category-name">{{ cat.name }}</span>
            <span class="count muted"> ({{ cat_lists|length }})</span>
          </h3>
          <ul id="ios-cat-{{ cat.id }}" class="category-lists">
            {% for lst in cat_lists %}
              {% set created_iso = lst.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
              {% set modified_iso = lst.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if lst.modified_at else None %}
              <li{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}>
                <form method="post" action="/html_no_js/lists/{{ lst.id }}/delete" class="confirm-delete" style="display:inline;margin-right:1rem;">
                  {% if csrf_token %}
                    <input type="hidden" name="_csrf" value="{{ csrf_token }}">
                  {% endif %}
                  <button type="submit" class="list-action-btn" title="Delete list" style="background:none;border:none;color:inherit;padding:0;margin:0;font-size:inherit;cursor:pointer;">üóë</button>
                </form>
                &nbsp;&nbsp;
                <a href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
                <button type="button" class="edit-list-btn" data-list-id="{{ lst.id }}" data-list-name="{{ lst.name|e }}" title="Edit list name" style="background:none;border:none;color:inherit;padding:0;margin-left:0.25rem;cursor:pointer;">‚úèÔ∏è</button>
                {% if lst.created_at %}<span class="muted"> cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</span>{% endif %}
                <div class="all-tags-inline" data-list-id="{{ lst.id }}" data-list-tags='{{ lst.hashtags | tojson }}' aria-hidden="true" style="display:inline-block;margin-left:0.5rem;"></div>
              </li>
            {% endfor %}
          </ul>
        </li>
      {% endif %}
    {% endfor %}

  {% set uncats = lists_by_category.get(0, []) %}
    {% if uncats and uncats|length > 0 %}
      <li class="category-section" data-category-id="uncategorized">
        <h3 class="category-header" data-target="ios-cat-uncat" style="cursor:pointer; user-select:none;">
          <span class="twisty" aria-hidden="true">‚ñæ</span>
          <span class="category-name">Uncategorized</span>
          <span class="count muted"> ({{ uncats|length }})</span>
        </h3>
        <ul id="ios-cat-uncat" class="category-lists">
          {% for lst in uncats %}
            {% set created_iso = lst.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
            {% set modified_iso = lst.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if lst.modified_at else None %}
            <li{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}>
              <form method="post" action="/html_no_js/lists/{{ lst.id }}/delete" class="confirm-delete" style="display:inline;margin-right:1rem;">
                {% if csrf_token %}
                  <input type="hidden" name="_csrf" value="{{ csrf_token }}">
                {% endif %}
                <button type="submit" class="list-action-btn" title="Delete list" style="background:none;border:none;color:inherit;padding:0;margin:0;font-size:inherit;cursor:pointer;">üóë</button>
              </form>
              &nbsp;&nbsp;
              <a href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
              <button type="button" class="edit-list-btn" data-list-id="{{ lst.id }}" data-list-name="{{ lst.name|e }}" title="Edit list name" style="background:none;border:none;color:inherit;padding:0;margin-left:0.25rem;cursor:pointer;">‚úèÔ∏è</button>
              {% if lst.created_at %}<span class="muted"> cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</span>{% endif %}
              <div class="all-tags-inline" data-list-id="{{ lst.id }}" data-list-tags='{{ lst.hashtags | tojson }}' aria-hidden="true" style="display:inline-block;margin-left:0.5rem;"></div>
            </li>
          {% endfor %}
        </ul>
      </li>
    {% endif %}
    </ul>
    <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
      <label style="margin-right:0.5rem;"><input type="checkbox" id="show-all-tags-checkbox"> Show all tags</label>
      <span style="flex:1 1 auto"></span>
      <label>Sort lists:
        <select id="list-sort-order">
          <option value="created">by creation date</option>
          <option value="modified">by modification date</option>
        </select>
      </label>
    </div>
    <script>
      // Sort within categories (created vs modified), persisted in cookie
      (function(){
        function setCookie(name, value, days){ var expires=''; if(days){ var d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires='; expires='+d.toUTCString(); } document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/'; }
        function getCookie(name){ var m = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return m ? decodeURIComponent(m[1]) : null; }
        var sel = document.getElementById('list-sort-order'); if (!sel) return;
        var cookieName = 'index_list_sort_order';
        var cur = getCookie(cookieName) || 'created';
        sel.value = (cur === 'modified') ? 'modified' : 'created';
        function parseISO(v){ try { return v ? new Date(v).getTime() : 0; } catch(_) { return 0; } }
        function sortUl(ul){
          var lis = Array.from(ul.querySelectorAll(':scope > li'));
          lis.sort(function(a,b){
            var ad = 0, bd = 0;
            if (sel.value === 'modified') {
              ad = parseISO(a.getAttribute('data-modified-at')) || parseISO(a.getAttribute('data-created-at'));
              bd = parseISO(b.getAttribute('data-modified-at')) || parseISO(b.getAttribute('data-created-at'));
            } else {
              ad = parseISO(a.getAttribute('data-created-at'));
              bd = parseISO(b.getAttribute('data-created-at'));
            }
            return bd - ad;
          });
          lis.forEach(function(li){ ul.appendChild(li); });
        }
        function applySort(){ document.querySelectorAll('ul.category-lists').forEach(sortUl); }
        sel.addEventListener('change', function(){ setCookie(cookieName, sel.value, 365); applySort(); });
        applySort();
      })();
      // Minimal JS for edit and delete on the plain iOS template
      (function(){
        // Edit list name: prompt and POST as form data
        document.querySelectorAll('.edit-list-btn').forEach(function(btn){
          btn.addEventListener('click', function(){
            var id = btn.getAttribute('data-list-id');
            var current = btn.getAttribute('data-list-name') || '';
            var name = window.prompt('New list name', current);
            if (!name || name.trim() === '') return;
            var fd = new FormData();
            fd.append('name', name);
            var csrf = document.querySelector('input[name="_csrf"]');
            if (csrf && csrf.value) fd.append('_csrf', csrf.value);
            fetch('/html_no_js/lists/' + encodeURIComponent(id) + '/edit', { method: 'POST', body: fd, credentials: 'same-origin' })
              .then(function(res){ if (res.ok) location.reload(); else alert('Rename failed'); })
              .catch(function(){ alert('Rename failed'); });
          });
        });
        // Delete confirmation
        document.querySelectorAll('.confirm-delete').forEach(function(form){
          form.addEventListener('submit', function(e){
            var q = form.getAttribute('data-confirm') || 'Delete?';
            if (!window.confirm(q)) { e.preventDefault(); }
          });
        });
      })();
    </script>
    <script>
      // Collapsible category sections with localStorage persistence (iOS template)
      (function(){
        function storageKey(id){ return 'ios-cat-collapsed-' + id; }
        function isCollapsed(id){ try { return localStorage.getItem(storageKey(id)) === '1'; } catch(e){ return false; } }
        function setCollapsed(id, v){ try { localStorage.setItem(storageKey(id), v ? '1' : '0'); } catch(e){} }
        function applyState(header){
          var targetId = header.getAttribute('data-target');
          var ul = document.getElementById(targetId);
          if (!ul) return;
          var id = header.parentElement && header.parentElement.getAttribute('data-category-id') || targetId;
          var collapsed = isCollapsed(id);
          ul.style.display = collapsed ? 'none' : '';
          var twisty = header.querySelector('.twisty');
          if (twisty) twisty.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
        }
        document.querySelectorAll('.category-header').forEach(function(h){
          applyState(h);
          h.addEventListener('click', function(){
            var id = h.parentElement && h.parentElement.getAttribute('data-category-id') || h.getAttribute('data-target');
            var now = !isCollapsed(id);
            setCollapsed(id, now);
            applyState(h);
          });
        });
      })();
    </script>
      <script>
        // Show All Tags for iOS standalone: read server tags from data-list-tags by default,
        // fetch combined tags only when the checkbox is checked.
        (function(){
          function setCookie(name, value, days){
            var expires = '';
            if (days){ var d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires = '; expires=' + d.toUTCString(); }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
          }
          function getCookie(name){ var v = document.cookie.match('(?:^|; )' + name + '=([^;]*)'); return v ? decodeURIComponent(v[1]) : null; }
          var checkbox = document.getElementById('show-all-tags-checkbox'); if (!checkbox) return;
          checkbox.checked = getCookie('show_all_tags') === '1';

          function renderTagsInto(container, tags){
            container.innerHTML = '';
            if (!tags || tags.length === 0){ container.setAttribute('aria-hidden','true'); return; }
            tags.forEach(function(tag){
              var a = document.createElement('a');
              a.style.background = '#012383';
              a.style.color = '#fff';
              a.style.borderRadius = '999px';
              a.style.padding = '0.12rem 0.4rem';
              a.style.textDecoration='none';
              a.style.fontSize='0.95em';
              a.href = '/html_no_js/search?q=' + encodeURIComponent(tag);
              a.textContent = tag;
              container.appendChild(a);
              container.appendChild(document.createTextNode(' '));
            });
            container.setAttribute('aria-hidden','false');
          }

          async function fetchAndRenderAll(listId, container){
            try{
              var resp = await fetch('/lists/' + encodeURIComponent(listId) + '/hashtags?include_todo_tags=1&combine=1', { credentials: 'same-origin' });
              if (!resp.ok) return;
              var data = await resp.json();
              var tags = data.hashtags || [];
              renderTagsInto(container, tags);
            }catch(e){ /* ignore network errors silently for this tiny template */ }
          }

          function renderServerProvided(container){
            var raw = container.getAttribute('data-list-tags');
            if (!raw) { container.innerHTML=''; container.setAttribute('aria-hidden','true'); return; }
            try{
              var tags = JSON.parse(raw || '[]') || [];
              renderTagsInto(container, tags);
            }catch(e){ container.innerHTML=''; container.setAttribute('aria-hidden','true'); }
          }

          function refreshAllTags(){
            document.querySelectorAll('.all-tags-inline').forEach(function(c){
              var lid = c.getAttribute('data-list-id');
              if (checkbox.checked){
                // when checked, fetch the combined list (includes todo tags)
                if (lid) fetchAndRenderAll(lid, c);
              } else {
                // when unchecked, render server-provided list tags embedded in data-list-tags
                renderServerProvided(c);
              }
            });
          }

          checkbox.addEventListener('change', function(){ setCookie('show_all_tags', checkbox.checked ? '1' : '0', 365); refreshAllTags(); });
          // Initialize rendering on load (renders server tags by default if unchecked)
          refreshAllTags();
        })();
      </script>
          <div style="margin-top:0.5rem;">
      <a href="/html_no_js/categories">Manage categories</a>
    </div>

  </body>
</html>
