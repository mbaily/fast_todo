{% extends 'base.html' %}

{% block title %}Calendar - Fast Todo{% endblock %}

{% block content %}
<!-- DEBUG_TEMPLATE_ID: 20250825-1 -->
  <style>
    /* remove top gap so toolbar sits flush to the top on calendar page */
    body { margin-top: 0 !important; }
    header { margin-top: 0 !important; }
    /* calendar page: do not expand full-bleed container beyond 100% to avoid rounding-induced clipping */
    section.full-bleed.calendar-bleed { width: 100% !important; max-width: 100% !important; }
  </style>
  <section class="full-bleed calendar-bleed">
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <h2>Calendar - {{ year }}-{{ '%02d'|format(month) }}</h2>
      <div style="margin-left:auto">
        <a class="button" href="/html_no_js/calendar?year={{ prev_year }}&month={{ prev_month }}">‚óÄ Prev</a>
        <a class="button" href="/html_no_js/calendar?year={{ next_year }}&month={{ next_month }}">Next ‚ñ∂</a>
      </div>
    </div>
    <div style="margin-top:0.5rem">
      <label style="display:inline-flex; align-items:center; gap:0.35rem; margin-bottom:0.5rem;">
        <input type="checkbox" id="show_ignored"> Show ignored
      </label>
      <label style="display:inline-flex; align-items:center; gap:0.35rem; margin-left:0.75rem; margin-bottom:0.5rem;">
        <input type="checkbox" id="hide_completed"> Hide completed
      </label>
      <label style="display:inline-flex; align-items:center; gap:0.35rem; margin-left:0.75rem; margin-bottom:0.5rem;">
        <input type="checkbox" id="include_historic"> Include historic (show phantom completions)
      </label>
      <!-- Preact calendar container -->
      <div id="preact-calendar-root"></div>
      
      <!-- Fallback: server-rendered list (hidden when JS loads) -->
      {% if occurrences_sorted and occurrences_sorted|length > 0 %}
      <ul class="todos-list server-rendered" style="display:none;">
      {% for ev in occurrences_sorted %}
        <li class="todo" data-occ-id="{{ ev.occ_id or ev.occ_hash or '' }}">
            <div class="controls-left">
            <input type="checkbox" class="occ-complete" data-occ-id="{{ ev.occ_id or ev.occ_hash or '' }}" data-hash="{{ ev.occ_hash or '' }}" data-item-type="{{ ev.item_type }}" data-item-id="{{ ev.id }}" data-occ-dt="{{ ev.occurrence_dt }}" data-phantom="{{ '1' if ev.phantom else '' }}" {% if ev.completed %}checked{% endif %} {% if ev.phantom %}disabled title="Historic completion (read-only)"{% endif %} aria-label="mark occurrence complete">
            <button type="button" class="occ-ignore-occ" data-occ="{{ ev.occ_id or ev.occ_hash or '' }}" data-item-id="{{ ev.id }}" title="Ignore in calendar altogether." aria-label="Ignore this todo from calendar" style="margin-left:0.25rem;padding:0.1rem 0.25rem;font-size:0.9rem;">üîï</button>
            <button type="button" class="occ-ignore-from" data-todo="{{ ev.id }}" data-occ-dt="{{ ev.occurrence_dt }}" title="Ignore from this date" aria-label="Ignore from this date" style="margin-left:0.25rem;padding:0.1rem 0.25rem;font-size:0.9rem;">‚è≠Ô∏è</button>
          </div>
          <div class="todo-content">
            <div class="todo-main wrap-text">
              <div class="wrap-text" style="font-weight:700">
                {% if ev.item_type == 'todo' %}
                  <a href="/html_no_js/todos/{{ ev.id }}">{{ ev.title }}</a>
                {% elif ev.item_type == 'list' %}
                  <a href="/html_no_js/lists/{{ ev.id }}">{{ ev.title }}</a>
                {% else %}
                  {{ ev.title }}
                {% endif %}
              </div>
              <div class="meta">{{ ev.occurrence_date or ev.occurrence_dt }}</div>
            </div>
          </div>
        </li>
      {% endfor %}
      </ul>
      {% else %}
      <!-- Minimal skeleton list so JS can replace in-place -->
      <ul class="todos-list">
        <li class="todo">
          <div class="todo-content">
            <div class="todo-main wrap-text">
              <div class="meta">Loading calendar events...</div>
            </div>
          </div>
        </li>
      </ul>
      {% endif %}
    </div>
  </section>
  {% block scripts %}{{ super() }}

  <!-- Preact Calendar Module -->
  <script type="module">
    import { initializeCalendar } from '/static/calendar-init.js';
    
    // Initial occurrences from server
    const initialOccurrences = {{ occurrences_json | safe }};
    
    // Initialize Preact calendar with year, month, and initial data
    initializeCalendar({{ year }}, {{ month }}, initialOccurrences);
  </script>

  {% endblock %}

{% endblock %}
