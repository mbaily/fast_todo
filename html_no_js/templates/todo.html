{% extends 'base.html' %}
{% block title %}Todo: {{ todo.text }} ‚Äî Fast Todo (no-js){% endblock %}
{% block content %}
  {# provide a back_to_list_url for the shared toolbar when rendering a todo #}
  {% if todo and todo.list_id %}
    {% set back_to_list_url = ('/html_no_js/lists/' ~ todo.list_id ~ '#todo-' ~ todo.id) %}
  {% endif %}
  <style>
    /* page-specific: remove top page margin so the site title sits flush to the top */
    body { margin-top: 0 !important; }
    header { margin-top: 0 !important; }
  /* Make the inline pin toggle stand out when todo is pinned (match index orange style) */
  .pin-button.pinned { border-color: #ff8a3d; background: rgba(255,138,61,0.06); color: #ffb68a; }
  .pin-button.pinned:hover { background: rgba(255,138,61,0.12); }
  /* ensure completed sublists are struck-through (match index) */
  .lists-list .list-title.done { text-decoration: line-through; color: #6b7280; }
  /* sublists action column: ensure sufficient width and no overlap */
  .lists-list .list-item { align-items: flex-start; }
  .lists-list .list-item > .list-action-left { width: 5.5rem; flex: 0 0 5.5rem; gap: 0.25rem; align-items: center; justify-content: flex-start; }
  .lists-list .list-item > .list-main { min-width: 0; }
  .lists-list .list-action-btn { padding: 0.14rem 0.22rem; font-size: 0.95rem; }
  @media (max-width: 480px) {
    .lists-list .list-item > .list-action-left { width: 6.5rem; flex-basis: 6.5rem; }
  }
  </style>
  
  {# Page toolbar (placed just below the main navigation toolbar) #}
  <nav class="page-toolbar" role="toolbar" aria-label="Todo actions" style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.6rem;">
    <form id="todo-save-form" method="post" action="/html_no_js/todos/{{ todo.id }}/edit" style="display:inline">
      {{ csrf_field() }}
      <button type="submit" class="tb-item" aria-label="Save todo">üíæ <span class="sr-only">Save</span></button>
    </form>
    <form id="todo-delete-form" method="post" action="/html_no_js/todos/{{ todo.id }}/delete" class="confirm-delete" data-confirm="Delete this todo? This cannot be undone." style="display:inline">
      {{ csrf_field() }}
      <input type="hidden" name="anchor" value="todo-{{ todo.id }}">
      <input type="hidden" name="list_id" value="{{ todo.list_id }}">
      <button type="submit" class="tb-item" aria-label="Delete todo">üóë <span class="sr-only">Delete</span></button>
    </form>
    <div style="flex:1 1 auto"></div>
    <span id="autosave-status" class="meta" aria-live="polite"></span>
  </nav>

  <div class="todo-header" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
    <div class="controls-left" style="flex:0 0 auto;">
      <form id="todo-complete-form" method="post" action="/html_no_js/todos/{{ todo.id }}/complete" style="display:inline">
        {{ csrf_field() }}
        <input type="hidden" name="anchor" value="todo-{{ todo.id }}">
        <input type="hidden" name="done" value="{{ 'false' if completed else 'true' }}">
        <button type="submit" title="{{ 'Unmark' if completed else 'Mark' }}" aria-label="{{ 'Unmark' if completed else 'Mark' }}">{{ '‚òë' if completed else '‚òê' }}</button>
      </form>
    </div>
    <div class="todo-title" style="flex:1 1 auto;">
        <h2 style="margin:0">{{ todo.text }}
          {% if todo.priority %}
            {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
            <span class="meta priority-inline" title="Priority {{ todo.priority }}" style="margin-left:0.5rem;"><span class="priority-circle">{{ circ.get(todo.priority, todo.priority) }}</span></span>
          {% endif %}
        </h2>      
      </div>    
  </div>
  <p class="meta" style="margin:0">List: <a href="/html_no_js/lists/{{ todo.list_id }}">{{ list.name if list else todo.list_id }}</a></p>
  

  {% if todo.note %}
    <p class="note-text">{{ todo.note|linkify }}</p>
  {% endif %}
  {% if tags and tags|length > 0 %}
    <div class="tags" role="list" aria-label="Tags">
      {% for tag in (tags | sort) %}
        <div role="listitem" style="display:inline-block; margin-right:0.4rem">
          <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
          <form method="post" action="/html_no_js/todos/{{ todo.id }}/hashtags/remove" style="display:inline">
            {{ csrf_field() }}
            <input type="hidden" name="tag" value="{{ tag }}">
            <button type="submit" class="tag-remove" aria-label="Remove {{ tag }}"><span aria-hidden="true">‚úñ</span><span class="sr-only">Remove {{ tag }}</span></button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# Tags input (label visually hidden) #}
  <form method="post" action="/html_no_js/todos/{{ todo.id }}/hashtags" aria-label="Add tag">
    {{ csrf_field() }}
    <label>Add Tag <input name="tag" placeholder="#tag" aria-label="Tag name"></label>
    <button type="submit">Add</button>
  </form>
  {# If the user opts to show sublists up-top, render them here (below tags) #}
  {% if sublists is defined and (todo is defined and todo.lists_up_top) %}
    <section aria-label="Sublists" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
        <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-todo-id="{{ todo.id }}" title="Mark this todo for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">üîñ</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">‚ÜîÔ∏è</a></h3>
        <form method="post" action="/html_no_js/todos/{{ todo.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
          {{ csrf_field() }}
          <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ todo.id }}" value="{{ 'true' if todo.lists_up_top else 'false' }}">
          <label style="display:inline-flex; align-items:center; gap:0.4rem;">
            <input type="checkbox" id="lists_up_top_checkbox_{{ todo.id }}" {% if todo.lists_up_top %}checked{% endif %}>
            <span>Up top</span>
          </label>
        </form>
      </div>
    
    {# Inline create control (replaces the previous 'No sublists yet' message) #}
  <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
      {{ csrf_field() }}
      <label>New sublist<br>
        <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </label>
      <button type="submit">Create</button>
    </form>
    {% if sublists|length > 0 %}
      <ul class="lists-list">
        {% for sl in sublists %}
          {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
          {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
          {# compute effective priority (use override if higher) and expose data attributes for sorting #}
          {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
          <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
            <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
              {# Move up/down within parent todo #}
              <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="list-action-btn" title="Move up">‚¨ÜÔ∏è</button>
              </form>
              <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="list-action-btn" title="Move down">‚¨áÔ∏è</button>
              </form>
            </div>
            <div class="list-main">
              <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
              {% if sl.priority is not none %}
                <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
              {% endif %}
              {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
              {% endif %}
              <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">‚úèÔ∏è</button>
              {% if sl.created_at %}
                <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
              {% endif %}
              {# list-level tags #}
              {% if sl.hashtags and sl.hashtags|length > 0 %}
                <div class="tags" role="list" aria-label="List tags">
                  {% for tag in (sl.hashtags | sort) %}
                    <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
      <script>
      // Sort Sublists by effective priority (desc), using parent_list_position as persistent tie-breaker (asc).
      (function(){
        try {
          var ul = document.querySelector('.lists-list');
          if (!ul) return;
          var items = Array.from(ul.querySelectorAll('li.list-item'));
          if (!items.length) return;
          function parseIntOrNull(v){ if (v === null || typeof v === 'undefined' || v === '') return null; var n = parseInt(v, 10); return isNaN(n) ? null : n; }
          items.sort(function(a, b){
            var ap = parseIntOrNull(a.getAttribute('data-priority'));
            var bp = parseIntOrNull(b.getAttribute('data-priority'));
            if (ap === null && bp !== null) return 1;
            if (bp === null && ap !== null) return -1;
            if (ap !== null && bp !== null){ if (bp !== ap) return bp - ap; }
            var ao = parseIntOrNull(a.getAttribute('data-parent-list-position'));
            var bo = parseIntOrNull(b.getAttribute('data-parent-list-position'));
            if (ao === null && bo !== null) return 1;
            if (bo === null && ao !== null) return -1;
            if (ao !== null && bo !== null){ if (ao !== bo) return ao - bo; }
            return 0;
          });
          items.forEach(function(li){ ul.appendChild(li); });
        } catch(e) { console && console.error && console.error('sublists sort failed', e); }
      })();
      </script>
     {% endif %}
  </section>
  {% endif %}
  <p class="meta">Created: {{ todo.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }} &nbsp; Modified: {{ todo.modified_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</p>

  <form id="todo-edit-form" method="post" action="/html_no_js/todos/{{ todo.id }}/edit" autocomplete="off">
    {{ csrf_field() }}
    {# Make the title editable as a textarea with rows matching the note's newline count so it visually matches note height #}
  <label>Text<br><textarea id="todo-text-input" class="full-bleed" name="text" required autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" rows="{{ (todo.note or '').split('\n')|length }}">{{ todo.text }}</textarea></label><br>
    <div id="todo-hashtag-suggest" class="hashtag-suggest" role="listbox" aria-label="Hashtag suggestions" data-tags="{% if all_hashtags and all_hashtags|length > 0 %}{% for tag in all_hashtags %}{{ tag }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"></div>
  <label>Note<br><textarea id="note-textarea" class="full-bleed" name="note" rows="9">{{ todo.note or '' }}</textarea></label><br>
  {# Save button moved to page toolbar above; keep a hidden submit for progressive enhancement if needed #}
  <button type="submit" style="display:none">Save</button>
  </form>

  <div class="priority-row" style="margin:0.25rem 0">
    <label for="todo-priority-{{ todo.id }}">Priority</label>
    <form method="post" action="/html_no_js/todos/{{ todo.id }}/priority" style="display:inline-block; margin-left:0.5rem">
      {{ csrf_field() }}
      <select id="todo-priority-{{ todo.id }}" name="priority">
        <option value="" {% if not todo.priority %}selected{% endif %}>(none)</option>
        {% for p in range(1, 11) %}
          <option value="{{ p }}" {% if todo.priority == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </form>
    <form method="post" action="/html_no_js/todos/{{ todo.id }}/pin" style="display:inline-block; margin-left:0.5rem">
      {{ csrf_field() }}
      <input type="hidden" name="pinned" value="{{ 'false' if todo.pinned|default(false) else 'true' }}">
      <button type="submit" class="pin-button {% if todo.pinned|default(false) %}pinned{% endif %}" aria-label="Toggle pin" title="Toggle pin">{{ 'üìå' if todo.pinned|default(false) else 'üìç' }}</button>
    </form>
  </div>

  {# Optionally render sublists up-top for todos with lists_up_top set #}
  {% if sublists is defined and (todo is defined and not todo.lists_up_top) %}
    <section aria-label="Sublists" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
        <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-todo-id="{{ todo.id }}" title="Mark this todo for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">üîñ</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">‚ÜîÔ∏è</a></h3>
        <form method="post" action="/html_no_js/todos/{{ todo.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
          {{ csrf_field() }}
          <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ todo.id }}" value="{{ 'true' if todo.lists_up_top else 'false' }}">
          <label style="display:inline-flex; align-items:center; gap:0.4rem;">
            <input type="checkbox" id="lists_up_top_checkbox_{{ todo.id }}" {% if todo.lists_up_top %}checked{% endif %}>
            <span>Up top</span>
          </label>
        </form>
      </div>
    
    {# Inline create control (replaces the previous 'No sublists yet' message) #}
  <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
      {{ csrf_field() }}
      <label>New sublist<br>
        <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
      </label>
      <button type="submit">Create</button>
    </form>
    {% if sublists|length > 0 %}
      <ul class="lists-list">
        {% for sl in sublists %}
          {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
          {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
          {# compute effective priority (use override if higher) and expose data attributes for sorting #}
          {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
          <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
            <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
              {# Move up/down within parent todo #}
              <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="list-action-btn" title="Move up">‚¨ÜÔ∏è</button>
              </form>
              <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                {{ csrf_field() }}
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="list-action-btn" title="Move down">‚¨áÔ∏è</button>
              </form>
            </div>
            <div class="list-main">
              <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
              {% if sl.priority is not none %}
                <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
              {% endif %}
              {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
              {% endif %}
              <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">‚úèÔ∏è</button>
              {% if sl.created_at %}
                <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
              {% endif %}
              {# list-level tags #}
              {% if sl.hashtags and sl.hashtags|length > 0 %}
                <div class="tags" role="list" aria-label="List tags">
                  {% for tag in (sl.hashtags | sort) %}
                    <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                      <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>
  {% endif %}

  {# Actions (heading removed to reduce visual clutter) #}
  {# Use an anchor link for mark/unmark so no-JS clients can click it. The GET handler will perform the toggle and redirect back. #}
  {# mark/unmark moved to a left-aligned checkbox next to the title above #}
  {# Delete moved to page-toolbar above. #}

  {# navigation links removed (Recent lists / Back to list moved to toolbar) #}
{% endblock %}

{% block scripts %}
<script>
// Simple mark-storage helper used by mark icon
(function(){
  const KEY='ft_marks_v1'; const TTL=5*60*1000; // 5 minutes
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(_){ return {}; } }
  function save(o){ try { localStorage.setItem(KEY, JSON.stringify(o||{})); } catch(_){ } }
  function prune(o){ const t=Date.now(); const out={todos:{},lists:{}}; if(o.todos) for(const[k,v] of Object.entries(o.todos)) if((t-v)<TTL) out.todos[k]=v; if(o.lists) for(const[k,v] of Object.entries(o.lists)) if((t-v)<TTL) out.lists[k]=v; return out; }
  function mark(kind, id){ let o=prune(load()); if(!o[kind]) o[kind]={}; o[kind][String(id)]=Date.now(); save(o); }
  const btn = document.getElementById('mark-list-hdr');
  if (btn){ btn.addEventListener('click', function(){ var tid = Number(btn.getAttribute('data-todo-id')); if (tid) { mark('todos', tid); btn.textContent='‚úîÔ∏è'; setTimeout(function(){ btn.textContent='üîñ'; }, 1200); } }); }
})();
</script>
<script>
// Styles for hashtag suggestion box shared with list page
(function(){
  var style = document.createElement('style');
  style.textContent = `
    .hashtag-suggest{position:fixed;z-index:9999;background:#fff;border:1px solid #cbd5e1;border-radius:6px;box-shadow:0 6px 20px rgba(0,0,0,0.15);padding:4px;display:none;max-height:200px;overflow-y:auto;min-width:160px;font-size:.95rem}
    .hashtag-suggest .item{padding:4px 8px;border-radius:4px;cursor:pointer;white-space:nowrap}
    .hashtag-suggest .item.active,.hashtag-suggest .item:hover{background:rgba(29,78,216,.12)}
  `;
  document.head.appendChild(style);
})();

// Caret-based hashtag completion for the todo title input
(function(){
  var input = document.getElementById('todo-text-input');
  var box = document.getElementById('todo-hashtag-suggest');
  if (!input || !box) return;
  var ALL_TAGS = (box.getAttribute('data-tags') || '').split(',').map(function(s){return s.trim();}).filter(Boolean);
  var state = { open:false, items:[], active:0, range:[0,0] };
  function closeBox(){ box.style.display='none'; state.open=false; }
  function render(items){
    box.innerHTML='';
    if(!items||items.length===0){ closeBox(); return; }
    items.slice(0,20).forEach(function(tag, idx){
      var el=document.createElement('div');
      el.className='item'+(idx===state.active?' active':'');
      el.setAttribute('role','option');
      el.textContent=(typeof tag==='string' && tag.charAt(0)==='#')?tag:('#'+tag);
      el.dataset.idx=String(idx);
      el.addEventListener('mousedown', function(ev){ ev.preventDefault(); commit(idx); });
      box.appendChild(el);
    });
    box.style.display='block';
  }
  function positionBox(caretIndex){
    try{
      var rect=input.getBoundingClientRect();
      var style=window.getComputedStyle(input);
      var leftPad=parseFloat(style.paddingLeft)||0;
      var font=[style.fontWeight, style.fontSize, style.fontFamily].filter(Boolean).join(' ');
      var text=input.value.slice(0, caretIndex);
      var canvas=positionBox._c||(positionBox._c=document.createElement('canvas'));
      var ctx=canvas.getContext('2d');
      ctx.font=font;
      var metrics=ctx.measureText(text);
      var x=rect.left+leftPad+metrics.width-(input.scrollLeft||0);
      var vw=Math.max(document.documentElement.clientWidth||0, window.innerWidth||0);
      var maxLeft=vw-200;
      box.style.left=Math.max(8, Math.min(x, maxLeft))+'px';
      box.style.top=(rect.bottom+4)+'px';
      box.style.minWidth=Math.max(160, rect.width*0.4)+'px';
    }catch(_){ var r=input.getBoundingClientRect(); box.style.left=(r.left)+'px'; box.style.top=(r.bottom+4)+'px'; }
  }
  function openFor(fragment, start, end){
    var frag=(fragment||'').toLowerCase();
    function body(t){ return (t&&t.charAt(0)==='#')?t.slice(1):(t||''); }
    var items=ALL_TAGS.filter(function(t){ return body(t).toLowerCase().indexOf(frag)===0; });
    state.items=items; state.active=0; state.range=[start,end];
    if(items.length===0){ closeBox(); return; }
    positionBox(end); render(items); state.open=true;
  }
  function findFragment(){
    var pos=input.selectionStart||0;
    var left=(input.value||'').slice(0,pos);
    var m=left.match(/(^|\s)#([A-Za-z0-9_]*)$/);
    if(!m) return null;
    var fragment=m[2]||'';
    var start=pos-fragment.length-1; // include '#'
    return { fragment:fragment, start:start, end:pos };
  }
  function commit(idx){
    if(!state.open||idx==null||idx<0||idx>=state.items.length) return;
    var tag=state.items[idx];
    var v=input.value; var start=state.range[0]; var end=state.range[1];
    var before=v.slice(0,start); var after=v.slice(end);
    var replacement=(typeof tag==='string' && tag.charAt(0)==='#')?tag:('#'+tag);
    var needsSpace=after.length===0 || !/^\s/.test(after);
    var newVal=before+replacement+(needsSpace?' ':'')+after;
    var newCaret=(before+replacement).length+(needsSpace?1:0);
    input.value=newVal; input.setSelectionRange(newCaret,newCaret);
    closeBox();
  }
  input.addEventListener('input', function(){ var f=findFragment(); if(!f){ closeBox(); return; } openFor(f.fragment, f.start, f.end); });
  input.addEventListener('keydown', function(ev){ if(!state.open) return; if(ev.key==='ArrowDown'){ ev.preventDefault(); state.active=Math.min(state.active+1, state.items.length-1); render(state.items);} else if(ev.key==='ArrowUp'){ ev.preventDefault(); state.active=Math.max(state.active-1,0); render(state.items);} else if(ev.key==='Enter'||ev.key==='Tab'){ ev.preventDefault(); commit(state.active);} else if(ev.key==='Escape'){ ev.preventDefault(); closeBox(); } });
  input.addEventListener('focus', function(){ var f=findFragment(); if(f){ positionBox(f.end); } });
  window.addEventListener('scroll', function(){ if(state.open){ var f=findFragment(); if(f) positionBox(f.end); } }, true);
  window.addEventListener('resize', function(){ if(state.open){ var f=findFragment(); if(f) positionBox(f.end); } });
  // Close suggestion box on outside click, touchstart or page scroll to avoid dual scroll indicators on mobile
  document.addEventListener('click', function(ev){ if(!box.contains(ev.target) && ev.target!==box && ev.target!==input) closeBox(); });
  try { document.addEventListener('touchstart', function(ev){ if(!box.contains(ev.target) && ev.target!==box && ev.target!==input) closeBox(); }, { passive: true }); } catch(e) {}
  try { window.addEventListener('scroll', function(){ if(state.open) closeBox(); }, true); } catch(e) {}
})();

// Minimal autosave: debounce textarea changes and POST form via fetch to the existing edit endpoint.
;(function(){
  const textarea = document.getElementById('note-textarea');
  if (!textarea) return; // nothing to do
  const form = textarea.closest('form');
  const statusEl = document.getElementById('autosave-status');
  // helper to read csrf_token cookie (csrf cookie is not HttpOnly)
  function getCookie(name){
    const v = document.cookie.match('(?:^|;)\\s*' + name + '=([^;]*)');
    return v ? decodeURIComponent(v[1]) : null;
  }

  let timer = null;
  let inFlight = false;
  const debounceMs = 1000;

  function setStatus(text){
    if (statusEl) statusEl.textContent = text;
  }

  async function doSave(){
    if (inFlight) return; // simple guard
    inFlight = true;
    setStatus('Saving...');
    try{
      const url = form.action;
      const fd = new FormData();
      const textInput = form.querySelector('[name="text"]');
      const textVal = textInput ? textInput.value : '';
      fd.append('text', textVal);
      fd.append('note', textarea.value || '');
  // include csrf token: prefer the form hidden field (rendered server-side)
  // and fall back to the csrf_token cookie.
  let csrf = null;
  const hiddenCsrf = form.querySelector('input[name="_csrf"]');
  if (hiddenCsrf && hiddenCsrf.value) csrf = hiddenCsrf.value;
  if (!csrf) csrf = getCookie('csrf_token');
  if (csrf) fd.append('_csrf', csrf);
      const res = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('save failed');
      setStatus('Saved');
      // Also update the toolbar save button to show saved status briefly
      try {
        var tbBtn = document.querySelector('#todo-save-form button[type="submit"]');
        if (tbBtn) {
          if (!tbBtn.dataset._orig) tbBtn.dataset._orig = tbBtn.textContent || '';
          tbBtn.textContent = 'Saved';
          setTimeout(function(){ if (tbBtn && tbBtn.textContent === 'Saved') tbBtn.textContent = tbBtn.dataset._orig || 'üíæ'; }, 1200);
        }
      } catch(e) { /* ignore */ }
      setTimeout(()=>{ if (statusEl && statusEl.textContent === 'Saved') statusEl.textContent = ''; }, 1200);
    }catch(err){
      setStatus('Save failed');
      console.error('autosave error', err);
    }finally{
      inFlight = false;
    }
  }

  // expose the save function for manual toolbar save to call
  try { window.todo_do_save = doSave; } catch(e) { /* ignore */ }

  function scheduleSave(){
  if (timer) clearTimeout(timer);
  timer = setTimeout(doSave, debounceMs);
  }

  // save on input and on blur
  textarea.addEventListener('input', scheduleSave);
  textarea.addEventListener('blur', ()=>{ if (timer) clearTimeout(timer); doSave(); });

  // also save when text field changes (title)
  const titleInput = form.querySelector('[name="text"]');
  if (titleInput){
    titleInput.addEventListener('input', scheduleSave);
    titleInput.addEventListener('blur', ()=>{ if (timer) clearTimeout(timer); doSave(); });
  }

  // Wire the toolbar save button to call the same save routine without redirect
  try {
    var toolbarSaveForm = document.getElementById('todo-save-form');
    if (toolbarSaveForm) {
      toolbarSaveForm.addEventListener('submit', function(ev){
        ev.preventDefault();
        try {
          if (window.todo_do_save) window.todo_do_save();
        } catch(e) { try { toolbarSaveForm.submit(); } catch(_){} }
      });
    }
  } catch(e) { /* ignore */ }

})();

// Sync the title textarea height/rows to match the rendered note height (accounts for word-wrapping)
// More robust sync: set the title textarea pixel height to match the rendered note height.
(function(){
  function syncTitleToNote(){
    try{
      var titleEl = document.getElementById('todo-text-input');
      if (!titleEl) return;
      // Prefer the editable note textarea's height (more deterministic), fall back to rendered .note-text
      var noteTextarea = document.getElementById('note-textarea');
      var noteEl = document.querySelector('.note-text');
      var noteHeight = 0;
      if (noteTextarea) {
        // use scrollHeight so we capture wrapped content height
        noteHeight = noteTextarea.scrollHeight || noteTextarea.clientHeight || 0;
      }
      if (!noteHeight && noteEl) {
        var noteRect = noteEl.getBoundingClientRect();
        noteHeight = noteRect.height || 0;
      }
      if (!noteHeight) return;
      var computed = window.getComputedStyle(titleEl);
      var lineHeight = parseFloat(computed.lineHeight);
      if (!lineHeight || isNaN(lineHeight)) {
        var fontSize = parseFloat(computed.fontSize) || 16;
        lineHeight = Math.round(fontSize * 1.2);
      }
      // Directly set the height to match the note's rendered height (keep small padding)
  var desiredHeight = Math.max(24, Math.round(noteHeight));
      titleEl.style.boxSizing = 'border-box';
      titleEl.style.height = desiredHeight + 'px';
      // Also update rows for accessibility and form autosizing fallbacks
      var rows = Math.max(1, Math.round(desiredHeight / lineHeight));
      titleEl.rows = rows;
    }catch(e){ /* ignore */ }
  }
  var t;
  window.addEventListener('load', syncTitleToNote);
  window.addEventListener('resize', function(){ if (t) clearTimeout(t); t = setTimeout(syncTitleToNote, 150); });
  setTimeout(syncTitleToNote, 120);
})();

// Intercept the todo complete form to POST via fetch so toggling doesn't redirect the page.
(function(){
  try {
    var form = document.getElementById('todo-complete-form');
    if (!form) return;
    form.addEventListener('submit', function(ev){
      // if JS is disabled, the browser will submit normally (no handler). Here we prevent default and
      // send a fetch so the UI doesn't navigate.
      ev.preventDefault();
      // Build form data, prefer existing hidden inputs
      var fd = new FormData(form);
      // Read CSRF token: prefer _csrf hidden input or cookie fallback
      function getCookie(name){ var m = document.cookie.match('(?:^|;)\\s*' + name + '=([^;]*)'); return m ? decodeURIComponent(m[1]) : null; }
      if (!fd.has('_csrf')) {
        var cookie = getCookie('csrf_token'); if (cookie) fd.append('_csrf', cookie);
      }
      fetch(form.action, { method: 'POST', credentials: 'same-origin', body: fd, headers: { 'Accept': 'application/json' } })
        .then(function(res){
          if (!res.ok) throw res;
          return res.json().catch(function(){ return null; });
        })
        .then(function(body){
          // Toggle UI: flip the button content between checked/unchecked
          try {
            var btn = form.querySelector('button[type="submit"]');
            if (btn) {
              var was = btn.textContent && btn.textContent.indexOf('‚òë') !== -1;
              btn.textContent = was ? '‚òê' : '‚òë';
              // Keep the hidden 'done' input in sync so subsequent submits toggle correctly
              try {
                var doneInput = form.querySelector('input[name="done"]');
                if (doneInput) {
                  // After successful toggle, the next request should send the opposite action.
                  // If the button previously showed '‚òë' (was === true), it is now unchecked and
                  // we want the next submit to send 'true' to mark it again. If previously unchecked,
                  // it is now checked and next submit should send 'false'. So set to String(was).
                  doneInput.value = was ? 'true' : 'false';
                }
              } catch(e) { /* ignore done input sync errors */ }
            }
            // Optionally update autosave/status if server returned a message
            var status = document.getElementById('autosave-status'); if (status && body && body.message) status.textContent = body.message; else if (status) status.textContent = '';
          } catch(e) { /* ignore UI update errors */ }
        })
        .catch(function(err){
          // On error, fall back to full submit to ensure server state changes (progressive enhancement)
          try { form.submit(); } catch(e) { console.error('complete toggle failed', err); }
        });
    });
  } catch(e) { /* ignore */ }
})();

</script>
<script>
// Minimal rename for sublists (same behavior as index): prompt and POST
(function(){
  document.querySelectorAll('.edit-list-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = btn.getAttribute('data-list-id');
      var current = btn.getAttribute('data-list-name') || '';
      var name = window.prompt('New list name', current);
      if (!name || name.trim() === '') return;
      var fd = new FormData();
      fd.append('name', name);
      var csrfInput = document.querySelector('input[name="_csrf"]');
      if (csrfInput && csrfInput.value) fd.append('_csrf', csrfInput.value);
      fetch('/html_no_js/lists/' + encodeURIComponent(id) + '/edit', { method: 'POST', body: fd, credentials: 'same-origin' })
        .then(function(res){ if (!res.ok) throw new Error('Rename failed'); return res.json().catch(function(){ return null; }); })
        .then(function(){
          try{
            var els = Array.from(document.querySelectorAll('.list-title'));
            els.forEach(function(a){ try { var href = a.getAttribute('href') || ''; if (href.indexOf('/html_no_js/lists/' + String(id)) !== -1) a.textContent = name; } catch(e){} });
            var editBtn = document.querySelector('.edit-list-btn[data-list-id="' + id + '"]'); if (editBtn) editBtn.setAttribute('data-list-name', name);
          }catch(e){}
        })
        .catch(function(){ alert('Rename failed'); });
    });
  });
})();
// Delegate todo-level forms (delete, pin, tag remove/add) to use fetch + DOM updates
(function(){
  function todoFormMatch(action){ try { return action && action.match(/\/html_no_js\/todos\/(\d+)\/(delete|pin|hashtags|hashtags\/remove)/); } catch(e){ return null; } }
  document.body.addEventListener('submit', function(ev){
    var form = ev.target; if (!form || form.tagName !== 'FORM') return; var action = form.getAttribute('action') || '';
    var m = todoFormMatch(action); if (!m) return; ev.preventDefault();
    var todoId = m[1]; var fd = new FormData(form); var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value);
    fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' })
      .then(function(res){ if (!res.ok) throw new Error('Request failed'); return res.text().catch(function(){ return null; }); })
      .then(function(){
        try{
          if (action.indexOf('/delete') !== -1) {
            var anchor = form.querySelector('input[name="anchor"]'); var anchorId = anchor ? anchor.value : ('todo-' + todoId); var li = document.getElementById(anchorId) || document.getElementById('todo-' + todoId); if (li) li.remove(); return;
          }
          if (action.indexOf('/pin') !== -1) {
            var btn = form.querySelector('button'); if (btn) { var pinned = btn.classList && btn.classList.contains('pinned'); if (pinned) { btn.classList.remove('pinned'); btn.textContent='üìç'; } else { btn.classList.add('pinned'); btn.textContent='üìå'; } } return;
          }
          if (action.indexOf('/hashtags/remove') !== -1) {
            // remove the surrounding tag element (closest div role=listitem)
            var wrapper = form.closest('[role="listitem"]') || form.parentElement; if (wrapper) wrapper.remove(); return;
          }
          if (action.indexOf('/hashtags') !== -1) {
            // add tag: server returns redirect or simple success; insert new tag inline if possible
            // Best-effort: read tag field from form and append a new tag-chip
            var tag = form.querySelector('input[name="tag"]'); if (tag && tag.value) {
              var container = form.closest('form') ? form.parentElement : form.parentElement;
              var div = document.createElement('div'); div.setAttribute('role','listitem'); div.style.display='inline-block'; div.style.marginRight='0.4rem';
              var a = document.createElement('a'); a.className='tag-chip'; a.href='/html_no_js/search?q=' + encodeURIComponent(tag.value); a.textContent = tag.value; div.appendChild(a);
              var remForm = document.createElement('form'); remForm.method='post'; remForm.action = action + '/remove'; remForm.style.display='inline'; var inp = document.createElement('input'); inp.type='hidden'; inp.name='tag'; inp.value=tag.value; remForm.appendChild(inp); var btn = document.createElement('button'); btn.type='submit'; btn.className='tag-remove'; btn.innerHTML='<span aria-hidden="true">‚úñ</span><span class="sr-only">Remove ' + tag.value + '</span>'; remForm.appendChild(btn); div.appendChild(remForm);
              // append before the add-tag form
              if (form.parentElement) form.parentElement.insertBefore(div, form);
            }
          }
        }catch(e){ console && console.error && console.error('todo form DOM update failed', e); }
      })
      .catch(function(){ alert('Action failed'); });
  }, false);
})();

// Priority select: POST via fetch and update header priority circle
(function(){ try { var sel = document.getElementById('todo-priority-{{ todo.id }}'); if (!sel) return; sel.addEventListener('change', function(){ var v = sel.value; var fd = new FormData(); fd.append('priority', v); var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value); fetch('/html_no_js/todos/{{ todo.id }}/priority', { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(res){ if (!res.ok) throw new Error('Priority update failed'); return res.json().catch(function(){ return null; }); }).then(function(){ try{ var circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'}; var el = document.querySelector('.todo-header .priority-circle'); if (el) el.textContent = v ? (circ[v] || v) : ''; }catch(e){} }).catch(function(){ console && console.error && console.error('Priority update failed'); }); }); } catch(e){} })();

// lists_up_top checkbox: POST via fetch
(function(){ var cb = document.getElementById('lists_up_top_checkbox_{{ todo.id }}'); var hidden = document.getElementById('lists_up_top_hidden_{{ todo.id }}'); if (!cb || !hidden) return; cb.addEventListener('change', function(){ hidden.value = cb.checked ? 'true' : 'false'; var fd = new FormData(); fd.append('lists_up_top', hidden.value); var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value); fetch((hidden.closest('form') && hidden.closest('form').action) || '/html_no_js/todos/{{ todo.id }}/lists_up_top', { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(res){ if (!res.ok) console && console.error && console.error('lists_up_top update failed'); }); }); })();

// Delegate sublist move for todo (same logic as list page)
(function(){ function matchSublistMove(action){ try{ var m = action && action.match(/\/html_no_js\/todos\/(?:\d+)\/sublists\/(\d+)\/move/); return m; }catch(e){ return null; } } document.body.addEventListener('submit', function(ev){ var form = ev.target; if (!form || form.tagName !== 'FORM') return; var action = form.getAttribute('action') || ''; var m = matchSublistMove(action); if (!m) return; ev.preventDefault(); var sublistId = m[1]; var fd = new FormData(form); var dir = fd.get('direction'); var csrf = document.querySelector('input[name="_csrf"]'); if (csrf && csrf.value) fd.append('_csrf', csrf.value); fetch(action, { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(res){ if (!res.ok) throw new Error('Move failed'); return res.text().catch(function(){ return null; }); }).then(function(){ try{ var selector = 'a.list-title[href*="/html_no_js/lists/' + sublistId + '"]'; var a = document.querySelector(selector); if (!a) return; var liNode = a.closest('li.list-item'); if (!liNode) return; var parentUl = liNode.parentElement; if (!parentUl) return; if (dir === 'up') { var prev = liNode.previousElementSibling; if (prev) parentUl.insertBefore(liNode, prev); } else if (dir === 'down') { var next = liNode.nextElementSibling; if (next) parentUl.insertBefore(next, liNode); } }catch(e){ console && console.error && console.error('sublist move DOM update failed', e); } }).catch(function(){ alert('Move failed'); }); }, false); })();
</script>
<script>
  (function(){
    var cb = document.getElementById('lists_up_top_checkbox_{{ todo.id }}');
    var hidden = document.getElementById('lists_up_top_hidden_{{ todo.id }}');
    var form = hidden && hidden.closest('form');
    if (!cb || !hidden || !form) return;
    cb.addEventListener('change', function(){ hidden.value = cb.checked ? 'true' : 'false'; try{ form.submit(); } catch(e){} });
  })();
</script>
{% endblock %}

