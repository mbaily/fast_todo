{% extends 'base.html' %}
{% block title %}Todo: {{ todo.text }} ‚Äî Fast Todo (no-js){% endblock %}
{% block content %}
  {# provide a back_to_list_url for the shared toolbar when rendering a todo #}
  {% if todo and todo.list_id %}
    {% set back_to_list_url = ('/html_no_js/lists/' ~ todo.list_id ~ '#todo-' ~ todo.id) %}
  {% endif %}
  <style>
    /* page-specific: remove top page margin so the site title sits flush to the top */
    body { margin-top: 0 !important; }
    header { margin-top: 0 !important; }
  /* Make the inline pin toggle stand out when todo is pinned (match index orange style) */
  .pin-button.pinned { border-color: #ff8a3d; background: rgba(255,138,61,0.06); color: #ffb68a; }
  .pin-button.pinned:hover { background: rgba(255,138,61,0.12); }
  /* ensure completed sublists are struck-through (match index) */
  .lists-list .list-title.done { text-decoration: line-through; color: #6b7280; }
  /* generic done class for striking-through anchors and inline content */
  .done { text-decoration: line-through; color: #6b7280; }
  /* when a note paragraph is marked done, ensure contained anchors are struck-through too */
  .note-text.done a { text-decoration: line-through; color: inherit; }
  /* sublists action column: ensure sufficient width and no overlap */
  .lists-list .list-item { align-items: flex-start; }
  .lists-list .list-item > .list-action-left { width: 5.5rem; flex: 0 0 5.5rem; gap: 0.25rem; align-items: center; justify-content: flex-start; }
  .lists-list .list-item > .list-main { min-width: 0; }
  .lists-list .list-action-btn { padding: 0.14rem 0.22rem; font-size: 0.95rem; }
  @media (max-width: 480px) {
    .lists-list .list-item > .list-action-left { width: 6.5rem; flex-basis: 6.5rem; }
  }
  </style>
  
  {# Page toolbar (placed just below the main navigation toolbar) #}
  <nav class="page-toolbar" role="toolbar" aria-label="Todo actions" style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.6rem;">
    <form id="todo-save-form" method="post" action="/html_no_js/todos/{{ todo.id }}/edit" style="display:inline">
      {{ csrf_field() }}
      <button type="submit" class="tb-item" aria-label="Save todo">üíæ <span class="sr-only">Save</span></button>
    </form>
    <form id="todo-delete-form" method="post" action="/html_no_js/todos/{{ todo.id }}/delete" class="confirm-delete" data-confirm="Delete this todo? This cannot be undone." style="display:inline">
      {{ csrf_field() }}
      <input type="hidden" name="anchor" value="todo-{{ todo.id }}">
      <input type="hidden" name="list_id" value="{{ todo.list_id }}">
      <button type="submit" class="tb-item" aria-label="Delete todo">üóë <span class="sr-only">Delete</span></button>
    </form>
    <div style="flex:1 1 auto"></div>
    <span id="autosave-status" class="meta" aria-live="polite"></span>
  </nav>

  <div class="todo-header" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
    <div class="controls-left" style="flex:0 0 auto;">
      <form id="todo-complete-form" method="post" action="/html_no_js/todos/{{ todo.id }}/complete" style="display:inline">
        {{ csrf_field() }}
        <input type="hidden" name="anchor" value="todo-{{ todo.id }}">
        <input type="hidden" name="done" value="{{ 'false' if completed else 'true' }}">
        <button type="submit" title="{{ 'Unmark' if completed else 'Mark' }}" aria-label="{{ 'Unmark' if completed else 'Mark' }}">{{ '‚òë' if completed else '‚òê' }}</button>
      </form>
    </div>
    <div class="todo-title" style="flex:1 1 auto;">
        <h2 style="margin:0">{{ todo.text }}
          {% if todo.priority %}
            {% set circ = {1:'‚ë†',2:'‚ë°',3:'‚ë¢',4:'‚ë£',5:'‚ë§',6:'‚ë•',7:'‚ë¶',8:'‚ëß',9:'‚ë®',10:'‚ë©'} %}
            <span class="meta priority-inline" title="Priority {{ todo.priority }}" style="margin-left:0.5rem;"><span class="priority-circle">{{ circ.get(todo.priority, todo.priority) }}</span></span>
          {% endif %}
        </h2>      
      </div>    
  </div>
  {% if active_collations is defined and active_collations|length > 0 %}
    <style>
      /* Collation dots: colored circles indicating inclusion (filled) or exclusion (outline) */
      .collation-dots { display:inline-flex; gap:0.4rem; align-items:center; vertical-align:middle; }
      .collation-dot { width: 14px; height: 14px; border-radius: 50%; padding: 0; border: 2px solid hsl(var(--dot-hue, 210), 75%, 45%); background: transparent; cursor: pointer; display:inline-block; line-height:0; }
      .collation-dot[aria-pressed="true"] { background: hsl(var(--dot-hue, 210), 75%, 50%); border-color: hsl(var(--dot-hue, 210), 75%, 35%); }
      .collation-dot:focus { outline: 2px solid hsl(var(--dot-hue, 210), 85%, 35%); outline-offset: 1px; }
      .collation-dot .sr-only { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    </style>
    <div class="meta" style="margin:0.15rem 0 0.35rem 0">
      <strong>Collations:</strong>
      <span class="collation-dots">
        {% for c in active_collations %}
          {% set hue = (c.list_id * 47) % 360 %}
          <button type="button" class="collation-dot" data-list-id="{{ c.list_id }}" data-todo-id="{{ todo.id }}" data-name="{{ c.name or ('List #' ~ c.list_id) }}" aria-pressed="{{ 'true' if c.linked else 'false' }}" title="{{ (c.linked and 'Remove from ' or 'Add to ') ~ (c.name or ('List #' ~ c.list_id)) }}" style="--dot-hue: {{ hue }};">
            <span class="sr-only">{{ c.name or ('List #' ~ c.list_id) }} {{ 'included' if c.linked else 'not included' }}</span>
          </button>
        {% endfor %}
      </span>
    </div>
  {% endif %}

  <p class="meta" style="margin:0">List: <a href="/html_no_js/lists/{{ todo.list_id }}">{{ list.name if list else todo.list_id }}</a></p>

  {% if links is defined and links|length > 0 %}
    <div class="meta" style="margin:0.15rem 0 0.35rem 0">
      <strong>Links:</strong>
      {% for lk in links %}
        <a href="{{ lk.href }}" class="{% if lk.completed or completed %}done{% endif %}">{{ lk.label or lk.title or (lk.tgt_type ~ ' #' ~ lk.tgt_id) }}</a>{% if lk.tags and lk.tags|length %} <span class="tags-inline meta">{% for tag in lk.tags %}<a class="tag-chip {% if lk.completed or completed %}done{% endif %}" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>{% endfor %}</span>{% endif %}{% if not loop.last %}, {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if todo.note %}
    <p class="note-text">{{ todo.note|render_fn_tags|linkify }}</p>
  {% endif %}
  {% if tags and tags|length > 0 %}
    <div class="tags" role="list" aria-label="Tags">
      {% for tag in (tags | sort) %}
        <div role="listitem" style="display:inline-block; margin-right:0.4rem">
          <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
          <form method="post" action="/html_no_js/todos/{{ todo.id }}/hashtags/remove" style="display:inline">
            {{ csrf_field() }}
            <input type="hidden" name="tag" value="{{ tag }}">
            <button type="submit" class="tag-remove" aria-label="Remove {{ tag }}"><span aria-hidden="true">‚úñ</span><span class="sr-only">Remove {{ tag }}</span></button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" action="/html_no_js/todos/{{ todo.id }}/hashtags" aria-label="Add tag">
    {{ csrf_field() }}
    <label>Add Tag <input name="tag" placeholder="#tag" aria-label="Tag name"></label>
    <button type="submit">Add</button>
  </form>

  {% if sublists is defined and (todo is defined and todo.lists_up_top) %}
    <section aria-label="Sublists" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
        <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-todo-id="{{ todo.id }}" title="Mark this todo for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">üîñ</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">‚ÜîÔ∏è</a></h3>
        <form method="post" action="/html_no_js/todos/{{ todo.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
          {{ csrf_field() }}
          <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ todo.id }}" value="{{ 'true' if todo.lists_up_top else 'false' }}">
          <label style="display:inline-flex; align-items:center; gap:0.4rem;">
            <input type="checkbox" id="lists_up_top_checkbox_{{ todo.id }}" {% if todo.lists_up_top %}checked{% endif %}>
            <span>Up top</span>
          </label>
        </form>
      </div>

      <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
        {{ csrf_field() }}
        <label>New sublist<br>
          <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
        </label>
        <button type="submit">Create</button>
      </form>
      {% if sublists|length > 0 %}
        <ul class="lists-list">
          {% for sl in sublists %}
            {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
            {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
            {# Secondary (derived) priority: highest of immediate child todos' max (if any) and immediate child sublists' priorities. Server combines into override_priority. #}
            {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
            <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
              <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
                <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                  {{ csrf_field() }}
                  <input type="hidden" name="direction" value="up">
                  <button type="submit" class="list-action-btn" title="Move up">‚¨ÜÔ∏è</button>
                </form>
                <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                  {{ csrf_field() }}
                  <input type="hidden" name="direction" value="down">
                  <button type="submit" class="list-action-btn" title="Move down">‚¨áÔ∏è</button>
                </form>
              </div>
              <div class="list-main">
                <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
                {% if sl.priority is not none %}
                  <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
                {% endif %}
                {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                  <span class="muted priority-inline priority-override" title="Secondary priority (max child todos/sublists)"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
                {% endif %}
                <a class="list-action-btn" href="/html_no_js/tree?root_list_id={{ sl.id }}" title="Open tree centered on this sublist" aria-label="Open tree centered on this sublist">üëÅÔ∏è</a>
                <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">‚úèÔ∏è</button>
                {% if sl.created_at %}
                  <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
                {% endif %}
                {% if sl.hashtags and sl.hashtags|length > 0 %}
                  <div class="tags" role="list" aria-label="List tags">
                    {% for tag in (sl.hashtags | sort) %}
                      <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                        <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </section>
  {% endif %}

  <p class="meta">Created: {{ todo.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }} &nbsp; Modified: {{ todo.modified_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</p>

  <form id="todo-edit-form" method="post" action="/html_no_js/todos/{{ todo.id }}/edit" autocomplete="off">
    {{ csrf_field() }}
    <label>Text<br><textarea id="todo-text-input" class="full-bleed" name="text" required autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" rows="{{ (todo.note or '').split('\n')|length }}">{{ todo.text }}</textarea></label><br>
    <div id="todo-hashtag-suggest" class="hashtag-suggest" role="listbox" aria-label="Hashtag suggestions" data-tags="{% if all_hashtags and all_hashtags|length > 0 %}{% for tag in all_hashtags %}{{ tag }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"></div>

    <label for="note-textarea">Note</label>
      <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; margin:0.25rem 0;">
        <span class="meta">Insert link:</span>
        <select id="note-link-target-{{ todo.id }}">
          <option value="">(Select a recently marked item)</option>
        </select>
        <button type="button" id="note-insert-link-{{ todo.id }}" onclick="try{if(window.__ft_insert_selected_link){window.__ft_insert_selected_link();}}catch(e){}">Insert Link</button>
        <label style="display:inline-flex; align-items:center; gap:0.4rem; margin-left:0.5rem;">
          <input type="checkbox" id="note-sort-links-{{ todo.id }}" name="sort_links_cb" {% if todo.sort_links %}checked{% endif %}
                 form="todo-sort-links-form-{{ todo.id }}"
                 onchange="document.getElementById('note-sort-links-hidden-{{ todo.id }}').value = this.checked ? 'true' : 'false'; document.getElementById('todo-sort-links-form-{{ todo.id }}').submit();">
          <span>Sort Links</span>
        </label>
      </div>
      <textarea id="note-textarea" class="full-bleed" name="note" rows="9">{{ todo.note or '' }}</textarea>
      <div id="note-calc-output-wrap-{{ todo.id }}" style="margin-top:0.5rem; display:none;">
        <label for="note-calc-output-{{ todo.id }}">Calculation Output</label><br>
        <textarea id="note-calc-output-{{ todo.id }}" class="full-bleed" rows="8" readonly aria-readonly="true"></textarea>
      </div>
      <br>

    <button type="submit" style="display:none">Save</button>
  </form>

    {# External form for Sort Links toggle (linked via form attribute from the checkbox above) #}
    <form id="todo-sort-links-form-{{ todo.id }}" method="post" action="/html_no_js/todos/{{ todo.id }}/sort_links" style="display:none">
      {{ csrf_field() }}
      <input type="hidden" name="sort_links" id="note-sort-links-hidden-{{ todo.id }}" value="{{ 'true' if todo.sort_links else 'false' }}">
    </form>

  {% set dw_prefix = config.DOKUWIKI_NOTE_LINK_PREFIX if config is defined and config.DOKUWIKI_NOTE_LINK_PREFIX is defined else None %}
  {% if dw_prefix %}
    {% set dw_url = dw_prefix ~ 'fast_todo:todo:' ~ todo.id %}
    <p style="margin:0.25rem 0 0.75rem 0; display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
      <a class="btn" href="{{ dw_url }}" target="_blank" rel="noopener noreferrer" title="Open DokuWiki page for this todo">üìÑ DokuWiki page for this todo</a>
      <button style="margin-left:1rem" type="button" class="btn" id="note-calc-btn-{{ todo.id }}" title="Calculate using CalcDict">Calculate</button>
    </p>
  {% else %}
    <p style="margin:0.25rem 0 0.75rem 0">
      <button type="button" class="btn" id="note-calc-btn-{{ todo.id }}" title="Calculate using CalcDict">Calculate</button>
    </p>
  {% endif %}

  <div class="priority-row" style="margin:0.25rem 0">
    <label for="todo-priority-{{ todo.id }}">Priority</label>
    <form method="post" action="/html_no_js/todos/{{ todo.id }}/priority" style="display:inline-block; margin-left:0.5rem">
      {{ csrf_field() }}
      <select id="todo-priority-{{ todo.id }}" name="priority">
        <option value="" {% if not todo.priority %}selected{% endif %}>(none)</option>
        {% for p in range(1, 11) %}
          <option value="{{ p }}" {% if todo.priority == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </form>
    <form method="post" action="/html_no_js/todos/{{ todo.id }}/pin" style="display:inline-block; margin-left:0.5rem">
      {{ csrf_field() }}
      <input type="hidden" name="pinned" value="{{ 'false' if todo.pinned|default(false) else 'true' }}">
      <button type="submit" class="pin-button {% if todo.pinned|default(false) %}pinned{% endif %}" aria-label="Toggle pin" title="Toggle pin">{{ 'üìå' if todo.pinned|default(false) else 'üìç' }}</button>
    </form>
    <form method="post" action="/html_no_js/todos/{{ todo.id }}/calendar_ignored" style="display:inline-block; margin-left:0.75rem">
      {{ csrf_field() }}
      <input type="hidden" name="calendar_ignored" id="todo-calendar-ignored-hidden-{{ todo.id }}" value="{{ 'true' if todo.calendar_ignored|default(false) else 'false' }}">
      <label style="display:inline-flex; align-items:center; gap:0.35rem;">
        <input type="checkbox" id="todo-calendar-ignored-cb-{{ todo.id }}" {% if todo.calendar_ignored|default(false) %}checked{% endif %}>
        <span>Ignore in calendar</span>
      </label>
    </form>
  </div>

  {% if sublists is defined and (todo is defined and not todo.lists_up_top) %}
    <section aria-label="Sublists" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem">
        <h3 style="margin:0 0 .4rem 0">Sublists <button type="button" id="mark-list-hdr" data-todo-id="{{ todo.id }}" title="Mark this todo for move" style="border:none;background:transparent;cursor:pointer;font-size:1rem;">üîñ</button> <a href="/html_no_js/move" id="move-hdr" title="Open move page" style="text-decoration:none; font-size:1rem;">‚ÜîÔ∏è</a></h3>
        <form method="post" action="/html_no_js/todos/{{ todo.id }}/lists_up_top" style="display:inline; margin-left:0.5rem;">
          {{ csrf_field() }}
          <input type="hidden" name="lists_up_top" id="lists_up_top_hidden_{{ todo.id }}" value="{{ 'true' if todo.lists_up_top else 'false' }}">
          <label style="display:inline-flex; align-items:center; gap:0.4rem;">
            <input type="checkbox" id="lists_up_top_checkbox_{{ todo.id }}" {% if todo.lists_up_top %}checked{% endif %}>
            <span>Up top</span>
          </label>
        </form>
      </div>
      <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/create" style="margin:0 0 .4rem 0" autocomplete="off">
        {{ csrf_field() }}
        <label>New sublist<br>
          <input type="text" name="name" required placeholder="Sublist name" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
        </label>
        <button type="submit">Create</button>
      </form>
      {% if sublists|length > 0 %}
        <ul class="lists-list">
          {% for sl in sublists %}
            {% set created_iso = sl.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
            {% set modified_iso = sl.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if sl.modified_at else None %}
            {% set eff = sl.override_priority if (sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority)) else sl.priority %}
            <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %}{% if eff is not none %} data-priority="{{ eff }}"{% endif %}{% if sl.priority is not none %} data-list-priority="{{ sl.priority }}"{% endif %}{% if sl.override_priority is not none %} data-override-priority="{{ sl.override_priority }}"{% endif %}{% if sl.parent_list_position is not none %} data-parent-list-position="{{ sl.parent_list_position }}"{% endif %}>
              <div class="list-action-left" style="display:flex;gap:0.25rem;align-items:center;">
                <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                  {{ csrf_field() }}
                  <input type="hidden" name="direction" value="up">
                  <button type="submit" class="list-action-btn" title="Move up">‚¨ÜÔ∏è</button>
                </form>
                <form method="post" action="/html_no_js/todos/{{ todo.id }}/sublists/{{ sl.id }}/move" style="display:inline">
                  {{ csrf_field() }}
                  <input type="hidden" name="direction" value="down">
                  <button type="submit" class="list-action-btn" title="Move down">‚¨áÔ∏è</button>
                </form>
              </div>
              <div class="list-main">
                <a class="list-title {% if sl.completed %}done{% endif %}" href="/html_no_js/lists/{{ sl.id }}">{{ sl.name }}</a>
                {% if sl.priority is not none %}
                  <span class="meta priority-inline" title="List priority"><span class="priority-circle">{{ circ.get(sl.priority, sl.priority) }}</span></span>
                {% endif %}
                {% if sl.override_priority is not none and (sl.priority is none or sl.override_priority > sl.priority) %}
                  <span class="muted priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(sl.override_priority, sl.override_priority) }}</span></span>
                {% endif %}
                <a class="list-action-btn" href="/html_no_js/tree?root_list_id={{ sl.id }}" title="Open tree centered on this sublist" aria-label="Open tree centered on this sublist">üëÅÔ∏è</a>
                <button type="button" class="list-action-btn edit-list-btn" data-list-id="{{ sl.id }}" data-list-name="{{ sl.name|e }}" title="Edit list name">‚úèÔ∏è</button>
                {% if sl.created_at %}
                  <div class="meta">cr. {{ sl.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
                {% endif %}
                {% if sl.hashtags and sl.hashtags|length > 0 %}
                  <div class="tags" role="list" aria-label="List tags">
                    {% for tag in (sl.hashtags | sort) %}
                      <div role="listitem" style="display:inline-block;margin-right:0.35rem">
                        <a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </section>
  {% endif %}

  <section aria-label="Links" style="margin-top:1.0rem">
    <h3 style="margin:0">Links</h3>
    <form id="add-link-form-todo-{{ todo.id }}" method="post" action="/html_no_js/todos/{{ todo.id }}/links" style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap">
      {{ csrf_field() }}
      <input type="hidden" name="tgt_type" value="">
      <input type="hidden" name="tgt_id" value="">
      <label>Marked
        <select id="link-target-todo-{{ todo.id }}">
          <option value="">(Select a recently marked item)</option>
        </select>
      </label>
      <label>Label <input name="label" placeholder="Optional label"></label>
      <button type="submit">Add link</button>
    </form>
    <p id="link-empty-todo-{{ todo.id }}" class="meta" style="display:none;margin:0.0rem 0">No marked items. Use the üîñ button on a todo or list to mark it, then return here.</p>
    {% if links is defined and links|length > 0 %}
      <ul style="list-style: none; padding: 0; margin: 0;">
        {% for lk in links %}
          <li>
            <a href="{{ lk.href }}">{{ lk.label or lk.title or (lk.tgt_type ~ ' #' ~ lk.tgt_id) }}</a>{% if lk.tags and lk.tags|length %} <span class="tags-inline meta">{% for tag in lk.tags %}<a class="tag-chip" href="/html_no_js/search?q={{ tag|urlencode }}" role="link">{{ tag }}</a>{% endfor %}</span>{% endif %}
            <form method="post" action="/html_no_js/todos/{{ todo.id }}/links/{{ lk.id }}/delete" style="display:inline">
              {{ csrf_field() }}
              <button type="submit" class="tag-remove" title="Remove link"><span aria-hidden="true">‚úñ</span><span class="sr-only">Remove link</span></button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="meta" style="margin:0.2rem 0">No links yet.</p>
    {% endif %}
  </section>



  {# Actions (heading removed to reduce visual clutter) #}
  {# Use an anchor link for mark/unmark so no-JS clients can click it. The GET handler will perform the toggle and redirect back. #}
  {# mark/unmark moved to a left-aligned checkbox next to the title above #}
  {# Delete moved to page-toolbar above. #}

  {# navigation links removed (Recent lists / Back to list moved to toolbar) #}
{% endblock %}

{% block scripts %}
  <script src="/static/no_js/todo.js"></script>
  <script>
    (function(){
      try{
        var cb = document.getElementById('todo-calendar-ignored-cb-{{ todo.id }}');
        var hid = document.getElementById('todo-calendar-ignored-hidden-{{ todo.id }}');
        var form = hid ? hid.closest('form') : null;
        if (!cb || !hid || !form) return;
  if (cb.dataset && cb.dataset.bound === '1') return;
  cb.dataset.bound = '1';
  cb.addEventListener('change', function(){
          try{
            hid.value = cb.checked ? 'true' : 'false';
            var fd = new FormData();
            fd.append('calendar_ignored', hid.value);
            var csrfInput = form.querySelector('input[name="_csrf"]') || document.querySelector('input[name="_csrf"]');
            if (csrfInput && csrfInput.value) fd.append('_csrf', csrfInput.value);
            fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'Accept': 'application/json' }}).then(function(res){ if(!res.ok){ throw new Error('toggle failed'); } return res.json().catch(function(){ return null; }); }).then(function(){ /* no-op */ }).catch(function(){ try{ console && console.error && console.error('calendar_ignored update failed'); }catch(_){ } });
          }catch(_){ }
        });
      }catch(_){ }
    })();
  </script>
{% endblock %}
