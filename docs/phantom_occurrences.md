# Phantom Occurrences: Preserving Completion History After Rule Changes

## The Problem

When a user changes a recurrence rule completely, the old occurrences are no longer generated:

**Example:**
1. Todo: "Standup every Monday" → generates Oct 6, 13, 20, 27
2. User completes Oct 13 (Monday)
3. User changes to: "Standup every Tuesday" → now generates Oct 7, 14, 21, 28
4. **Problem:** Monday Oct 13 is no longer generated, so the completion is "orphaned"

## The Solution: Phantom Occurrences

We now inject "phantom occurrences" for completed dates that are no longer generated by the current recurrence rule.

### How It Works

1. **During calendar generation:**
   - Generate all occurrences from current todo/list state
   - Build a set of (item_type, item_id, date) for all generated occurrences

2. **After filtering:**
   - Fetch all `CompletedOccurrence` records for the date range
   - For each completion, check if it matches a generated occurrence
   - If NOT, create a "phantom occurrence" using the stored metadata

3. **Phantom occurrence contains:**
   - `occurrence_dt`: The original date/time (from completion record)
   - `item_type`, `item_id`: The item that was completed
   - `title`: Current title of the item (fetched from DB)
   - `completed`: Always `true`
   - `phantom`: Flag set to `true` to indicate this is synthetic
   - `source`: Set to `'phantom-completed'`

### What Data Is Used

The `CompletedOccurrence` table stores all the metadata we need:

```python
class CompletedOccurrence(SQLModel, table=True):
    user_id: int              # Who completed it
    occ_hash: str             # Original hash (may no longer match)
    item_type: str            # 'todo' or 'list'
    item_id: int              # Which item
    occurrence_dt: datetime   # When it was supposed to happen
    completed_at: datetime    # When user marked it complete
```

This means we can reconstruct the occurrence even when:
- The title has changed
- The recurrence rule has changed completely
- The occurrence no longer exists in the current rule

### Display Behavior

Phantom occurrences:
- **Show up in the calendar** on their original date
- **Are marked as completed** (checked)
- **Show the current title** of the item (not the old title)
- **Can be identified** by the `phantom: true` flag

### Example

```
Before rule change:
  Oct 6 (Mon)  - Standup every Monday
  Oct 13 (Mon) - Standup every Monday ✓ (completed)
  Oct 20 (Mon) - Standup every Monday
  Oct 27 (Mon) - Standup every Monday

After rule change to "every Tuesday":
  Oct 7 (Tue)  - Standup every Tuesday
  Oct 13 (Mon) - Standup every Tuesday ✓ (phantom, completed)
  Oct 14 (Tue) - Standup every Tuesday
  Oct 21 (Tue) - Standup every Tuesday
  Oct 28 (Tue) - Standup every Tuesday
```

Note how Oct 13 still shows even though it's a Monday and the new rule is for Tuesdays.

## Implementation Details

### Location
`app/main.py` - `/calendar/occurrences` endpoint, after the filtering step

### Logic Flow

```python
# 1. Build set of existing occurrences
existing_keys = {(item_type, item_id, date) for all occurrences}

# 2. Check each completion record
for completion in done_rows:
    key = (completion.item_type, completion.item_id, completion.occurrence_dt.date())
    
    # 3. If not in existing set, it's orphaned
    if key not in existing_keys:
        # Fetch current item to get title
        item = await sess.get(Todo/ListState, completion.item_id)
        
        # Create phantom occurrence
        phantom = {
            'occurrence_dt': completion.occurrence_dt,
            'item_type': completion.item_type,
            'id': completion.item_id,
            'title': item.current_title,
            'completed': True,
            'phantom': True,
            'source': 'phantom-completed',
            ...
        }
        occurrences.append(phantom)
```

### Performance

- **Minimal overhead**: Only processes completion records already fetched
- **Lazy loading**: Only fetches item details for orphaned completions
- **Single query per phantom**: `sess.get()` is fast with indexes
- **Typical case**: 0-2 phantom occurrences per month

### Edge Cases Handled

1. **Completion without metadata**: Skipped (can't create phantom)
2. **Item deleted**: Title will be None, phantom not created
3. **Multiple completions same date**: Each gets a phantom
4. **Date-only comparison**: Handles time differences gracefully

## Testing

### Test Case: Recurrence Rule Change

```bash
PYTHONPATH=. python tools/test_rrule_change.py
```

Expected output:
```
✅ YES! The old completed occurrence still shows as completed!
```

### Verification

1. Create todo: "Meeting every Monday"
2. Complete Monday Oct 13
3. Change to: "Meeting every Tuesday"  
4. View calendar
5. **Result:** Oct 13 (Monday) still shows as completed

## Benefits

✅ **Completion history preserved** even when rules change completely
✅ **User sees what they actually did**, not just current schedule
✅ **No data loss** - all completions are visible
✅ **Backward compatible** - works with existing completion records
✅ **Minimal performance impact** - only creates phantoms when needed

## Limitations

1. **Title shows current text**: Phantom uses item's current title, not the title at completion time
2. **No old rrule info**: We don't store what the old recurrence rule was
3. **Requires metadata**: Only works for completions that have `item_type`, `item_id`, `occurrence_dt` populated

## Future Enhancements

Possible improvements:
1. Store original title in `CompletedOccurrence.metadata_json`
2. Add visual indicator in UI that this is a phantom (grayed out, strikethrough, etc.)
3. Add tooltip showing "This was completed when the rule was different"
4. Store old rrule in metadata for historical reference

## Summary

Phantom occurrences solve the "lost completion history" problem when users:
- Change recurrence rules (every Monday → every Tuesday)
- Change frequencies (weekly → monthly)
- Remove recurrence entirely (recurring → one-time)
- Change dates in the text (Oct 20 → Oct 25)

The implementation is robust, performant, and backward compatible. Users now see their complete history of completed work, regardless of how they've evolved their tasks over time.
