{% extends "layout.html" %}

{% block head %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* tag-chip styles copied from html_tailwind/index.html (dark mode friendly) */
  .tag-wrapper { position: relative; display: inline-flex; align-items: center; }
  .tag-chip:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.5); background: rgba(37,99,235,0.55); border-color: rgba(147,197,253,0.9); color: #fff; }
  .tag-chip:focus { outline: none; }
  .tag-chip:focus-visible { box-shadow: 0 0 0 3px rgba(88,166,255,0.45); }
  .tag-chip .label { font-weight: 600; font-size: 0.9rem; }
  /* ensure the visible label box ends before the X by reserving space; use fixed max-width to avoid zero-width issues */
  .tag-chip .label { display: inline-block; max-width: 9rem; margin-right: 0.4rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tag-chip { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; font-weight: 600; }
  .tag-chip { box-shadow: 0 4px 10px rgba(2,6,23,0.25); }
  .tag-chip:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(96,165,250,0.18); }
  .tag-wrapper .remove { background: rgba(0,0,0,0.12); width: 1.2rem; height: 1.2rem; display:flex; align-items:center; justify-content:center; }
  .tag-wrapper .remove:hover { background: rgba(0,0,0,0.2); }
  .tag-wrapper .remove:focus { outline: none; box-shadow: 0 0 0 3px rgba(96,165,250,0.18); }
  /* remove button is absolutely positioned inside the rounded chip but kept outside the anchor in DOM */
  /* increase right padding so label has breathing room before the X */
  /* increase padding-right further so label ends left of the X */
  .tag-chip { display:inline-flex; align-items:center; gap:0.35rem; background: rgba(30,64,175,0.4); border: 1px solid rgba(96,165,250,0.7); padding: 0.2rem 2.6rem 0.2rem 0.6rem; border-radius: 999px; color: #fff; text-decoration: none; margin: 0.12rem 0.35rem 0.12rem 0; transition: box-shadow 120ms ease, background-color 120ms ease, color 120ms ease, border-color 120ms ease; cursor: pointer; }

  /* position the remove X button fixed relative to the chip - no movement on hover */
  .tag-wrapper .remove { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); height: 1.1rem; width: 1.1rem; display:flex; align-items:center; justify-content:center; background: transparent; border: none; color: rgba(255,255,255,0.95); font-weight:700; cursor: pointer; border-radius: 999px; transition: background-color 120ms ease, color 120ms ease; }
  .tag-wrapper .remove:hover { color: #fff; background: rgba(0,0,0,0.12); }
</style>
{% endblock %}

{% block body %}
<div class="mx-auto py-1 px-1">
  <!-- index-only search/create controls removed: this is a per-list page -->

  <main class="mt-1">
    <div id="list-root" class="mx-auto py-1 px-1">
      <!-- List header: name, completed toggle, edit, priority, tags -->
      <header class="bg-black-900 rounded-lg p-1 mb-1">
        <div class="flex flex-col gap-3">
          <!-- top row: name + controls (priority, etc.) -->
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2 min-w-0">
              <!-- Completed toggle -->
              <label class="flex items-center gap-1">
                <input id="list-complete-toggle" data-list-id="{{ list.id if list is defined else '' }}" type="checkbox" class="h-4 w-4 rounded text-blue-400 focus:ring-blue-300" {% if list is defined and list.complete %}checked{% endif %} />
              </label>

              <!-- Small horizontal gap -->
              <div class="w-5"></div>

              <!-- List name (display + inline edit) -->
              <div class="min-w-0">
                <h1 id="list-name-display" class="text-xl md:text-2xl font-semibold text-slate-50 truncate" title="{{ list.name if list is defined else 'List' }}">{{ list.name if list is defined else 'Untitled List' }}</h1>
              </div>

              <!-- Small horizontal gap -->
              <div class="w-5"></div>

              <!-- Edit list name button -->
              <button id="edit-list-name-btn" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm rounded transition-colors duration-200" title="Edit list name">
                ‚úèÔ∏è
              </button>
              <!-- Pin toggle -->
              <button id="pin-list-btn" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm rounded transition-colors duration-200" title="Pin list" aria-pressed="{{ 'true' if list.pinned else 'false' }}" data-pinned="{{ '1' if list.pinned else '0' }}">
                {% if list.pinned %}üìå{% else %}üìç{% endif %}
              </button>
            </div>



            <!-- Priority select (server model: nullable int 1..10) -->
            <div class="flex items-center gap-2">
              <label for="list-priority-select" class="text-sm text-slate-400">Priority</label>
              <select id="list-priority-select" data-list-id="{{ list.id if list is defined else '' }}" class="bg-slate-800 text-slate-100 text-sm rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="" {% if list is defined and list.priority is none %}selected{% endif %}>None</option>
                {% for p in range(1,11) %}
                  <option value="{{ p }}" {% if list is defined and list.priority == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

            <!-- tags row (keeps #list-tags for JS) -->
            <div class="mt-2">
              <div id="list-tags" class="flex flex-wrap gap-2 items-center" aria-live="polite">
                {% if list is defined and list.tags %}
                  {% for tag in (list.tags | sort) %}
                    <div class="tag-wrapper inline-flex items-center">
                      <a href="/html_no_js/search?q={{ tag|urlencode }}" class="tag-chip inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold text-slate-100 border border-sky-500/30 hover:bg-sky-700/25 focus:outline-none focus:ring-2 focus:ring-sky-400" data-tag="{{ tag }}">
                        <span class="label truncate">#{{ tag }}</span>
                      </a>
                      <button type="button" onclick="event.stopPropagation();event.preventDefault();" class="remove" aria-label="Remove tag {{ tag }}" data-tag="{{ tag }}">√ó</button>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>

              <!-- add-tag controls (keeps existing IDs for JS) -->
              <div class="mt-2 flex items-center gap-2">
                <input id="add-tag-input" class="px-2 py-1 rounded bg-slate-800 text-slate-100 text-sm" placeholder="add tag (no #)" />
                <button id="add-tag-btn" class="px-2 py-1 bg-sky-600 text-white rounded text-sm">Add</button>
              </div>
            </div>
          </div>

          <!-- Add new todo section -->
          <div class="mt-4 flex gap-2">
            <input id="new-todo-input" type="text" placeholder="Add a new todo..." class="flex-1 px-3 py-2 bg-slate-800 text-slate-100 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent" />
            <button id="add-todo-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-slate-900">Add</button>
          </div>

          <!-- Sublists Section -->
          <div id="sublists-section" class="mt-6 bg-slate-800/50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-slate-200">Sublists</h3>
              <div class="flex items-center gap-2">
                <!-- Tag for later use -->
                <button id="tag-list-btn" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-400" title="Tag this list for later use">
                  üìå Tag List
                </button>
                <!-- Move to top toggle -->
                <button id="move-sublists-up-btn" class="px-3 py-1 bg-slate-600 hover:bg-slate-700 text-slate-200 text-sm rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-slate-400" title="Move sublists section up">
                  ‚¨ÜÔ∏è Move Up
                </button>
                <!-- Go to move page -->
                <a href="/html_tailwind/move?list_id={{ list.id if list is defined else '' }}" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white text-sm rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-400 inline-block">
                  üì¶ Move Items
                </a>
              </div>
            </div>

            <!-- Create new sublist -->
            <div class="mb-4 flex gap-2">
              <input id="new-sublist-input" type="text" placeholder="Create new sublist..." class="flex-1 px-3 py-2 bg-slate-700 text-slate-100 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent" />
              <button id="create-sublist-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-slate-900">Create</button>
            </div>

            <!-- Sublists list -->
            <div id="sublists-list" class="space-y-2">
              {% if sublists %}
                {% for sublist in sublists %}
                  <div class="flex items-center gap-2 p-2 bg-slate-700/50 rounded">
                    <a href="/html_tailwind/list?id={{ sublist.id }}" 
                       class="text-blue-400 hover:text-blue-300 font-medium flex-1 truncate">
                      {{ sublist.name }}
                    </a>
                    <span class="text-slate-400 text-xs">
                      {{ sublist.override_priority or sublist.priority or '' }}
                    </span>
                  </div>
                {% endfor %}
              {% else %}
                <!-- Sublists will be populated here by JavaScript -->
                <div class="text-slate-400 text-sm italic">No sublists yet. Create your first sublist above.</div>
              {% endif %}
            </div>
          </div>

          <!-- Todo list container -->
          <div id="todo-list-container" class="mt-6">
            <!-- Full control view (default) -->
            <div id="todo-list-full" class="todo-view">
              <table class="w-full table-auto border-collapse">
                <thead id="todo-list-full-head">
                  <tr class="border-b border-slate-700">
                    <th class="w-12 p-2 text-center text-slate-400 text-sm font-medium"></th>
                    <th class="w-12 p-2 text-center text-slate-400 text-sm font-medium"></th>
                    <th class="w-12 p-2 text-center text-slate-400 text-sm font-medium"></th>
                    <th class="p-2 text-left text-slate-400 text-sm font-medium">Todo</th>
                  </tr>
                </thead>
                <tbody id="todo-list-full-body">
                  <!-- Todos will be populated here by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Read-only view -->
            <div id="todo-list-compact" class="todo-view hidden">
              <table class="w-full table-auto border-collapse">
                <thead>
                  <tr class="border-b border-slate-700">
                    <th class="w-12 p-2 text-center text-slate-400 text-sm font-medium"></th>
                    <th class="p-2 text-left text-slate-400 text-sm font-medium">Todo & Notes</th>
                  </tr>
                </thead>
                <tbody id="todo-list-compact-body">
                  <!-- Todos will be populated here by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- View toggle control -->
          <div class="mt-4 flex justify-center gap-3">
            <button id="toggle-view-btn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-slate-400">
              Hide Icons
            </button>
            <button id="toggle-sort-btn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-slate-400">
              Sort: Newest First
            </button>
          </div>

          <!-- Completion Types Management -->
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-slate-200 mb-2">Completion Types</h3>
            
            <!-- Current completion types -->
            <div id="completion-types-list" class="flex flex-wrap gap-2 items-center mb-3" aria-live="polite">
              <!-- Completion types will be populated here by JavaScript -->
            </div>

            <!-- Add completion type controls -->
            <div class="flex items-center gap-2">
              <input id="add-completion-type-input" class="px-2 py-1 rounded bg-slate-800 text-slate-100 text-sm" placeholder="Add completion type" />
              <button id="add-completion-type-btn" class="px-2 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">Add</button>
            </div>
          </div>

          <!-- List Category Selection -->
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-slate-200 mb-2">Category</h3>
            <div class="flex items-center gap-2">
              <select id="list-category-select" data-list-id="{{ list.id if list is defined else '' }}" data-category-id="{{ list.category_id if list is defined and list.category_id else '' }}" class="px-2 py-1 rounded bg-slate-800 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                <option value="">No Category</option>
                <!-- Categories will be populated here by JavaScript -->
              </select>
              <button id="save-category-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">Save</button>
            </div>
          </div>

          <!-- List Actions -->
          <div class="mt-4">
            <h3 class="text-lg font-semibold text-slate-200 mb-2">List Actions</h3>
            <div class="flex items-center gap-2">
              <button id="delete-list-btn" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-400">
                Delete List
              </button>
            </div>
          </div>

      <!-- list content placeholder -->



    </div>
  </main>

  </div>

  <script>
    // Pass server state to JavaScript
    window.listState = {
      listsUpTop: {{ list.lists_up_top | default(false) | tojson | safe }},
      listId: {{ list.id | default('null') | tojson | safe }},
      pinned: {{ list.pinned | default(false) | tojson | safe }}
    };
    // Debug: log the rendered value
    console.log('Template rendered lists_up_top:', window.listState.listsUpTop);
  </script>
  <script src="/static/html_tailwind/tailwind_list.js"></script>
{% endblock %}
