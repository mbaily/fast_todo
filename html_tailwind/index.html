<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title | default('Fast Todo - Tailwind') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="dark bg-black text-slate-100 min-h-screen">
    <div class="mx-auto py-1 px-1">
      <header class="mb-1">
      </header>
      <style>
        /* rotate the chevron icon when details is open */
        details[open] summary svg { transform: rotate(180deg); }
  /* priority glyph sizing and inline spacing (match html_no_js look) */
  .priority-inline { display:inline-block; margin-left:0.35rem; vertical-align:middle; }
  .priority-circle { font-size:2rem; line-height:1; }
  .priority-override .priority-circle { color:#ffb86b; }
  /* tag-chip styles copied from html_no_js/base.html (dark mode friendly) */
  .tag-chip { display:inline-flex; align-items:center; gap:0.35rem; background: rgba(30,64,175,0.4); border: 1px solid rgba(96,165,250,0.7); padding: 0.2rem 0.6rem; border-radius: 999px; color: #fff; text-decoration: none; margin: 0.12rem 0.35rem 0.12rem 0; transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease, color 120ms ease, border-color 120ms ease; cursor: pointer; }
  .tag-chip:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.5); background: rgba(37,99,235,0.55); border-color: rgba(147,197,253,0.9); color: #fff; }
  .tag-chip:focus { outline: none; }
  .tag-chip:focus-visible { box-shadow: 0 0 0 3px rgba(88,166,255,0.45); }
  .tag-chip .label { font-weight: 600; font-size: 0.9rem; }
  /* list-title anchors use Tailwind utilities (keep styling consistent with rest of UI) */
      </style>

      <!-- include navbar -->
      {% include 'navbar.html' %}

      <!-- client search + create-list area (placed below navbar). Search on first line, create on second line -->
      <div class="mt-1 mb-1 flex flex-col gap-1">
        <div class="relative">
          <input id="tw-search-input" type="search" placeholder="Search lists & todos" class="w-80 px-1 py-1 rounded-md border border-slate-700 bg-slate-800 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-slate-600" />
        </div>
        <div class="flex items-center gap-1">
          <input id="tw-newlist-name" type="text" placeholder="New list name" class="px-1 py-1 rounded-md border border-slate-700 bg-slate-800 text-sm text-slate-100" />
          <button id="tw-create-list" class="px-1 py-1 bg-sky-600 hover:bg-sky-700 text-white rounded-md text-sm">Create</button>
        </div>
      <!-- server-rendered content: pinned, calendar, lists grouped by category -->
      <main class="mt-1">

        {% if pinned_todos and pinned_todos|length > 0 %}
        <section class="pinned-todos mb-1">
          <h3 class="text-sm font-semibold mb-1">Pinned</h3>
          <ul class="space-y-1">
            {# sort pinned_todos by modified_at (newest first) #}
            {% for t in (pinned_todos | sort(attribute='modified_at') | reverse) %}
            <li class="flex items-start gap-1 bg-slate-800 rounded p-1">
              <div class="mt-0.5 text-sky-400">ðŸ“Œ</div>
              <div class="flex-1">
                <a class="font-medium text-slate-100 hover:underline" href="/html_no_js/todos/{{ t.id }}">{{ t.text }}</a>
                <div class="text-xs text-slate-400">in <a class="text-sky-300 hover:underline" href="/html_no_js/lists/{{ t.list_id }}">{{ t.list_name or t.list_id }}</a></div>
                {% if t.tags and t.tags|length > 0 %}
                <div class="mt-1 flex flex-wrap gap-1">
                  {% for tag in (t.tags | sort) %}
                  <a href="/html_no_js/search?q={{ tag|urlencode }}" class="tag-chip">{{ tag }}</a>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <div class="text-xs text-slate-400">{% if t.priority %}P:{{ t.priority }}{% endif %}</div>
                          </li>
                        </ul>
        </section>
        {% endif %}
        
        {% if calendar_occurrences and calendar_occurrences|length > 0 %}
        <section class="calendar-summary mb-1">
          <h3 class="text-sm font-semibold mb-1">Calendar</h3>
          <ul class="space-y-1">
            {% for ev in calendar_occurrences %}
            <li class="flex items-center gap-1 bg-slate-800 rounded p-1">
              <div class="text-xs text-slate-300 font-medium">{{ ev.occurrence_date or ev.occurrence_dt[:10] }}</div>
              <div class="flex-1 text-slate-100"><a class="hover:underline" href="{% if ev.item_type == 'todo' %}/html_no_js/todos/{{ ev.id }}{% else %}/html_no_js/lists/{{ ev.id }}{% endif %}">{{ ev.title or (ev.rrule or '')[:80] }}</a>{% if ev.is_recurring %} <span class="text-xs text-slate-400">(recurring)</span>{% endif %}</div>
            </li>
            {% endfor %}
          </ul>
        </section>
        {% endif %}

        {# pagination controls (cursor-based) #}
        {% if cursors %}
        <nav class="mb-1 flex gap-1" aria-label="Pages">
          <script>
          // Persist <details> open/closed per-category and handle combined tags fetch
          (function(){
            function setLocal(name, value){ try{ localStorage.setItem(name, JSON.stringify(value)); }catch(e){} }
            function getLocal(name, def){ try{ var v = localStorage.getItem(name); return v ? JSON.parse(v) : def; }catch(e){ return def; } }

            // restore details open state
            document.querySelectorAll('.category-section').forEach(function(sec){
              try{
                var cat = sec.getAttribute('data-category-id') || 'cat';
                var key = 'tw_cat_open_' + String(cat);
                var det = sec.querySelector('details');
                if (!det) return;
                var saved = getLocal(key, det.hasAttribute('open'));
                if (saved) det.setAttribute('open',''); else det.removeAttribute('open');
                det.addEventListener('toggle', function(){ setLocal(key, !!det.open); });
              }catch(e){}
            });

            // show-all-tags global checkbox persistence and combined-tags fetch
            var globalShow = getLocal('tw_show_all_tags', false);
            var globalBox = document.getElementById('show-all-tags-checkbox');
            if (globalBox){
              globalBox.checked = !!globalShow;
              globalBox.addEventListener('change', async function(){
                try{
                  setLocal('tw_show_all_tags', !!globalBox.checked);
                  const containers = Array.from(document.querySelectorAll('.combined-tags[data-list-id]'));
                  if (!containers || containers.length === 0) return;
                  if (globalBox.checked){
                    // fetch for all lists in parallel
                    containers.forEach(function(c){ c.textContent = 'Loading...'; });
                    await Promise.all(containers.map(async function(c){
                      try{
                        const lid = c.getAttribute('data-list-id');
                        const url = '/lists/' + encodeURIComponent(lid) + '/hashtags?include_todo_tags=1&combine=1';
                        const res = await fetch(url, { credentials: 'same-origin' });
                        if (!res.ok) { c.innerHTML = ''; return; }
                        const j = await res.json();
                        const tags = j && j.hashtags ? j.hashtags : null;
                        c.innerHTML = '';
                        if (tags && tags.length){
                          // collect existing tags already rendered server-side for this list to avoid duplicates
                          var existing = new Set();
                          try{
                            var parentLi = c.closest && c.closest('li');
                            if (parentLi){ parentLi.querySelectorAll('.tag-chip').forEach(function(el){ if (el && el.textContent) existing.add(String(el.textContent).trim()); }); }
                          }catch(e){}
                          // append unique tags only
                          tags.forEach(function(t){ try{ var txt = String(t).trim(); if (!txt) return; if (existing.has(txt)) return; existing.add(txt); var a = document.createElement('a'); a.href = '/html_no_js/search?q=' + encodeURIComponent(txt); a.className = 'tag-chip'; a.textContent = txt; c.appendChild(a); }catch(e){} });
                        }
                      }catch(e){ c.innerHTML = ''; }
                    }));
                  } else {
                    containers.forEach(function(c){ c.innerHTML = ''; });
                  }
                }catch(e){ /* noop */ }
              });
              // initialize from saved state: trigger change to load tags if needed
              if (globalBox.checked){ globalBox.dispatchEvent(new Event('change')); }
            }
          })();
          </script>
                          {% set un = (lst.uncompleted_count if (lst.uncompleted_count is defined) else (lst.uncompleted if (lst.uncompleted is defined) else None)) %}
                          <a class="list-title font-medium {% if lst.completed %}text-slate-400{% else %}text-blue-600{% endif %} hover:underline{% if lst.completed %} line-through done{% endif %}" href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>{% if un is not none and not (lst.hide_icons|default(false)) and (un|int) > 0 %}<span class="text-red-400 ml-1">{{ un }}</span>{% endif %}
                          {% set circ = {1:'â‘ ',2:'â‘¡',3:'â‘¢',4:'â‘£',5:'â‘¤',6:'â‘¥',7:'â‘¦',8:'â‘§',9:'â‘¨',10:'â‘©'} %}
                          {% if lst.priority is not none %}
                            <span class="muted priority-inline"><span class="priority-circle text-slate-300">{{ circ.get(lst.priority, lst.priority) }}</span></span>
                          {% endif %}
                            {% if lst.override_priority and (lst.priority is none or lst.override_priority > lst.priority) %}
                              <span class="muted priority-inline priority-override"><span class="priority-circle text-amber-300">{{ circ.get(lst.override_priority, lst.override_priority) }}</span></span>
                            {% endif %}
                          <span class="text-xs text-slate-400 list-date ml-1">{% if lst.modified_at %}mod. {{ lst.modified_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}{% elif lst.created_at %}cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}{% endif %}</span>
                          {% if lst.hashtags and lst.hashtags|length > 0 %}
                            <div class="inline-block ml-1">
                              {% for tag in (lst.hashtags | sort) %}
                                <a href="/html_no_js/search?q={{ tag|urlencode }}" class="tag-chip">{{ tag }}</a>
                              {% endfor %}
                            </div>
                          {% endif %}
                          <div class="combined-tags mt-0 inline-block ml-1" data-list-id="{{ lst.id }}" aria-live="polite"></div>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </details>
            </div>
            {% endif %}
        </section>

        <!-- embed server-provided categories as JSON for client-side enhancements -->
        <script type="application/json" id="server-categories">{{ categories | default([]) | tojson | safe }}</script>
  {# Render each category section in category.position order #}
  {% for cat in categories %}
  {% set cat_lists = lists_by_category.get(cat.id, []) %}
    {% if cat_lists and cat_lists|length > 0 %}
      <li class="category-section" data-category-id="{{ cat.id }}">
        <h3 class="category-header" data-target="cat-{{ cat.id }}" style="cursor:pointer; user-select:none;">
          <span class="twisty" aria-hidden="true">â–¾</span>
          <span class="category-name">{{ cat.name }}</span>
          <span class="count muted"> ({{ cat_lists|length }})</span>
        </h3>
        <ul id="cat-{{ cat.id }}" class="category-lists">
          {% for lst in cat_lists %}
            {% set created_iso = lst.created_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') %}
            {% set modified_iso = lst.modified_at|in_tz(client_tz, '%Y-%m-%dT%H:%M:%S') if lst.modified_at else None %}
            {# effective priority: use override_priority when present and higher than list.priority #}
            {% set eff = lst.override_priority if (lst.override_priority is not none and (lst.priority is none or lst.override_priority > lst.priority)) else lst.priority %}
            <li class="list-item"{% if created_iso %} data-created-at="{{ created_iso }}"{% endif %}{% if modified_iso %} data-modified-at="{{ modified_iso }}"{% endif %} data-priority="{{ eff if eff is not none else '' }}">
              <div class="list-main">
                <a class="list-title {% if lst.completed %}done{% endif %}" href="/html_no_js/lists/{{ lst.id }}">{{ lst.name }}</a>
                {% set circ = {0:'â“ª',1:'â‘ ',2:'â‘¡',3:'â‘¢',4:'â‘£',5:'â‘¤',6:'â‘¥',7:'â‘¦',8:'â‘§',9:'â‘¨',10:'â‘©'} %}
                {% if lst.priority %}
                  <span class="meta priority-inline"><span class="priority-circle">{{ circ.get(lst.priority, lst.priority) }}</span></span>
                {% endif %}
                {% if lst.override_priority and (lst.priority is none or lst.override_priority > lst.priority) %}
                  <span class="meta priority-inline priority-override" title="Highest uncompleted todo priority"><span class="priority-circle">{{ circ.get(lst.override_priority, lst.override_priority) }}</span></span>
                {% endif %}
                {% if lst.uncompleted_count is not none and not (lst.hide_icons|default(false)) %}
                  <span class="count-circle colour" aria-hidden="false" title="{{ circ.get(lst.uncompleted_count, lst.uncompleted_count) }} uncompleted todos">{{ lst.uncompleted_count }}</span>
                {% endif %}
                {% if lst.created_at %}
                  <div class="meta">cr. {{ lst.created_at|in_tz(client_tz, '%d/%m %-I:%M%p') }}</div>
                {% endif %}
                <div class="all-tags-inline" data-list-id="{{ lst.id }}" data-list-tags='{{ lst.hashtags | tojson }}' aria-hidden="true"></div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </li>
    {% endif %}
  {% endfor %}
        <script>
          (function(){
            try{ var el = document.getElementById('server-categories'); var txt = el ? (el.textContent || el.innerText || '').trim() : '[]'; window.categories = txt ? JSON.parse(txt) : []; } catch(e) { window.categories = []; }
          })();
        </script>

        <!-- controls: pill-group compact styling -->
        <div class="mt-1">
          <div class="flex items-center gap-2">
            <label class="inline-flex items-center gap-2 px-2 py-1 bg-black-800 border border-slate-700 rounded-md text-sm">
              <input type="checkbox" id="hide-completed-checkbox" class="mr-1"> Hide Completed
            </label>
            <div class="inline-flex items-center gap-2 px-2 py-1 bg-black-800 border border-slate-700 rounded-md text-sm">
              <span class="text-sm">Sort lists:</span>
              <select id="list-sort-order" class="ml-1 bg-transparent text-sm text-slate-100 border-none focus:outline-none">
                <option value="created">by creation date</option>
                <option value="modified">by modification date</option>
              </select>
            </div>
            <label class="inline-flex items-center gap-2 px-2 py-1 bg-black-800 border border-slate-700 rounded-md text-sm">
              <input type="checkbox" id="show-all-tags-checkbox" class="mr-1"> Show all tags
            </label>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
